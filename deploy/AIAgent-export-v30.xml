<?xml version="1.0" encoding="UTF-8"?>
<Export generator="IRIS" version="26" exportversion="30">

<Class name="AIAgent.Util.JSON">
<Description>JSON utility methods for the AI Agent Platform.
Provides helpers for building standard API responses.

Part of the IRIS AI Agent Platform (IRIS Copilot).
Deployable as standalone package to any IRIS HealthConnect instance.</Description>
<Abstract>1</Abstract>
<Method name="SuccessResponse">
<Description>Build a standard success response envelope.
Returns: {&quot;status&quot;:&quot;ok&quot;,&quot;data&quot;:&lt;data&gt;,&quot;meta&quot;:&lt;meta&gt;}</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>data:%DynamicAbstractObject=&quot;&quot;,meta:%DynamicObject=&quot;&quot;</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set response = ##class(%DynamicObject).%New()
    set response.status = "ok"
    if $isobject(data) {
        set response.data = data
    } else {
        set response.data = ""
    }
    if $isobject(meta) {
        set response.meta = meta
    }
    return response
]]></Implementation>
</Method>

<Method name="ErrorResponse">
<Description>Build a standard error response envelope.
Returns: {&quot;status&quot;:&quot;error&quot;,&quot;error&quot;:{&quot;code&quot;:&lt;code&gt;,&quot;message&quot;:&lt;message&gt;}}</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>code:%String,message:%String,httpStatus:%Integer=500</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set %response.Status = httpStatus_" "_$case(httpStatus,
        400:"Bad Request",
        401:"Unauthorized",
        403:"Forbidden",
        404:"Not Found",
        409:"Conflict",
        422:"Unprocessable Entity",
        429:"Too Many Requests",
        :"Error")
    set response = ##class(%DynamicObject).%New()
    set response.status = "error"
    set errObj = ##class(%DynamicObject).%New()
    set errObj.code = code
    set errObj.message = message
    set response.error = errObj
    return response
]]></Implementation>
</Method>

<Method name="PaginatedResponse">
<Description>Build a paginated response envelope.
Returns: {&quot;status&quot;:&quot;ok&quot;,&quot;data&quot;:&lt;array&gt;,&quot;meta&quot;:{&quot;total&quot;:&lt;n&gt;,&quot;page&quot;:&lt;p&gt;,&quot;pageSize&quot;:&lt;s&gt;,&quot;pages&quot;:&lt;t&gt;}}</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>data:%DynamicArray,total:%Integer,page:%Integer,pageSize:%Integer</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set meta = ##class(%DynamicObject).%New()
    set meta.total = total
    set meta.page = page
    set meta.pageSize = pageSize
    set meta.pages = $select(pageSize>0:$zabs(total\pageSize)+$select(total#pageSize>0:1,1:0),1:0)
    return ..SuccessResponse(data, meta)
]]></Implementation>
</Method>

<Method name="StatusToError">
<Description>Convert a %Status to a JSON error response.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sc:%Status,httpStatus:%Integer=500</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set msg = $system.Status.GetOneErrorText(sc)
    return ..ErrorResponse("IRIS_ERROR", msg, httpStatus)
]]></Implementation>
</Method>

<Method name="FormatDate">
<Description>Format an IRIS internal date ($horolog day count) to ISO 8601 date string.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>internalDate:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    quit:internalDate="" ""
    quit $zdate(internalDate, 3)
]]></Implementation>
</Method>

<Method name="FormatTimestamp">
<Description>Format an IRIS timestamp to ISO 8601.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ts:%TimeStamp</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    quit:ts="" ""
    quit $translate(ts, " ", "T")_"Z"
]]></Implementation>
</Method>

<Method name="WriteJSON">
<Description>Write a %DynamicObject or %DynamicArray to the current response as JSON.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>obj:%DynamicAbstractObject</FormalSpec>
<Implementation><![CDATA[
    set %response.ContentType = "application/json"
    set %response.CharSet = "utf-8"
    do obj.%ToJSON()
]]></Implementation>
</Method>

<Method name="ReadRequestJSON">
<Description>Parse the request body as JSON and return a %DynamicObject.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set body = ""
    while '%request.Content.AtEnd {
        set body = body _ %request.Content.Read()
    }
    quit:body="" ""
    return ##class(%DynamicObject).%FromJSON(body)
]]></Implementation>
</Method>

<Method name="GetParam">
<Description>Get a query parameter with a default value.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name:%String,default:%String=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set val = %request.Get(name)
    quit:val="" default
    quit val
]]></Implementation>
</Method>

<Method name="GetIntParam">
<Description>Get a query parameter as integer with a default value.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name:%String,default:%Integer=0</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
    set val = %request.Get(name)
    quit:val="" default
    quit:val'?1.N default
    quit +val
]]></Implementation>
</Method>

<Method name="GenerateId">
<Description>Generate a UUID-style unique identifier.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    quit $translate($system.Util.CreateGUID(), "{}-", "")
]]></Implementation>
</Method>

<Method name="Now">
<Description>Get current UTC timestamp in ISO 8601 format.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    quit $zdatetime($ztimestamp, 3, 1)
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Util.Logger">
<Description>Structured logging utility for the AI Agent Platform.
Writes to the IRIS application log and optionally to a global for in-app querying.

Usage:
do ##class(AIAgent.Util.Logger).Info(&quot;CodeManager&quot;, &quot;Class compiled&quot;, className)
do ##class(AIAgent.Util.Logger).Error(&quot;BridgeClient&quot;, &quot;Connection failed&quot;, errMsg)

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Abstract>1</Abstract>
<Parameter name="LOGGLOBAL">
<Description>Log global — stores structured log entries for in-app querying.
^AIAgent.Log(seqId) = $lb(timestamp, level, component, message, detail)</Description>
<Default>^AIAgent.Log</Default>
</Parameter>

<Parameter name="MAXENTRIES">
<Description>Maximum entries to keep in the log global (FIFO).</Description>
<Default>10000</Default>
</Parameter>

<Method name="Info">
<Description>Log an INFO-level message.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>component:%String,message:%String,detail:%String=&quot;&quot;</FormalSpec>
<Implementation><![CDATA[
    do ..Write("INFO", component, message, detail)
]]></Implementation>
</Method>

<Method name="Warn">
<Description>Log a WARN-level message.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>component:%String,message:%String,detail:%String=&quot;&quot;</FormalSpec>
<Implementation><![CDATA[
    do ..Write("WARN", component, message, detail)
]]></Implementation>
</Method>

<Method name="Error">
<Description>Log an ERROR-level message.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>component:%String,message:%String,detail:%String=&quot;&quot;</FormalSpec>
<Implementation><![CDATA[
    do ..Write("ERROR", component, message, detail)
]]></Implementation>
</Method>

<Method name="Debug">
<Description>Log a DEBUG-level message.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>component:%String,message:%String,detail:%String=&quot;&quot;</FormalSpec>
<Implementation><![CDATA[
    do ..Write("DEBUG", component, message, detail)
]]></Implementation>
</Method>

<Method name="Write">
<Description>Internal: write a structured log entry.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>level:%String,component:%String,message:%String,detail:%String=&quot;&quot;</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
    set ts = $zdatetime($ztimestamp, 3, 1)
    // Increment the log sequence counter
    set seq = $increment(@..#LOGGLOBAL)
    // Store the entry
    set @..#LOGGLOBAL@(seq) = $listbuild(ts, level, component, message, detail)
    // Purge old entries if over limit
    if seq > ..#MAXENTRIES {
        set oldest = seq - ..#MAXENTRIES
        for i = 1:1:oldest {
            kill:$data(@..#LOGGLOBAL@(i)) @..#LOGGLOBAL@(i)
        }
    }
]]></Implementation>
</Method>

<Method name="GetRecent">
<Description>Retrieve recent log entries as a %DynamicArray.
Returns the last &lt;count&gt; entries, newest first.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>count:%Integer=50</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set seq = $get(@..#LOGGLOBAL, 0)
    set start = $select(seq-count+1>0:seq-count+1, 1:1)
    // Iterate newest first
    for i = seq:-1:start {
        if $data(@..#LOGGLOBAL@(i)) {
            set entry = @..#LOGGLOBAL@(i)
            set obj = ##class(%DynamicObject).%New()
            set obj.id = i
            set obj.timestamp = $listget(entry, 1)
            set obj.level = $listget(entry, 2)
            set obj.component = $listget(entry, 3)
            set obj.message = $listget(entry, 4)
            set obj.detail = $listget(entry, 5)
            do arr.%Push(obj)
        }
    }
    return arr
]]></Implementation>
</Method>

<Method name="Clear">
<Description>Clear all log entries.</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
    kill @..#LOGGLOBAL
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Model.Conversation">
<Description>Persistent model: A chat conversation between a user and the AI Agent Platform.
Each conversation contains a sequence of messages (see AIAgent.Model.Message).

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%Persistent</Super>
<Property name="ConversationId">
<Description>Unique conversation identifier (UUID).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
<Required>1</Required>
</Property>

<Property name="Title">
<Description>Auto-generated title summarizing the conversation's first message.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="500"/>
</Property>

<Property name="Language">
<Description>Detected language of the user's input (ISO 639-1: &quot;en&quot;, &quot;es&quot;, &quot;zh&quot;, etc.).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="10"/>
<InitialExpression>&quot;en&quot;</InitialExpression>
</Property>

<Property name="Status">
<Description>Current status: active, archived.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="20"/>
<InitialExpression>&quot;active&quot;</InitialExpression>
</Property>

<Property name="CreatedBy">
<Description>The IRIS username who started this conversation.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
</Property>

<Property name="CreatedAt">
<Description>Timestamp when conversation was created.</Description>
<Type>%TimeStamp</Type>
<InitialExpression>$zdatetime($ztimestamp, 3, 1)</InitialExpression>
</Property>

<Property name="UpdatedAt">
<Description>Timestamp of last activity.</Description>
<Type>%TimeStamp</Type>
<InitialExpression>$zdatetime($ztimestamp, 3, 1)</InitialExpression>
</Property>

<Property name="TargetNamespace">
<Description>Target namespace this conversation operates on (for cross-namespace management).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
</Property>

<Index name="ConversationIdIdx">
<Properties>ConversationId</Properties>
<Unique>1</Unique>
</Index>

<Index name="StatusIdx">
<Properties>Status</Properties>
</Index>

<Index name="CreatedAtIdx">
<Properties>CreatedAt</Properties>
</Index>

<Method name="Create">
<Description>Create a new conversation. Returns the Conversation object.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>title:%String=&quot;&quot;,targetNamespace:%String=&quot;&quot;,createdBy:%String=&quot;&quot;</FormalSpec>
<ReturnType>AIAgent.Model.Conversation</ReturnType>
<Implementation><![CDATA[
    set conv = ##class(AIAgent.Model.Conversation).%New()
    set conv.ConversationId = ##class(AIAgent.Util.JSON).GenerateId()
    set conv.Title = title
    set conv.TargetNamespace = $select(targetNamespace'="":targetNamespace, 1:$namespace)
    set conv.CreatedBy = $select(createdBy'="":createdBy, 1:$username)
    set sc = conv.%Save()
    if $$$ISERR(sc) {
        do ##class(AIAgent.Util.Logger).Error("Conversation", "Failed to create conversation", $system.Status.GetOneErrorText(sc))
        return ""
    }
    do ##class(AIAgent.Util.Logger).Info("Conversation", "Created conversation", conv.ConversationId)
    return conv
]]></Implementation>
</Method>

<Method name="FindById">
<Description>Find a conversation by its UUID.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>conversationId:%String</FormalSpec>
<ReturnType>AIAgent.Model.Conversation</ReturnType>
<Implementation><![CDATA[
    set sql = "SELECT ID FROM AIAgent_Model.Conversation WHERE ConversationId = ?"
    set stmt = ##class(%SQL.Statement).%New()
    set sc = stmt.%Prepare(sql)
    quit:$$$ISERR(sc) ""
    set rs = stmt.%Execute(conversationId)
    if rs.%Next() {
        return ##class(AIAgent.Model.Conversation).%OpenId(rs.%GetData(1))
    }
    return ""
]]></Implementation>
</Method>

<Method name="List">
<Description>List conversations with pagination. Returns a %DynamicObject with data + meta.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>page:%Integer=1,pageSize:%Integer=20,status:%String=&quot;&quot;</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    // Count total
    set countSql = "SELECT COUNT(*) FROM AIAgent_Model.Conversation"
    if status '= "" { set countSql = countSql _ " WHERE ""Status"" = ?" }
    set stmt = ##class(%SQL.Statement).%New()
    set sc = stmt.%Prepare(countSql)
    if $$$ISERR(sc) {
        do ##class(AIAgent.Util.Logger).Error("Conversation", "List count prepare failed", $system.Status.GetOneErrorText(sc))
        return ##class(AIAgent.Util.JSON).PaginatedResponse(##class(%DynamicArray).%New(), 0, page, pageSize)
    }
    set rs = $select(status'="":stmt.%Execute(status), 1:stmt.%Execute())
    do rs.%Next()
    set total = rs.%GetData(1)

    // Fetch page IDs first, then open objects to avoid SQL keyword/property name issues
    set offset = (page - 1) * pageSize
    set dataSql = "SELECT %ID FROM AIAgent_Model.Conversation"
    if status '= "" { set dataSql = dataSql _ " WHERE ""Status"" = ?" }
    set dataSql = dataSql _ " ORDER BY UpdatedAt DESC"

    set stmt2 = ##class(%SQL.Statement).%New()
    set sc = stmt2.%Prepare(dataSql)
    if $$$ISERR(sc) {
        do ##class(AIAgent.Util.Logger).Error("Conversation", "List data prepare failed", $system.Status.GetOneErrorText(sc))
        return ##class(AIAgent.Util.JSON).PaginatedResponse(##class(%DynamicArray).%New(), total, page, pageSize)
    }
    set rs2 = $select(status'="":stmt2.%Execute(status), 1:stmt2.%Execute())

    set arr = ##class(%DynamicArray).%New()
    set skip = 0
    set count = 0
    while rs2.%Next() {
        set skip = skip + 1
        continue:(skip <= offset)
        quit:(count >= pageSize)
        set id = rs2.%GetData(1)
        set conv = ##class(AIAgent.Model.Conversation).%OpenId(id)
        if $isobject(conv) {
            do arr.%Push(conv.ToJSON())
            set count = count + 1
        }
    }

    return ##class(AIAgent.Util.JSON).PaginatedResponse(arr, total, page, pageSize)
]]></Implementation>
</Method>

<Method name="ToJSON">
<Description>Convert to JSON object.</Description>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set obj = ##class(%DynamicObject).%New()
    set obj.conversationId = ..ConversationId
    set obj.title = ..Title
    set obj.language = ..Language
    set obj.status = ..Status
    set obj.createdBy = ..CreatedBy
    set obj.createdAt = ..CreatedAt
    set obj.updatedAt = ..UpdatedAt
    set obj.targetNamespace = ..TargetNamespace
    return obj
]]></Implementation>
</Method>

<Method name="Touch">
<Description>Touch the UpdatedAt timestamp.</Description>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set ..UpdatedAt = $zdatetime($ztimestamp, 3, 1)
    return ..%Save()
]]></Implementation>
</Method>

<Storage name="Default">
<Data name="ConversationDefaultData">
<Subscript>"ConversationDefaultData"</Subscript>
<Value name="1">
<Value>ConversationId</Value>
</Value>
<Value name="2">
<Value>Title</Value>
</Value>
<Value name="3">
<Value>Language</Value>
</Value>
<Value name="4">
<Value>Status</Value>
</Value>
<Value name="5">
<Value>CreatedBy</Value>
</Value>
<Value name="6">
<Value>CreatedAt</Value>
</Value>
<Value name="7">
<Value>UpdatedAt</Value>
</Value>
<Value name="8">
<Value>TargetNamespace</Value>
</Value>
<Value name="9">
<Value>%%CLASSNAME</Value>
</Value>
</Data>
<DataLocation>^AIAgent.ConversationD</DataLocation>
<DefaultData>ConversationDefaultData</DefaultData>
<IdLocation>^AIAgent.ConversationD</IdLocation>
<IndexLocation>^AIAgent.ConversationI</IndexLocation>
<StreamLocation>^AIAgent.ConversationS</StreamLocation>
<Type>%Storage.Persistent</Type>
</Storage>

</Class>

<Class name="AIAgent.Model.Message">
<Description>Persistent model: An individual chat message within a conversation.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%Persistent</Super>
<Property name="ConversationId">
<Description>FK to AIAgent.Model.Conversation.ConversationId.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
<Required>1</Required>
</Property>

<Property name="MessageId">
<Description>Unique message identifier (UUID).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
<Required>1</Required>
</Property>

<Property name="Role">
<Description>Role: &quot;user&quot;, &quot;assistant&quot;, &quot;system&quot;.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="20"/>
<Required>1</Required>
</Property>

<Property name="Content">
<Description>Message content. Uses a stream to support large AI responses.</Description>
<Type>%Stream.GlobalCharacter</Type>
</Property>

<Property name="Timestamp">
<Description>Timestamp when message was created.</Description>
<Type>%TimeStamp</Type>
<InitialExpression>$zdatetime($ztimestamp, 3, 1)</InitialExpression>
</Property>

<Property name="TokenCount">
<Description>Token count (if available from AI runner).</Description>
<Type>%Integer</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="AgentName">
<Description>Which AI agent generated this message (orchestrator, architect, developer, etc.).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
</Property>

<Property name="RunnerUsed">
<Description>Which AI runner was used (claude-agent-sdk, openai-codex, etc.).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
</Property>

<Property name="GenerationId">
<Description>FK to AIAgent.Model.Generation.GenerationId if this message resulted in code generation.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
</Property>

<Index name="ConversationIdx">
<Properties>ConversationId</Properties>
</Index>

<Index name="MessageIdIdx">
<Properties>MessageId</Properties>
<Unique>1</Unique>
</Index>

<Index name="TimestampIdx">
<Properties>Timestamp</Properties>
</Index>

<Method name="Create">
<Description>Create a new message in a conversation.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>conversationId:%String,role:%String,content:%String,agentName:%String=&quot;&quot;,runnerUsed:%String=&quot;&quot;</FormalSpec>
<ReturnType>AIAgent.Model.Message</ReturnType>
<Implementation><![CDATA[
    set msg = ##class(AIAgent.Model.Message).%New()
    set msg.ConversationId = conversationId
    set msg.MessageId = ##class(AIAgent.Util.JSON).GenerateId()
    set msg.Role = role
    do msg.Content.Write(content)
    set msg.AgentName = agentName
    set msg.RunnerUsed = runnerUsed
    set sc = msg.%Save()
    if $$$ISERR(sc) {
        do ##class(AIAgent.Util.Logger).Error("Message", "Failed to save message", $system.Status.GetOneErrorText(sc))
        return ""
    }
    // Touch the parent conversation
    set conv = ##class(AIAgent.Model.Conversation).FindById(conversationId)
    if $isobject(conv) { do conv.Touch() }
    return msg
]]></Implementation>
</Method>

<Method name="GetByConversation">
<Description>Get all messages for a conversation, ordered by timestamp.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>conversationId:%String</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set sql = "SELECT ID FROM AIAgent_Model.Message WHERE ConversationId = ? ORDER BY Timestamp ASC"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(conversationId)
    while rs.%Next() {
        set msg = ##class(AIAgent.Model.Message).%OpenId(rs.%GetData(1))
        if $isobject(msg) {
            do arr.%Push(msg.ToJSON())
        }
    }
    return arr
]]></Implementation>
</Method>

<Method name="ToJSON">
<Description>Convert to JSON object.</Description>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set obj = ##class(%DynamicObject).%New()
    set obj.messageId = ..MessageId
    set obj.conversationId = ..ConversationId
    set obj.role = ..Role
    // Read content from stream
    do ..Content.Rewind()
    set obj.content = ..Content.Read(..Content.Size)
    set obj.timestamp = ..Timestamp
    set obj.tokenCount = ..TokenCount
    set obj.agentName = ..AgentName
    set obj.runnerUsed = ..RunnerUsed
    set obj.generationId = ..GenerationId
    return obj
]]></Implementation>
</Method>

<Storage name="Default">
<Data name="MessageDefaultData">
<Subscript>"MessageDefaultData"</Subscript>
<Value name="1">
<Value>ConversationId</Value>
</Value>
<Value name="2">
<Value>MessageId</Value>
</Value>
<Value name="3">
<Value>Role</Value>
</Value>
<Value name="4">
<Value>Content</Value>
</Value>
<Value name="5">
<Value>Timestamp</Value>
</Value>
<Value name="6">
<Value>TokenCount</Value>
</Value>
<Value name="7">
<Value>AgentName</Value>
</Value>
<Value name="8">
<Value>RunnerUsed</Value>
</Value>
<Value name="9">
<Value>GenerationId</Value>
</Value>
<Value name="10">
<Value>%%CLASSNAME</Value>
</Value>
</Data>
<DataLocation>^AIAgent.MessageD</DataLocation>
<DefaultData>MessageDefaultData</DefaultData>
<IdLocation>^AIAgent.MessageD</IdLocation>
<IndexLocation>^AIAgent.MessageI</IndexLocation>
<StreamLocation>^AIAgent.MessageS</StreamLocation>
<Type>%Storage.Persistent</Type>
</Storage>

</Class>

<Class name="AIAgent.Model.Generation">
<Description>Persistent model: A code generation batch produced by AI agents.
Contains one or more GenerationClass records representing the individual COS classes generated.

Status lifecycle: preview → approved → deployed → (rolled_back) | rejected

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%Persistent</Super>
<Property name="GenerationId">
<Description>Unique generation identifier (UUID).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
<Required>1</Required>
</Property>

<Property name="ConversationId">
<Description>FK to conversation that triggered this generation.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
<Required>1</Required>
</Property>

<Property name="MessageId">
<Description>FK to the assistant message that proposed this generation.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
</Property>

<Property name="Description">
<Description>Human-readable summary of what was generated.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="2000"/>
</Property>

<Property name="Status">
<Description>Status: preview, approved, deployed, rolled_back, rejected.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="20"/>
<InitialExpression>&quot;preview&quot;</InitialExpression>
</Property>

<Property name="ClassCount">
<Description>Number of classes in this generation.</Description>
<Type>%Integer</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="TargetNamespace">
<Description>The target namespace where classes will be/were deployed.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
</Property>

<Property name="RunnerUsed">
<Description>The AI runner used for code generation.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
</Property>

<Property name="CreatedAt">
<Type>%TimeStamp</Type>
<InitialExpression>$zdatetime($ztimestamp, 3, 1)</InitialExpression>
</Property>

<Property name="ApprovedAt">
<Type>%TimeStamp</Type>
</Property>

<Property name="DeployedAt">
<Type>%TimeStamp</Type>
</Property>

<Property name="ApprovedBy">
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
</Property>

<Property name="VersionId">
<Description>FK to the Version snapshot created before deployment.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
</Property>

<Index name="GenerationIdIdx">
<Properties>GenerationId</Properties>
<Unique>1</Unique>
</Index>

<Index name="ConversationIdx">
<Properties>ConversationId</Properties>
</Index>

<Index name="StatusIdx">
<Properties>Status</Properties>
</Index>

<Method name="Create">
<Description>Create a new generation record.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>conversationId:%String,description:%String,targetNamespace:%String=&quot;&quot;,runnerUsed:%String=&quot;&quot;</FormalSpec>
<ReturnType>AIAgent.Model.Generation</ReturnType>
<Implementation><![CDATA[
    set gen = ##class(AIAgent.Model.Generation).%New()
    set gen.GenerationId = ##class(AIAgent.Util.JSON).GenerateId()
    set gen.ConversationId = conversationId
    set gen.Description = description
    set gen.TargetNamespace = $select(targetNamespace'="":targetNamespace, 1:$namespace)
    set gen.RunnerUsed = runnerUsed
    set sc = gen.%Save()
    if $$$ISERR(sc) {
        do ##class(AIAgent.Util.Logger).Error("Generation", "Failed to create", $system.Status.GetOneErrorText(sc))
        return ""
    }
    do ##class(AIAgent.Util.Logger).Info("Generation", "Created generation", gen.GenerationId)
    return gen
]]></Implementation>
</Method>

<Method name="FindById">
<Description>Find by generation UUID.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>generationId:%String</FormalSpec>
<ReturnType>AIAgent.Model.Generation</ReturnType>
<Implementation><![CDATA[
    set sql = "SELECT ID FROM AIAgent_Model.Generation WHERE GenerationId = ?"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(generationId)
    if rs.%Next() {
        return ##class(AIAgent.Model.Generation).%OpenId(rs.%GetData(1))
    }
    return ""
]]></Implementation>
</Method>

<Method name="FindLatestByStatus">
<Description>Find the most recent generation by status (default: preview).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>status:%String=&quot;preview&quot;</FormalSpec>
<ReturnType>AIAgent.Model.Generation</ReturnType>
<Implementation><![CDATA[
    set sql = "SELECT TOP 1 ID FROM AIAgent_Model.Generation WHERE ""Status"" = ? ORDER BY CreatedAt DESC"
    set stmt = ##class(%SQL.Statement).%New()
    set sc = stmt.%Prepare(sql)
    if $$$ISERR(sc) return ""
    set rs = stmt.%Execute(status)
    if rs.%Next() {
        return ##class(AIAgent.Model.Generation).%OpenId(rs.%GetData(1))
    }
    return ""
]]></Implementation>
</Method>

<Method name="UpdateStatus">
<Description>Update status and save.</Description>
<FormalSpec>newStatus:%String,approvedBy:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set ..Status = newStatus
    if newStatus = "approved" {
        set ..ApprovedAt = $zdatetime($ztimestamp, 3, 1)
        set ..ApprovedBy = $select(approvedBy'="":approvedBy, 1:$username)
    }
    if newStatus = "deployed" {
        set ..DeployedAt = $zdatetime($ztimestamp, 3, 1)
    }
    set sc = ..%Save()
    do ##class(AIAgent.Util.Logger).Info("Generation", "Status → "_newStatus, ..GenerationId)
    return sc
]]></Implementation>
</Method>

<Method name="GetClasses">
<Description>Get all GenerationClass records for this generation.</Description>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    return ##class(AIAgent.Model.GenerationClass).GetByGeneration(..GenerationId)
]]></Implementation>
</Method>

<Method name="ToJSON">
<Description>Convert to JSON.</Description>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set obj = ##class(%DynamicObject).%New()
    set obj.generationId = ..GenerationId
    set obj.conversationId = ..ConversationId
    set obj.messageId = ..MessageId
    set obj.description = ..Description
    set obj.status = ..Status
    set obj.classCount = ..ClassCount
    set obj.targetNamespace = ..TargetNamespace
    set obj.runnerUsed = ..RunnerUsed
    set obj.createdAt = ..CreatedAt
    set obj.approvedAt = ..ApprovedAt
    set obj.deployedAt = ..DeployedAt
    set obj.approvedBy = ..ApprovedBy
    set obj.versionId = ..VersionId
    set obj.classes = ..GetClasses()
    return obj
]]></Implementation>
</Method>

<Storage name="Default">
<Data name="GenerationDefaultData">
<Subscript>"GenerationDefaultData"</Subscript>
<Value name="1">
<Value>GenerationId</Value>
</Value>
<Value name="2">
<Value>ConversationId</Value>
</Value>
<Value name="3">
<Value>MessageId</Value>
</Value>
<Value name="4">
<Value>Description</Value>
</Value>
<Value name="5">
<Value>Status</Value>
</Value>
<Value name="6">
<Value>ClassCount</Value>
</Value>
<Value name="7">
<Value>TargetNamespace</Value>
</Value>
<Value name="8">
<Value>RunnerUsed</Value>
</Value>
<Value name="9">
<Value>CreatedAt</Value>
</Value>
<Value name="10">
<Value>ApprovedAt</Value>
</Value>
<Value name="11">
<Value>DeployedAt</Value>
</Value>
<Value name="12">
<Value>ApprovedBy</Value>
</Value>
<Value name="13">
<Value>VersionId</Value>
</Value>
<Value name="14">
<Value>%%CLASSNAME</Value>
</Value>
</Data>
<DataLocation>^AIAgent.GenerationD</DataLocation>
<DefaultData>GenerationDefaultData</DefaultData>
<IdLocation>^AIAgent.GenerationD</IdLocation>
<IndexLocation>^AIAgent.GenerationI</IndexLocation>
<StreamLocation>^AIAgent.GenerationS</StreamLocation>
<Type>%Storage.Persistent</Type>
</Storage>

</Class>

<Class name="AIAgent.Model.GenerationClass">
<Description>Persistent model: An individual COS class within a code generation batch.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%Persistent</Super>
<Property name="GenerationId">
<Description>FK to AIAgent.Model.Generation.GenerationId.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
<Required>1</Required>
</Property>

<Property name="ClassName">
<Description>Fully qualified class name (e.g., &quot;AIAgent.Generated.Pharmacy.Process.DoseCheckProcess&quot;).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="500"/>
<Required>1</Required>
</Property>

<Property name="ClassType">
<Description>Component type: BusinessService, BusinessProcess, BusinessOperation, Message,
Transform, RoutingRule, LookupTable, Test, Other.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="50"/>
</Property>

<Property name="Source">
<Description>The generated ObjectScript source code.</Description>
<Type>%Stream.GlobalCharacter</Type>
</Property>

<Property name="PreviousSource">
<Description>The previous source of this class (if it existed before), for diff/rollback.</Description>
<Type>%Stream.GlobalCharacter</Type>
</Property>

<Property name="CompileStatus">
<Description>Compilation status: pending, success, error.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="20"/>
<InitialExpression>&quot;pending&quot;</InitialExpression>
</Property>

<Property name="CompileErrors">
<Description>Compilation error messages (if any).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="10000"/>
</Property>

<Property name="IsModification">
<Description>Whether this class existed before (true = modification, false = new class).</Description>
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Index name="GenerationIdx">
<Properties>GenerationId</Properties>
</Index>

<Index name="ClassNameIdx">
<Properties>ClassName</Properties>
</Index>

<Method name="Create">
<Description>Create a new generation class record.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>generationId:%String,className:%String,classType:%String,source:%String,previousSource:%String=&quot;&quot;</FormalSpec>
<ReturnType>AIAgent.Model.GenerationClass</ReturnType>
<Implementation><![CDATA[
    set gc = ##class(AIAgent.Model.GenerationClass).%New()
    set gc.GenerationId = generationId
    set gc.ClassName = className
    set gc.ClassType = classType
    do gc.Source.Write(source)
    if previousSource '= "" {
        do gc.PreviousSource.Write(previousSource)
        set gc.IsModification = 1
    }
    set sc = gc.%Save()
    if $$$ISERR(sc) {
        do ##class(AIAgent.Util.Logger).Error("GenerationClass", "Failed to save", className_": "_$system.Status.GetOneErrorText(sc))
        return ""
    }
    // Increment class count on parent generation
    set gen = ##class(AIAgent.Model.Generation).FindById(generationId)
    if $isobject(gen) {
        set gen.ClassCount = gen.ClassCount + 1
        do gen.%Save()
    }
    return gc
]]></Implementation>
</Method>

<Method name="GetByGeneration">
<Description>Get all classes for a generation.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>generationId:%String</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set sql = "SELECT ID FROM AIAgent_Model.GenerationClass WHERE GenerationId = ? ORDER BY ID"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(generationId)
    while rs.%Next() {
        set gc = ##class(AIAgent.Model.GenerationClass).%OpenId(rs.%GetData(1))
        if $isobject(gc) {
            do arr.%Push(gc.ToJSON())
        }
    }
    return arr
]]></Implementation>
</Method>

<Method name="SetCompileResult">
<Description>Update compilation status.</Description>
<FormalSpec>status:%String,errors:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set ..CompileStatus = status
    set ..CompileErrors = errors
    return ..%Save()
]]></Implementation>
</Method>

<Method name="GetSource">
<Description>Read source as string.</Description>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    do ..Source.Rewind()
    return ..Source.Read(..Source.Size)
]]></Implementation>
</Method>

<Method name="GetPreviousSource">
<Description>Read previous source as string.</Description>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    quit:..PreviousSource.Size=0 ""
    do ..PreviousSource.Rewind()
    return ..PreviousSource.Read(..PreviousSource.Size)
]]></Implementation>
</Method>

<Method name="ToJSON">
<Description>Convert to JSON.</Description>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set obj = ##class(%DynamicObject).%New()
    set obj.generationId = ..GenerationId
    set obj.className = ..ClassName
    set obj.classType = ..ClassType
    set obj.source = ..GetSource()
    set obj.compileStatus = ..CompileStatus
    set obj.compileErrors = ..CompileErrors
    set obj.isModification = ..IsModification
    return obj
]]></Implementation>
</Method>

<Storage name="Default">
<Data name="GenerationClassDefaultData">
<Subscript>"GenerationClassDefaultData"</Subscript>
<Value name="1">
<Value>GenerationId</Value>
</Value>
<Value name="2">
<Value>ClassName</Value>
</Value>
<Value name="3">
<Value>ClassType</Value>
</Value>
<Value name="4">
<Value>Source</Value>
</Value>
<Value name="5">
<Value>PreviousSource</Value>
</Value>
<Value name="6">
<Value>CompileStatus</Value>
</Value>
<Value name="7">
<Value>CompileErrors</Value>
</Value>
<Value name="8">
<Value>IsModification</Value>
</Value>
<Value name="9">
<Value>%%CLASSNAME</Value>
</Value>
</Data>
<DataLocation>^AIAgent.GenerationClassD</DataLocation>
<DefaultData>GenerationClassDefaultData</DefaultData>
<IdLocation>^AIAgent.GenerationClassD</IdLocation>
<IndexLocation>^AIAgent.GenerationClassI</IndexLocation>
<StreamLocation>^AIAgent.GenerationClassS</StreamLocation>
<Type>%Storage.Persistent</Type>
</Storage>

</Class>

<Class name="AIAgent.Model.Version">
<Description>Persistent model: A deployment version snapshot.
Created before each deployment so we can roll back.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%Persistent</Super>
<Property name="VersionId">
<Description>Unique version identifier (e.g., &quot;V-20260217-001&quot;).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
<Required>1</Required>
</Property>

<Property name="GenerationId">
<Description>FK to the generation that triggered this snapshot.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
</Property>

<Property name="Description">
<Description>Human-readable description of this version.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="2000"/>
</Property>

<Property name="Status">
<Description>Status: active, rolled_back, superseded.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="20"/>
<InitialExpression>&quot;active&quot;</InitialExpression>
</Property>

<Property name="ClassCount">
<Description>Number of classes in this snapshot.</Description>
<Type>%Integer</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="Snapshot">
<Description>JSON blob storing the full snapshot: [{className, source}].
Using a stream for potentially large snapshots.</Description>
<Type>%Stream.GlobalCharacter</Type>
</Property>

<Property name="ProductionSnapshot">
<Description>Production configuration snapshot (JSON of Ens.Config items).</Description>
<Type>%Stream.GlobalCharacter</Type>
</Property>

<Property name="Namespace">
<Description>The namespace this version belongs to.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
</Property>

<Property name="CreatedAt">
<Type>%TimeStamp</Type>
<InitialExpression>$zdatetime($ztimestamp, 3, 1)</InitialExpression>
</Property>

<Property name="CreatedBy">
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
</Property>

<Index name="VersionIdIdx">
<Properties>VersionId</Properties>
<Unique>1</Unique>
</Index>

<Index name="CreatedAtIdx">
<Properties>CreatedAt</Properties>
</Index>

<Method name="NextVersionId">
<Description>Generate the next version ID for today.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set dateStr = $zdate($horolog, 8)  // YYYYMMDD
    set prefix = "V-" _ dateStr _ "-"
    // Find the highest existing version for today
    set sql = "SELECT VersionId FROM AIAgent_Model.Version WHERE VersionId LIKE ? ORDER BY VersionId DESC"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(prefix _ "%")
    if rs.%Next() {
        set lastId = rs.%GetData(1)
        set lastSeq = +$piece(lastId, "-", 3)
        set seq = lastSeq + 1
    } else {
        set seq = 1
    }
    return prefix _ $translate($justify(seq, 3), " ", "0")
]]></Implementation>
</Method>

<Method name="Create">
<Description>Create a new version snapshot.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>generationId:%String,description:%String</FormalSpec>
<ReturnType>AIAgent.Model.Version</ReturnType>
<Implementation><![CDATA[
    set ver = ##class(AIAgent.Model.Version).%New()
    set ver.VersionId = ..NextVersionId()
    set ver.GenerationId = generationId
    set ver.Description = description
    set ver.Namespace = $namespace
    set ver.CreatedBy = $username
    set sc = ver.%Save()
    if $$$ISERR(sc) {
        do ##class(AIAgent.Util.Logger).Error("Version", "Failed to create", $system.Status.GetOneErrorText(sc))
        return ""
    }
    do ##class(AIAgent.Util.Logger).Info("Version", "Created version", ver.VersionId)
    return ver
]]></Implementation>
</Method>

<Method name="FindById">
<Description>Find by version ID.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>versionId:%String</FormalSpec>
<ReturnType>AIAgent.Model.Version</ReturnType>
<Implementation><![CDATA[
    set sql = "SELECT ID FROM AIAgent_Model.Version WHERE VersionId = ?"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(versionId)
    if rs.%Next() {
        return ##class(AIAgent.Model.Version).%OpenId(rs.%GetData(1))
    }
    return ""
]]></Implementation>
</Method>

<Method name="List">
<Description>List all versions, newest first.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>page:%Integer=1,pageSize:%Integer=20</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set sql = "SELECT VersionId, GenerationId, Description, Status, ClassCount, Namespace, CreatedAt, CreatedBy FROM AIAgent_Model.Version ORDER BY CreatedAt DESC"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute()
    set skip = 0
    set offset = (page - 1) * pageSize
    set count = 0
    while rs.%Next() {
        set skip = skip + 1
        continue:(skip <= offset)
        quit:(count >= pageSize)
        set obj = ##class(%DynamicObject).%New()
        set obj.versionId = rs.%GetData(1)
        set obj.generationId = rs.%GetData(2)
        set obj.description = rs.%GetData(3)
        set obj.status = rs.%GetData(4)
        set obj.classCount = rs.%GetData(5)
        set obj.namespace = rs.%GetData(6)
        set obj.createdAt = rs.%GetData(7)
        set obj.createdBy = rs.%GetData(8)
        do arr.%Push(obj)
        set count = count + 1
    }
    return arr
]]></Implementation>
</Method>

<Method name="ToJSON">
<Description>Convert to JSON.</Description>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set obj = ##class(%DynamicObject).%New()
    set obj.versionId = ..VersionId
    set obj.generationId = ..GenerationId
    set obj.description = ..Description
    set obj.status = ..Status
    set obj.classCount = ..ClassCount
    set obj.namespace = ..Namespace
    set obj.createdAt = ..CreatedAt
    set obj.createdBy = ..CreatedBy
    return obj
]]></Implementation>
</Method>

<Storage name="Default">
<Data name="VersionDefaultData">
<Subscript>"VersionDefaultData"</Subscript>
<Value name="1">
<Value>VersionId</Value>
</Value>
<Value name="2">
<Value>GenerationId</Value>
</Value>
<Value name="3">
<Value>Description</Value>
</Value>
<Value name="4">
<Value>Status</Value>
</Value>
<Value name="5">
<Value>ClassCount</Value>
</Value>
<Value name="6">
<Value>Snapshot</Value>
</Value>
<Value name="7">
<Value>ProductionSnapshot</Value>
</Value>
<Value name="8">
<Value>Namespace</Value>
</Value>
<Value name="9">
<Value>CreatedAt</Value>
</Value>
<Value name="10">
<Value>CreatedBy</Value>
</Value>
<Value name="11">
<Value>%%CLASSNAME</Value>
</Value>
</Data>
<DataLocation>^AIAgent.VersionD</DataLocation>
<DefaultData>VersionDefaultData</DefaultData>
<IdLocation>^AIAgent.VersionD</IdLocation>
<IndexLocation>^AIAgent.VersionI</IndexLocation>
<StreamLocation>^AIAgent.VersionS</StreamLocation>
<Type>%Storage.Persistent</Type>
</Storage>

</Class>

<Class name="AIAgent.Model.AuditEntry">
<Description>Persistent model: Audit trail entry for all AI Agent Platform actions.
Every significant action (generate, compile, deploy, rollback, delete, test) is logged.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%Persistent</Super>
<Property name="Timestamp">
<Description>Timestamp of the action.</Description>
<Type>%TimeStamp</Type>
<InitialExpression>$zdatetime($ztimestamp, 3, 1)</InitialExpression>
</Property>

<Property name="Action">
<Description>Action type: generate, compile, deploy, rollback, delete, start, stop, test,
approve, reject, configure, import, export.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="50"/>
<Required>1</Required>
</Property>

<Property name="Actor">
<Description>Who performed the action (IRIS username or agent name).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="200"/>
<Required>1</Required>
</Property>

<Property name="Target">
<Description>Target of the action (class name, production name, version ID, etc.).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="500"/>
</Property>

<Property name="Detail">
<Description>JSON blob with action-specific details.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="10000"/>
</Property>

<Property name="Status">
<Description>Result: success, failure.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="20"/>
<InitialExpression>&quot;success&quot;</InitialExpression>
</Property>

<Property name="ErrorDetail">
<Description>Error detail if status = failure.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="10000"/>
</Property>

<Property name="ConversationId">
<Description>FK to conversation (if action was triggered from a conversation).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
</Property>

<Property name="GenerationId">
<Description>FK to generation (if action relates to a generation).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="64"/>
</Property>

<Property name="Namespace">
<Description>The namespace where the action occurred.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="100"/>
<InitialExpression>$namespace</InitialExpression>
</Property>

<Index name="TimestampIdx">
<Properties>Timestamp</Properties>
</Index>

<Index name="ActionIdx">
<Properties>Action</Properties>
</Index>

<Index name="ActorIdx">
<Properties>Actor</Properties>
</Index>

<Method name="LogSuccess">
<Description>Log a successful action.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>action:%String,target:%String,detail:%String=&quot;&quot;,conversationId:%String=&quot;&quot;,generationId:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    return ..Log(action, target, "success", detail, "", conversationId, generationId)
]]></Implementation>
</Method>

<Method name="LogFailure">
<Description>Log a failed action.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>action:%String,target:%String,errorDetail:%String,detail:%String=&quot;&quot;,conversationId:%String=&quot;&quot;,generationId:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    return ..Log(action, target, "failure", detail, errorDetail, conversationId, generationId)
]]></Implementation>
</Method>

<Method name="Log">
<Description>Internal: create and save an audit entry.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>action:%String,target:%String,status:%String,detail:%String,errorDetail:%String,conversationId:%String,generationId:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set entry = ##class(AIAgent.Model.AuditEntry).%New()
    set entry.Action = action
    set entry.Actor = $username
    set entry.Target = target
    set entry.Status = status
    set entry.Detail = detail
    set entry.ErrorDetail = errorDetail
    set entry.ConversationId = conversationId
    set entry.GenerationId = generationId
    set sc = entry.%Save()
    // Also write to structured logger
    if status = "success" {
        do ##class(AIAgent.Util.Logger).Info("Audit", action_" → "_target, detail)
    } else {
        do ##class(AIAgent.Util.Logger).Error("Audit", action_" FAILED → "_target, errorDetail)
    }
    return sc
]]></Implementation>
</Method>

<Method name="Query">
<Description>Query recent audit entries with optional filters.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>action:%String=&quot;&quot;,actor:%String=&quot;&quot;,page:%Integer=1,pageSize:%Integer=50</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set sql = "SELECT ID, Timestamp, Action, Actor, Target, Detail, Status, ErrorDetail, ConversationId, GenerationId, Namespace FROM AIAgent_Model.AuditEntry WHERE 1=1"
    if action '= "" { set sql = sql _ " AND Action = ?" }
    if actor '= "" { set sql = sql _ " AND Actor = ?" }
    set sql = sql _ " ORDER BY Timestamp DESC"

    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)

    if (action '= "") && (actor '= "") {
        set rs = stmt.%Execute(action, actor)
    } elseif action '= "" {
        set rs = stmt.%Execute(action)
    } elseif actor '= "" {
        set rs = stmt.%Execute(actor)
    } else {
        set rs = stmt.%Execute()
    }

    set skip = 0
    set offset = (page - 1) * pageSize
    set count = 0
    while rs.%Next() {
        set skip = skip + 1
        continue:(skip <= offset)
        quit:(count >= pageSize)
        set obj = ##class(%DynamicObject).%New()
        set obj.id = rs.%GetData(1)
        set obj.timestamp = rs.%GetData(2)
        set obj.action = rs.%GetData(3)
        set obj.actor = rs.%GetData(4)
        set obj.target = rs.%GetData(5)
        set obj.detail = rs.%GetData(6)
        set obj.status = rs.%GetData(7)
        set obj.errorDetail = rs.%GetData(8)
        set obj.conversationId = rs.%GetData(9)
        set obj.generationId = rs.%GetData(10)
        set obj.namespace = rs.%GetData(11)
        do arr.%Push(obj)
        set count = count + 1
    }
    return arr
]]></Implementation>
</Method>

<Storage name="Default">
<Data name="AuditEntryDefaultData">
<Subscript>"AuditEntryDefaultData"</Subscript>
<Value name="1">
<Value>Timestamp</Value>
</Value>
<Value name="2">
<Value>Action</Value>
</Value>
<Value name="3">
<Value>Actor</Value>
</Value>
<Value name="4">
<Value>Target</Value>
</Value>
<Value name="5">
<Value>Detail</Value>
</Value>
<Value name="6">
<Value>Status</Value>
</Value>
<Value name="7">
<Value>ErrorDetail</Value>
</Value>
<Value name="8">
<Value>ConversationId</Value>
</Value>
<Value name="9">
<Value>GenerationId</Value>
</Value>
<Value name="10">
<Value>Namespace</Value>
</Value>
<Value name="11">
<Value>%%CLASSNAME</Value>
</Value>
</Data>
<DataLocation>^AIAgent.AuditEntryD</DataLocation>
<DefaultData>AuditEntryDefaultData</DefaultData>
<IdLocation>^AIAgent.AuditEntryD</IdLocation>
<IndexLocation>^AIAgent.AuditEntryI</IndexLocation>
<StreamLocation>^AIAgent.AuditEntryS</StreamLocation>
<Type>%Storage.Persistent</Type>
</Storage>

</Class>

<Class name="AIAgent.Engine.CodeManager">
<Description>Core engine: Manages ObjectScript class lifecycle within IRIS.
Write, compile, read, export, delete, and validate COS classes.

Uses IRIS system APIs: $system.OBJ, %Dictionary, %Stream.
Patterns derived from VersionControl.UpdateBranch reference implementation.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Abstract>1</Abstract>
<Parameter name="COMPILEFLAGS">
<Description>Default compile flags: c=compile, k=keep generated source.</Description>
<Default>ck</Default>
</Parameter>

<Parameter name="GENERATEDPREFIX">
<Description>Package prefix for all AI-generated classes.</Description>
<Default>AIAgent.Generated</Default>
</Parameter>

<Method name="WriteClass">
<Description>Write a COS class source to the IRIS namespace.
The source must be a complete class definition including the Class statement.
Returns $$$OK on success, error status on failure.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,source:%String,*errMsg:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set errMsg = ""
    set sc = $$$OK
    try {
        // Write source to a temporary stream
        set stream = ##class(%Stream.TmpCharacter).%New()
        do stream.Write(source)
        do stream.Rewind()

        // Load from stream using UDL format
        set sc = $system.OBJ.LoadStream(stream, ..#COMPILEFLAGS, .errorLog, , 1)
        if $$$ISERR(sc) {
            set errMsg = $system.Status.GetOneErrorText(sc)
        }
        // Check for errors in the error log
        if $data(errorLog) {
            set key = ""
            for {
                set key = $order(errorLog(key))
                quit:key=""
                set errMsg = errMsg _ $select(errMsg'="":" | ", 1:"") _ errorLog(key)
            }
        }
    } catch ex {
        set sc = ex.AsStatus()
        set errMsg = ex.DisplayString()
    }

    // Audit
    if $$$ISOK(sc) {
        do ##class(AIAgent.Util.Logger).Info("CodeManager", "WriteClass OK", className)
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("compile", className, "Compiled successfully")
    } else {
        do ##class(AIAgent.Util.Logger).Error("CodeManager", "WriteClass FAILED", className_": "_errMsg)
        do ##class(AIAgent.Model.AuditEntry).LogFailure("compile", className, errMsg)
    }
    return sc
]]></Implementation>
</Method>

<Method name="CompileClass">
<Description>Compile an existing class in the namespace.
Returns compilation output and any errors.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,*log:%String,*errors:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set log = ""
    set errors = ""
    set sc = $$$OK
    try {
        set sc = $system.OBJ.Compile(className, ..#COMPILEFLAGS, .errorLog)
        if $data(errorLog) {
            set key = ""
            for {
                set key = $order(errorLog(key))
                quit:key=""
                set errors = errors _ $select(errors'="":" | ", 1:"") _ errorLog(key)
            }
        }
    } catch ex {
        set sc = ex.AsStatus()
        set errors = ex.DisplayString()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ReadClass">
<Description>Read the full source of a class from the IRIS namespace.
Returns the source as a string using UDL export.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,*source:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set source = ""
    set sc = $$$OK
    try {
        // Check class exists
        if '##class(%Dictionary.ClassDefinition).%ExistsId(className) {
            return $$$ERROR($$$GeneralError, "Class '"_className_"' does not exist")
        }
        // Export to a temp stream in UDL format
        set stream = ##class(%Stream.TmpCharacter).%New()
        set sc = $system.OBJ.ExportUDL(className_".cls", .stream)
        if $$$ISOK(sc) {
            do stream.Rewind()
            set source = stream.Read(stream.Size)
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="DeleteClass">
<Description>Delete a class from the namespace.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        if '##class(%Dictionary.ClassDefinition).%ExistsId(className) {
            return $$$ERROR($$$GeneralError, "Class '"_className_"' does not exist")
        }
        set sc = $system.OBJ.Delete(className_".cls")
        if $$$ISOK(sc) {
            do ##class(AIAgent.Model.AuditEntry).LogSuccess("delete", className)
            do ##class(AIAgent.Util.Logger).Info("CodeManager", "Deleted class", className)
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ClassExists">
<Description>Check if a class exists in the namespace.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
    return ##class(%Dictionary.ClassDefinition).%ExistsId(className)
]]></Implementation>
</Method>

<Method name="ListClasses">
<Description>List all classes matching a SQL LIKE pattern.
Example: pattern = &quot;AIAgent.Generated.%&quot; or &quot;BRI.Interfaces.Cerner.%&quot;</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pattern:%String=&quot;AIAgent.Generated.%&quot;</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set sql = "SELECT Name, Super FROM %Dictionary.ClassDefinition WHERE Name LIKE ? ORDER BY Name"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(pattern)
    while rs.%Next() {
        set obj = ##class(%DynamicObject).%New()
        set obj.name = rs.%GetData(1)
        set obj.super = rs.%GetData(2)
        do arr.%Push(obj)
    }
    return arr
]]></Implementation>
</Method>

<Method name="ExportClasses">
<Description>Export all classes matching a pattern to a directory as individual UDL files.
Uses $system.OBJ.ExportAllClassesIndividual following the VersionControl pattern.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pattern:%String,directory:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        // Ensure directory exists
        if '##class(%File).DirectoryExists(directory) {
            do ##class(%File).CreateDirectoryChain(directory)
        }
        // Export using the IRIS system API
        set package = $piece(pattern, ".", 1, *-1)
        set package = $translate(package, "%", "")
        do $system.OBJ.ExportAllClassesIndividual(directory, "/diffexport=1", "", "", package)
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("export", pattern, "Exported to "_directory)
    } catch ex {
        set sc = ex.AsStatus()
        do ##class(AIAgent.Model.AuditEntry).LogFailure("export", pattern, ex.DisplayString())
    }
    return sc
]]></Implementation>
</Method>

<Method name="ImportClasses">
<Description>Import all classes from a directory. Compiles after import.
Uses $system.OBJ.LoadDir following the VersionControl pattern.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>directory:%String,*log:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set log = ""
    set sc = $$$OK
    try {
        set sc = $system.OBJ.LoadDir(directory, ..#COMPILEFLAGS_"/multicompile=0")
        if $$$ISOK(sc) {
            set log = "Import and compile successful"
            do ##class(AIAgent.Model.AuditEntry).LogSuccess("import", directory, log)
        } else {
            set log = $system.Status.GetOneErrorText(sc)
            do ##class(AIAgent.Model.AuditEntry).LogFailure("import", directory, log)
        }
    } catch ex {
        set sc = ex.AsStatus()
        set log = ex.DisplayString()
    }
    return sc
]]></Implementation>
</Method>

<Method name="DeletePackage">
<Description>Delete an entire package of classes.
Uses $system.OBJ.DeletePackage following the VersionControl pattern.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>packageName:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        do $system.OBJ.DeletePackage(packageName)
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("delete", packageName, "Package deleted")
        do ##class(AIAgent.Util.Logger).Info("CodeManager", "Deleted package", packageName)
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ExportHL7Schemas">
<Description>Export all custom HL7 schemas to a directory.
Following the VersionControl.UpdateBranch.ExportHL7Schemas pattern.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>directory:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        if '##class(%Dictionary.CompiledClass).%ExistsId("EnsLib.HL7.SchemaDocument") {
            return $$$ERROR($$$GeneralError, "EnsLib.HL7.SchemaDocument not available")
        }
        if '##class(%File).DirectoryExists(directory) {
            do ##class(%File).CreateDirectoryChain(directory)
        }
        set rs = ##class(%ResultSet).%New("EnsLib.HL7.SchemaDocument:List")
        do rs.Execute()
        while rs.Next() {
            set item = rs.Data("name")
            continue:$listfind($lb("HealthShare_2.5.HL7"), item)
            set category = $replace(item, ".HL7", "")
            set custom = ##class(EnsPortal.HL7.Utils).IsCustomSchema(category)
            if custom {
                do ##class(EnsLib.HL7.SchemaXML).Export(category, directory_"/"_category_".HL7")
            }
        }
        do rs.Close()
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("export", "HL7Schemas", "Exported to "_directory)
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ImportHL7Schemas">
<Description>Import HL7 schemas from a directory.
Following the VersionControl.UpdateBranch.ImportHL7Schemas pattern.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>directory:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        set dir = ##class(%File).NormalizeDirectory(directory)
        set file = $zsearch(dir_"*.HL7")
        while file '= "" {
            do ##class(EnsLib.HL7.SchemaXML).Import(file)
            do ##class(AIAgent.Util.Logger).Info("CodeManager", "Imported HL7 schema", file)
            set file = $zsearch("")
        }
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("import", "HL7Schemas", "Imported from "_directory)
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ExportLookupTables">
<Description>Export all lookup tables to a directory.
Following the VersionControl.UpdateBranch.ExportLookups pattern.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>directory:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        if '##class(%File).DirectoryExists(directory) {
            do ##class(%File).CreateDirectoryChain(directory)
        }
        // Export all to one file first
        do ##class(Ens.Util.LookupTable).%Export(directory_"/AllLookups.xml")

        // Also export individually
        set sql = "SELECT DISTINCT TableName FROM Ens_Util.LookupTable"
        set stmt = ##class(%SQL.Statement).%New()
        do stmt.%Prepare(sql)
        set rs = stmt.%Execute()
        while rs.%Next() {
            set tableName = rs.%GetData(1)
            do ##class(Ens.Util.LookupTable).%Export(directory_"/"_tableName_".lut.xml", tableName)
        }
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("export", "LookupTables", "Exported to "_directory)
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ImportLookupTable">
<Description>Import a lookup table from an XML file.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>filepath:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        set sc = ##class(Ens.Util.LookupTable).%Import(filepath)
        if $$$ISOK(sc) {
            do ##class(AIAgent.Model.AuditEntry).LogSuccess("import", "LookupTable", filepath)
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ListLookupTables">
<Description>List all lookup tables and their entry counts.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set sql = "SELECT TableName, COUNT(*) AS EntryCount FROM Ens_Util.LookupTable GROUP BY TableName ORDER BY TableName"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute()
    while rs.%Next() {
        set obj = ##class(%DynamicObject).%New()
        set obj.name = rs.%GetData(1)
        set obj.entryCount = rs.%GetData(2)
        do arr.%Push(obj)
    }
    return arr
]]></Implementation>
</Method>

<Method name="ReadLookupTable">
<Description>Read entries from a specific lookup table.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>tableName:%String</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set sql = "SELECT KeyName, DataValue FROM Ens_Util.LookupTable WHERE TableName = ? ORDER BY KeyName"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(tableName)
    while rs.%Next() {
        set obj = ##class(%DynamicObject).%New()
        set obj.key = rs.%GetData(1)
        set obj.value = rs.%GetData(2)
        do arr.%Push(obj)
    }
    return arr
]]></Implementation>
</Method>

<Method name="WriteLookupTable">
<Description>Write/update entries in a lookup table.
entries is a %DynamicArray of {key, value} objects.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>tableName:%String,entries:%DynamicArray</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        set iter = entries.%GetIterator()
        while iter.%GetNext(.idx, .entry) {
            set key = entry.%Get("key")
            set value = entry.%Get("value")
            // Use SQL to insert/update
            &sql(INSERT OR UPDATE INTO Ens_Util.LookupTable (TableName, KeyName, DataValue)
                 VALUES (:tableName, :key, :value))
            if SQLCODE < 0 {
                set sc = $$$ERROR($$$GeneralError, "SQL error inserting lookup entry: "_SQLCODE)
                quit
            }
        }
        if $$$ISOK(sc) {
            do ##class(AIAgent.Model.AuditEntry).LogSuccess("configure", "LookupTable:"_tableName, entries.%Size()_" entries written")
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ListHL7Schemas">
<Description>List all available HL7 schemas (both standard and custom).</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    try {
        if '##class(%Dictionary.CompiledClass).%ExistsId("EnsLib.HL7.SchemaDocument") {
            return arr
        }
        set rs = ##class(%ResultSet).%New("EnsLib.HL7.SchemaDocument:List")
        do rs.Execute()
        while rs.Next() {
            set item = rs.Data("name")
            set category = $replace(item, ".HL7", "")
            set obj = ##class(%DynamicObject).%New()
            set obj.name = item
            set obj.category = category
            try {
                set obj.isCustom = ##class(EnsPortal.HL7.Utils).IsCustomSchema(category)
            } catch {
                set obj.isCustom = 0
            }
            do arr.%Push(obj)
        }
        do rs.Close()
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("CodeManager", "ListHL7Schemas failed", ex.DisplayString())
    }
    return arr
]]></Implementation>
</Method>

<Method name="ExecuteSQL">
<Description>Execute a read-only SQL query and return results as a %DynamicArray.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sqlQuery:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    set rows = ##class(%DynamicArray).%New()
    set columns = ##class(%DynamicArray).%New()
    try {
        // Safety check: only allow SELECT statements
        set trimmed = $zstrip(sqlQuery, "<>W")
        if $zconvert($extract(trimmed, 1, 6), "U") '= "SELECT" {
            set result.error = "Only SELECT queries are allowed"
            return result
        }
        set stmt = ##class(%SQL.Statement).%New()
        set sc = stmt.%Prepare(sqlQuery)
        if $$$ISERR(sc) {
            set result.error = $system.Status.GetOneErrorText(sc)
            return result
        }
        set rs = stmt.%Execute()
        // Get column names
        set colCount = rs.%ResultColumnCount
        for i = 1:1:colCount {
            do columns.%Push(rs.%GetColumnName(i))
        }
        // Read rows
        set rowCount = 0
        while rs.%Next() {
            set row = ##class(%DynamicObject).%New()
            for i = 1:1:colCount {
                set colName = rs.%GetColumnName(i)
                do row.%Set(colName, rs.%GetData(i))
            }
            do rows.%Push(row)
            set rowCount = rowCount + 1
            quit:(rowCount >= 1000)  // safety limit
        }
    } catch ex {
        set result.error = ex.DisplayString()
    }
    set result.columns = columns
    set result.rows = rows
    set result.rowCount = rows.%Size()
    return result
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Engine.ProductionManager">
<Description>Core engine: Manages IRIS HealthConnect production configuration and lifecycle.
Provides methods to inspect, modify, start/stop, and monitor productions.

Uses IRIS Ensemble APIs: Ens.Director, Ens.Config.Production, Ens.Config.Item.
Production status codes: 1=Running, 2=Stopped, 3=Suspended, 4=Troubled.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Abstract>1</Abstract>
<Method name="GetStatus">
<Description>Get the current production name and running status.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    try {
        do ##class(Ens.Director).GetProductionStatus(.prodName, .prodStatus)
        set result.productionName = $get(prodName, "")
        set result.statusCode = $get(prodStatus, 0)
        set result.statusText = $case(+$get(prodStatus,0),
            1:"Running",
            2:"Stopped",
            3:"Suspended",
            4:"Troubled",
            :"Unknown")
        set result.namespace = $namespace
    } catch ex {
        set result.error = ex.DisplayString()
    }
    return result
]]></Implementation>
</Method>

<Method name="GetTopology">
<Description>Get the full production topology as structured JSON.
Returns all business hosts with their class names, adapter types, settings, and categories.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    set hosts = ##class(%DynamicArray).%New()
    try {
        // Get production status
        do ##class(Ens.Director).GetProductionStatus(.prodName, .prodStatus)
        set result.productionName = $get(prodName, "")
        set result.statusCode = $get(prodStatus, 0)

        // Open the production definition
        if prodName '= "" {
            set prodDef = ##class(Ens.Config.Production).%OpenId(prodName)
            if $isobject(prodDef) {
                set result.description = prodDef.Description
                // Iterate all items (business hosts)
                for i = 1:1:prodDef.Items.Count() {
                    set item = prodDef.Items.GetAt(i)
                    set host = ##class(%DynamicObject).%New()
                    set host.name = item.Name
                    set host.className = item.ClassName
                    set host.category = item.Category
                    set host.enabled = item.Enabled
                    set host.comment = item.Comment
                    // Determine host type from superclass
                    set host.hostType = ..GetHostType(item.ClassName)
                    // Get adapter if applicable
                    try {
                        set host.adapter = $parameter(item.ClassName, "ADAPTER")
                    } catch {
                        set host.adapter = ""
                    }
                    // Get settings as key-value pairs
                    set settingsObj = ##class(%DynamicObject).%New()
                    if item.Settings '= "" {
                        set settings = item.Settings
                        for s = 1:1:$length(settings, ",") {
                            set pair = $piece(settings, ",", s)
                            if pair [ "=" {
                                set sName = $piece(pair, "=", 1)
                                set sValue = $piece(pair, "=", 2, *)
                                do settingsObj.%Set(sName, sValue)
                            }
                        }
                    }
                    set host.settings = settingsObj
                    do hosts.%Push(host)
                }
            }
        }
    } catch ex {
        set result.error = ex.DisplayString()
    }
    set result.hosts = hosts
    set result.hostCount = hosts.%Size()
    return result
]]></Implementation>
</Method>

<Method name="GetHostType">
<Description>Determine the host type (BusinessService, BusinessProcess, BusinessOperation, Router)
by checking the class hierarchy.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    try {
        if $classmethod(className, "%IsA", "Ens.BusinessService") return "BusinessService"
        if $classmethod(className, "%IsA", "Ens.BusinessProcess") return "BusinessProcess"
        if $classmethod(className, "%IsA", "Ens.BusinessOperation") return "BusinessOperation"
        if $classmethod(className, "%IsA", "EnsLib.HL7.MsgRouter.RoutingEngine") return "Router"
    } catch {
        // Class may not exist or not extend Ens classes
    }
    return "Unknown"
]]></Implementation>
</Method>

<Method name="AddBusinessHost">
<Description>Add a new business host to the production.
config expects: {name, className, category, enabled, settings:{key:val,...}, comment}</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>config:%DynamicObject</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    quit ..EnsureBusinessHost(config, .opResult)
]]></Implementation>
</Method>

<Method name="EnsureBusinessHost">
<Description>Idempotent add host with structured outcome for demo/runtime reporting.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>config:%DynamicObject,&amp;opResult:%DynamicObject</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set opResult = ##class(%DynamicObject).%New()
    set sc = $$$OK
    try {
        if '$isobject(config) {
            return $$$ERROR($$$GeneralError, "Host config is required")
        }
        set hostName = config.%Get("name")
        set className = config.%Get("className")
        if hostName = "" {
            return $$$ERROR($$$GeneralError, "Host name is required")
        }
        if className = "" {
            return $$$ERROR($$$GeneralError, "Host className is required")
        }

        do ##class(Ens.Director).GetProductionStatus(.prodName, .prodStatus)
        if prodName = "" {
            return $$$ERROR($$$GeneralError, "No production found in namespace")
        }
        set prodDef = ##class(Ens.Config.Production).%OpenId(prodName)
        if '$isobject(prodDef) {
            return $$$ERROR($$$GeneralError, "Cannot open production "_prodName)
        }

        for i = 1:1:prodDef.Items.Count() {
            set existing = prodDef.Items.GetAt(i)
            if existing.Name = hostName {
                set opResult.action = "add"
                set opResult.hostName = hostName
                set opResult.className = existing.ClassName
                set opResult.status = "exists"
                set opResult.enabled = +$get(existing.Enabled)
                set opResult.category = $get(existing.Category)
                set opResult.message = "Host already exists; no mutation applied."
                return $$$OK
            }
        }

        set item = ##class(Ens.Config.Item).%New()
        set item.Name = hostName
        set item.ClassName = className
        set item.Category = $select(config.%Get("category")'="":config.%Get("category"), 1:"AIGenerated")
        set enabledRequested = $select(config.%Get("enabled")'="":+config.%Get("enabled"), 1:1)
        set item.Comment = $select(config.%Get("comment")'="":config.%Get("comment"), 1:"Added by IRIS CoPilot")

        if $isobject(config.%Get("settings")) {
            set item.Settings = ..SettingsObjectToString(config.%Get("settings"))
        }

        do prodDef.Items.Insert(item)
        set sc = prodDef.%Save()
        if $$$ISERR(sc) {
            return sc
        }

        // Apply runtime enable/disable via Director API (safer than direct assignment on Ens.Config.Item).
        set scEnable = ##class(Ens.Director).EnableConfigItem(hostName, enabledRequested, 1)
        if $$$ISERR(scEnable) {
            // Keep this non-fatal for demo flow: config exists and was saved; capture warning only.
            do ##class(AIAgent.Util.Logger).Error("ProductionManager", "EnableConfigItem warning", $system.Status.GetOneErrorText(scEnable))
        }

        do ##class(AIAgent.Model.AuditEntry).LogSuccess("deploy", hostName, "Added to production "_prodName)
        do ##class(AIAgent.Util.Logger).Info("ProductionManager", "Added host", hostName)

        set opResult.action = "add"
        set opResult.hostName = hostName
        set opResult.className = className
        set opResult.status = "created"
        set opResult.enabled = enabledRequested
        set opResult.category = item.Category
        set opResult.message = "Host created."
    } catch ex {
        set sc = ex.AsStatus()
        do ##class(AIAgent.Model.AuditEntry).LogFailure("deploy", $get(hostName), ex.DisplayString())
    }
    return sc
]]></Implementation>
</Method>

<Method name="RemoveBusinessHost">
<Description>Remove a business host from the production by name.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>itemName:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    quit ..RemoveBusinessHostEx(itemName, .opResult)
]]></Implementation>
</Method>

<Method name="RemoveBusinessHostEx">
<Description>Idempotent remove host with structured outcome.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>itemName:%String,&amp;opResult:%DynamicObject</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set opResult = ##class(%DynamicObject).%New()
    set sc = $$$OK
    try {
        if itemName = "" {
            return $$$ERROR($$$GeneralError, "Host name is required")
        }
        do ##class(Ens.Director).GetProductionStatus(.prodName, .prodStatus)
        set prodDef = ##class(Ens.Config.Production).%OpenId(prodName)
        if '$isobject(prodDef) {
            return $$$ERROR($$$GeneralError, "Cannot open production")
        }

        set found = 0
        for i = 1:1:prodDef.Items.Count() {
            if prodDef.Items.GetAt(i).Name = itemName {
                do prodDef.Items.RemoveAt(i)
                set found = 1
                quit
            }
        }
        if 'found {
            set opResult.action = "remove"
            set opResult.hostName = itemName
            set opResult.status = "not_found"
            set opResult.message = "Host was not present; no mutation applied."
            return $$$OK
        }

        set sc = prodDef.%Save()
        if $$$ISERR(sc) {
            return sc
        }
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("delete", itemName, "Removed from production")
        do ##class(AIAgent.Util.Logger).Info("ProductionManager", "Removed host", itemName)

        set opResult.action = "remove"
        set opResult.hostName = itemName
        set opResult.status = "removed"
        set opResult.message = "Host removed."
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="UpdateHostSettings">
<Description>Update settings for an existing business host.
settings is a %DynamicObject of {key: value} pairs.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>itemName:%String,settings:%DynamicObject</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    quit ..UpdateHostSettingsEx(itemName, settings, .opResult)
]]></Implementation>
</Method>

<Method name="UpdateHostSettingsEx">
<Description>Update host settings with structured per-item outcome.
Special key handling:
- Enabled =&gt; updates item.Enabled property
- Comment =&gt; updates item.Comment property</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>itemName:%String,settings:%DynamicObject,&amp;opResult:%DynamicObject</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set opResult = ##class(%DynamicObject).%New()
    set sc = $$$OK
    try {
        if (itemName = "") || ('$isobject(settings)) {
            return $$$ERROR($$$GeneralError, "Host name and settings object are required")
        }
        do ##class(Ens.Director).GetProductionStatus(.prodName, .prodStatus)
        set prodDef = ##class(Ens.Config.Production).%OpenId(prodName)
        if '$isobject(prodDef) {
            return $$$ERROR($$$GeneralError, "Cannot open production")
        }

        set found = 0
        for i = 1:1:prodDef.Items.Count() {
            set item = prodDef.Items.GetAt(i)
            if item.Name = itemName {
                set found = 1
                set currentSettings = ..SettingsStringToObject($get(item.Settings))
                set applied = ##class(%DynamicObject).%New()
                set iter = settings.%GetIterator()
                while iter.%GetNext(.key, .val) {
                    set keyLow = $zconvert(key, "L")
                    if keyLow = "enabled" {
                        // Apply Enabled as a runtime config-item toggle via Director.
                        set scEnable = ##class(Ens.Director).EnableConfigItem(itemName, +val, 1)
                        if $$$ISERR(scEnable) {
                            return scEnable
                        }
                        set applied.Enabled = +val
                    } elseif keyLow = "comment" {
                        set item.Comment = val
                        set applied.Comment = val
                    } else {
                        do currentSettings.%Set(key, val)
                        do applied.%Set(key, val)
                    }
                }
                set item.Settings = ..SettingsObjectToString(currentSettings)
                set opResult.applied = applied
                quit
            }
        }

        if 'found {
            set opResult.action = "settings"
            set opResult.hostName = itemName
            set opResult.status = "not_found"
            set opResult.message = "Host was not found; no mutation applied."
            return $$$OK
        }

        set sc = prodDef.%Save()
        if $$$ISERR(sc) {
            return sc
        }

        set opResult.action = "settings"
        set opResult.hostName = itemName
        set opResult.status = "updated"
        set opResult.message = "Host settings updated."
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="SettingsStringToObject">
<ClassMethod>1</ClassMethod>
<FormalSpec>settingsStr:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set out = ##class(%DynamicObject).%New()
    if settingsStr = "" quit out
    for s = 1:1:$length(settingsStr, ",") {
        set pair = $piece(settingsStr, ",", s)
        if pair [ "=" {
            set sName = $piece(pair, "=", 1)
            set sValue = $piece(pair, "=", 2, *)
            do out.%Set(sName, sValue)
        }
    }
    quit out
]]></Implementation>
</Method>

<Method name="SettingsObjectToString">
<ClassMethod>1</ClassMethod>
<FormalSpec>settings:%DynamicObject</FormalSpec>
<ReturnType>%String</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set settingsStr = ""
    if '$isobject(settings) quit settingsStr
    set iter = settings.%GetIterator()
    while iter.%GetNext(.key, .val) {
        if key = "" continue
        set:settingsStr'="" settingsStr = settingsStr _ ","
        set settingsStr = settingsStr _ key _ "=" _ val
    }
    quit settingsStr
]]></Implementation>
</Method>

<Method name="StartProduction">
<Description>Start the production.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>productionName:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        if productionName = "" {
            // Try to start the default production
            do ##class(Ens.Director).GetProductionStatus(.prodName, .prodStatus)
            set productionName = prodName
        }
        if productionName = "" {
            return $$$ERROR($$$GeneralError, "No production name specified and no default found")
        }
        set sc = ##class(Ens.Director).StartProduction(productionName)
        if $$$ISOK(sc) {
            do ##class(AIAgent.Model.AuditEntry).LogSuccess("start", productionName)
        } else {
            do ##class(AIAgent.Model.AuditEntry).LogFailure("start", productionName, $system.Status.GetOneErrorText(sc))
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="StopProduction">
<Description>Stop the production.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>timeout:%Integer=300</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        set sc = ##class(Ens.Director).StopProduction(timeout, 1)
        do ##class(Ens.Director).GetProductionStatus(.prodName, .prodStatus)
        if $$$ISOK(sc) {
            do ##class(AIAgent.Model.AuditEntry).LogSuccess("stop", $get(prodName,""))
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="UpdateProduction">
<Description>Update a running production (apply config changes without full restart).</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        set sc = ##class(Ens.Director).UpdateProduction()
        if $$$ISOK(sc) {
            do ##class(AIAgent.Model.AuditEntry).LogSuccess("configure", "Production", "Live update applied")
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="RestartHost">
<Description>Restart a specific business host item by name.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>itemName:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        // Disable then re-enable to restart
        set sc = ##class(Ens.Director).EnableConfigItem(itemName, 0, 1)
        if $$$ISOK(sc) {
            hang 1  // brief pause
            set sc = ##class(Ens.Director).EnableConfigItem(itemName, 1, 1)
        }
        if $$$ISOK(sc) {
            do ##class(AIAgent.Util.Logger).Info("ProductionManager", "Restarted host", itemName)
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="GetQueueCounts">
<Description>Get message queue depths for all hosts.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    try {
        set sql = "SELECT ConfigName, COUNT(*) As QueueDepth FROM Ens.MessageHeader WHERE Status = 6 GROUP BY ConfigName HAVING COUNT(*) > 0 ORDER BY QueueDepth DESC"
        set stmt = ##class(%SQL.Statement).%New()
        do stmt.%Prepare(sql)
        set rs = stmt.%Execute()
        while rs.%Next() {
            set obj = ##class(%DynamicObject).%New()
            set obj.hostName = rs.%GetData(1)
            set obj.queueDepth = rs.%GetData(2)
            do arr.%Push(obj)
        }
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("ProductionManager", "GetQueueCounts failed", ex.DisplayString())
    }
    return arr
]]></Implementation>
</Method>

<Method name="GetEventLog">
<Description>Get recent event log entries.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>count:%Integer=50,configName:%String=&quot;&quot;</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    try {
        set sql = "SELECT TOP ? ID, ConfigName, TimeLogged, Type, Text FROM Ens_Util.Log"
        if configName '= "" {
            set sql = sql _ " WHERE ConfigName = ?"
        }
        set sql = sql _ " ORDER BY ID DESC"
        set stmt = ##class(%SQL.Statement).%New()
        do stmt.%Prepare(sql)
        set rs = $select(configName'="":stmt.%Execute(count, configName), 1:stmt.%Execute(count))
        while rs.%Next() {
            set obj = ##class(%DynamicObject).%New()
            set obj.id = rs.%GetData(1)
            set obj.configName = rs.%GetData(2)
            set obj.timeLogged = rs.%GetData(3)
            set obj.type = rs.%GetData(4)
            set obj.text = rs.%GetData(5)
            do arr.%Push(obj)
        }
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("ProductionManager", "GetEventLog failed", ex.DisplayString())
    }
    return arr
]]></Implementation>
</Method>

<Method name="GetMessageTrace">
<Description>Get message trace for a specific session or message header ID.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>headerId:%Integer</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    try {
        set header = ##class(Ens.MessageHeader).%OpenId(headerId)
        if '$isobject(header) {
            set result.error = "Message header "_headerId_" not found"
            return result
        }
        set result.id = header.%Id()
        set result.status = header.Status
        set result.sourceConfigName = header.SourceConfigName
        set result.targetConfigName = header.TargetConfigName
        set result.timeCreated = header.TimeCreated
        set result.timeProcessed = header.TimeProcessed
        set result.messageBodyClassName = header.MessageBodyClassName
        set result.sessionId = header.SessionId
        set result.isError = header.IsError
        set result.errorStatus = $select(header.IsError:$system.Status.GetOneErrorText(header.ErrorStatus), 1:"")
    } catch ex {
        set result.error = ex.DisplayString()
    }
    return result
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Engine.VersionManager">
<Description>Core engine: Version control for AI-generated code.
Creates snapshots before deployment and supports rollback.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Abstract>1</Abstract>
<Method name="CreateSnapshot">
<Description>Create a snapshot of the current state of classes that will be affected by a generation.
Captures the source of each class (if it exists) so we can restore on rollback.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>generationId:%String,description:%String=&quot;&quot;</FormalSpec>
<ReturnType>AIAgent.Model.Version</ReturnType>
<Implementation><![CDATA[
    set ver = ##class(AIAgent.Model.Version).Create(generationId, description)
    if '$isobject(ver) {
        return ""
    }

    // Get the generation to find which classes are being deployed
    set gen = ##class(AIAgent.Model.Generation).FindById(generationId)
    if '$isobject(gen) {
        do ##class(AIAgent.Util.Logger).Error("VersionManager", "Generation not found", generationId)
        return ""
    }

    // Build snapshot: array of {className, source} for each class that currently exists
    set snapshot = ##class(%DynamicArray).%New()
    set classCount = 0

    // Query all GenerationClass records for this generation
    set sql = "SELECT ID FROM AIAgent_Model.GenerationClass WHERE GenerationId = ?"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(generationId)

    while rs.%Next() {
        set gc = ##class(AIAgent.Model.GenerationClass).%OpenId(rs.%GetData(1))
        if $isobject(gc) {
            set className = gc.ClassName
            set entry = ##class(%DynamicObject).%New()
            set entry.className = className

            // Capture current source (if class exists)
            if ##class(AIAgent.Engine.CodeManager).ClassExists(className) {
                set sc = ##class(AIAgent.Engine.CodeManager).ReadClass(className, .currentSource)
                if $$$ISOK(sc) {
                    set entry.source = currentSource
                    set entry.existed = 1
                }
            } else {
                set entry.source = ""
                set entry.existed = 0
            }
            do snapshot.%Push(entry)
            set classCount = classCount + 1
        }
    }

    // Save snapshot to version
    do ver.Snapshot.Write(snapshot.%ToJSON())
    set ver.ClassCount = classCount

    // Also snapshot production config
    set topology = ##class(AIAgent.Engine.ProductionManager).GetTopology()
    do ver.ProductionSnapshot.Write(topology.%ToJSON())

    do ver.%Save()
    do ##class(AIAgent.Util.Logger).Info("VersionManager", "Snapshot created", ver.VersionId_" ("_classCount_" classes)")
    return ver
]]></Implementation>
</Method>

<Method name="Rollback">
<Description>Rollback to a previous version.
Restores all class sources from the snapshot and recompiles.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>versionId:%String,*log:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set log = ""
    set sc = $$$OK

    set ver = ##class(AIAgent.Model.Version).FindById(versionId)
    if '$isobject(ver) {
        return $$$ERROR($$$GeneralError, "Version '"_versionId_"' not found")
    }

    // Read the snapshot
    do ver.Snapshot.Rewind()
    set snapshotJSON = ver.Snapshot.Read(ver.Snapshot.Size)
    if snapshotJSON = "" {
        return $$$ERROR($$$GeneralError, "Version snapshot is empty")
    }

    set snapshot = ##class(%DynamicArray).%FromJSON(snapshotJSON)
    set iter = snapshot.%GetIterator()
    set restoredCount = 0
    set deletedCount = 0
    set errors = ""

    while iter.%GetNext(.idx, .entry) {
        set className = entry.%Get("className")
        set source = entry.%Get("source")
        set existed = entry.%Get("existed")

        if existed && (source '= "") {
            // Restore the previous source
            set sc2 = ##class(AIAgent.Engine.CodeManager).WriteClass(className, source, .errMsg)
            if $$$ISOK(sc2) {
                set restoredCount = restoredCount + 1
            } else {
                set errors = errors _ className _ ": " _ errMsg _ "; "
            }
        } elseif 'existed {
            // Class didn't exist before — delete it
            if ##class(AIAgent.Engine.CodeManager).ClassExists(className) {
                set sc2 = ##class(AIAgent.Engine.CodeManager).DeleteClass(className)
                if $$$ISOK(sc2) {
                    set deletedCount = deletedCount + 1
                }
            }
        }
    }

    // Update version status
    set ver.Status = "rolled_back"
    do ver.%Save()

    // Also mark the associated generation as rolled_back
    if ver.GenerationId '= "" {
        set gen = ##class(AIAgent.Model.Generation).FindById(ver.GenerationId)
        if $isobject(gen) {
            do gen.UpdateStatus("rolled_back")
        }
    }

    set log = "Rollback to "_versionId_": restored "_restoredCount_" classes, deleted "_deletedCount_" new classes"
    if errors '= "" {
        set log = log _ ". Errors: " _ errors
        set sc = $$$ERROR($$$GeneralError, errors)
        do ##class(AIAgent.Model.AuditEntry).LogFailure("rollback", versionId, errors, log)
    } else {
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("rollback", versionId, log)
    }

    // Update production to apply changes
    do ##class(AIAgent.Engine.ProductionManager).UpdateProduction()

    do ##class(AIAgent.Util.Logger).Info("VersionManager", "Rollback complete", log)
    return sc
]]></Implementation>
</Method>

<Method name="ListVersions">
<Description>List all versions, newest first.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>page:%Integer=1,pageSize:%Integer=20</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    return ##class(AIAgent.Model.Version).List(page, pageSize)
]]></Implementation>
</Method>

<Method name="GetVersion">
<Description>Get a specific version details.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>versionId:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set ver = ##class(AIAgent.Model.Version).FindById(versionId)
    if '$isobject(ver) {
        return ""
    }
    return ver.ToJSON()
]]></Implementation>
</Method>

<Method name="ExportVersion">
<Description>Export a version as an XML deployment package to a directory.
Exports all class sources from the snapshot to individual .cls files.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>versionId:%String,directory:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        set ver = ##class(AIAgent.Model.Version).FindById(versionId)
        if '$isobject(ver) {
            return $$$ERROR($$$GeneralError, "Version not found")
        }

        // Ensure directory exists
        if '##class(%File).DirectoryExists(directory) {
            do ##class(%File).CreateDirectoryChain(directory)
        }

        // Read snapshot and write each class source to a file
        do ver.Snapshot.Rewind()
        set snapshotJSON = ver.Snapshot.Read(ver.Snapshot.Size)
        set snapshot = ##class(%DynamicArray).%FromJSON(snapshotJSON)
        set iter = snapshot.%GetIterator()

        while iter.%GetNext(.idx, .entry) {
            set className = entry.%Get("className")
            set source = entry.%Get("source")
            if source '= "" {
                set fileName = $translate(className, ".", "/") _ ".cls"
                // Ensure subdirectories exist
                set subDir = directory _ "/" _ $piece(fileName, "/", 1, *-1)
                if '##class(%File).DirectoryExists(subDir) {
                    do ##class(%File).CreateDirectoryChain(subDir)
                }
                set file = ##class(%Stream.FileCharacter).%New()
                do file.FilenameSet(directory _ "/" _ fileName)
                do file.Write(source)
                do file.%Save()
                do file.%Close()
            }
        }

        do ##class(AIAgent.Model.AuditEntry).LogSuccess("export", versionId, "Exported to "_directory)
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Engine.TestRunner">
<Description>Core engine: Executes %UnitTest suites and returns structured results.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Abstract>1</Abstract>
<Method name="RunTestClass">
<Description>Run a specific test class and return results as JSON.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>testClassName:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    set result.testClass = testClassName
    set methods = ##class(%DynamicArray).%New()
    set passCount = 0
    set failCount = 0
    set errorCount = 0
    try {
        // Verify the test class exists and is a %UnitTest.TestCase
        if '##class(%Dictionary.ClassDefinition).%ExistsId(testClassName) {
            set result.error = "Test class '"_testClassName_"' does not exist"
            return result
        }

        // Get all Test* methods from the class
        set sql = "SELECT Name FROM %Dictionary.MethodDefinition WHERE parent = ? AND Name LIKE 'Test%'"
        set stmt = ##class(%SQL.Statement).%New()
        do stmt.%Prepare(sql)
        set rs = stmt.%Execute(testClassName)

        while rs.%Next() {
            set methodName = rs.%GetData(1)
            set methodResult = ##class(%DynamicObject).%New()
            set methodResult.name = methodName

            try {
                // Create test instance and run the method
                set testObj = $classmethod(testClassName, "%New")
                do $method(testObj, methodName)

                // If we got here without exception, the method passed
                set methodResult.status = "passed"
                set passCount = passCount + 1
            } catch testEx {
                // Check if it's an assertion failure or a real error
                if testEx.Name [ "AssertFailure" {
                    set methodResult.status = "failed"
                    set methodResult.message = testEx.DisplayString()
                    set failCount = failCount + 1
                } else {
                    set methodResult.status = "error"
                    set methodResult.message = testEx.DisplayString()
                    set errorCount = errorCount + 1
                }
            }

            do methods.%Push(methodResult)
        }
    } catch ex {
        set result.error = "Test runner error: "_ex.DisplayString()
        set errorCount = errorCount + 1
    }

    set result.methods = methods
    set result.passed = passCount
    set result.failed = failCount
    set result.errors = errorCount
    set result.total = passCount + failCount + errorCount
    set result.success = (failCount = 0) && (errorCount = 0)

    // Audit
    if result.success {
        do ##class(AIAgent.Model.AuditEntry).LogSuccess("test", testClassName, passCount_" passed")
    } else {
        do ##class(AIAgent.Model.AuditEntry).LogFailure("test", testClassName, failCount_" failed, "_errorCount_" errors")
    }

    return result
]]></Implementation>
</Method>

<Method name="RunTestSuite">
<Description>Run all test classes matching a pattern (e.g., &quot;AIAgent.Generated.%.Test.%&quot;).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pattern:%String=&quot;AIAgent.Generated.%.Test.%&quot;</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    set result.pattern = pattern
    set classes = ##class(%DynamicArray).%New()
    set totalPassed = 0
    set totalFailed = 0
    set totalErrors = 0

    // Find all test classes matching the pattern
    set sql = "SELECT Name FROM %Dictionary.ClassDefinition WHERE Name LIKE ? AND (Super [ '%UnitTest.TestCase' OR Super [ 'AIAgent')"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(pattern)

    while rs.%Next() {
        set testClass = rs.%GetData(1)
        set classResult = ..RunTestClass(testClass)
        do classes.%Push(classResult)
        set totalPassed = totalPassed + classResult.passed
        set totalFailed = totalFailed + classResult.failed
        set totalErrors = totalErrors + classResult.errors
    }

    set result.classes = classes
    set result.totalPassed = totalPassed
    set result.totalFailed = totalFailed
    set result.totalErrors = totalErrors
    set result.totalTests = totalPassed + totalFailed + totalErrors
    set result.success = (totalFailed = 0) && (totalErrors = 0)

    return result
]]></Implementation>
</Method>

<Method name="SendTestMessage">
<Description>Send a test HL7 message into a Business Service.
Returns the message header ID for tracing.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>serviceName:%String,hl7Content:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    try {
        // Create an HL7 message from the content string
        set msg = ##class(EnsLib.HL7.Message).%New()
        // Parse the HL7 content
        set sc = msg.ImportFromString(hl7Content)
        if $$$ISERR(sc) {
            set result.error = "Failed to parse HL7: "_$system.Status.GetOneErrorText(sc)
            return result
        }

        // Create a business service instance and process the message
        set sc = ##class(Ens.Director).CreateBusinessService(serviceName, .service)
        if $$$ISERR(sc) {
            set result.error = "Failed to create service '"_serviceName_"': "_$system.Status.GetOneErrorText(sc)
            return result
        }

        set sc = service.ProcessInput(msg)
        if $$$ISOK(sc) {
            set result.success = 1
            set result.message = "Test message sent to "_serviceName
        } else {
            set result.success = 0
            set result.error = $system.Status.GetOneErrorText(sc)
        }
    } catch ex {
        set result.error = ex.DisplayString()
    }
    return result
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Engine.BridgeClient">
<Description>Core engine: HTTP client connecting IRIS to the Node.js AI Agent Bridge.
All AI interactions flow through this client.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Abstract>1</Abstract>
<Parameter name="BRIDGEURL">
<Description>Base URL of the Node.js AI Agent Bridge.
Override via Config.GenericConfig if needed.</Description>
<Default>http://localhost:3100</Default>
</Parameter>

<Parameter name="TIMEOUT">
<Description>Request timeout in seconds.</Description>
<Default>120</Default>
</Parameter>

<Method name="GetBridgeURL">
<Description>Get the configured bridge URL (checks Config first, falls back to parameter).</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    try {
        set configUrl = ##class(Ens.Config.DefaultSettings).GetValue("AIAgent", "BridgeURL")
        if configUrl '= "" return configUrl
    } catch {}
    return ..#BRIDGEURL
]]></Implementation>
</Method>

<Method name="SendMessage">
<Description>Send a chat message to the bridge and get the full response.
Returns a %DynamicObject with the AI response.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>conversationId:%String,message:%String,targetNamespace:%String=&quot;&quot;,preferredRunner:%String=&quot;&quot;</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    try {
        set req = ..CreateRequest("/api/chat")
        // Build JSON body
        set body = ##class(%DynamicObject).%New()
        set body.conversationId = conversationId
        set body.message = message
        set body.namespace = $select(targetNamespace'="":targetNamespace, 1:$namespace)
        if preferredRunner '= "" { set body.preferredRunner = preferredRunner }
        // Add context: production status for the orchestrator
        set body.productionStatus = ##class(AIAgent.Engine.ProductionManager).GetStatus()

        do req.EntityBody.Write(body.%ToJSON())
        set sc = req.Post("/api/chat")
        if $$$ISERR(sc) {
            set result.error = "Bridge connection failed: "_$system.Status.GetOneErrorText(sc)
            return result
        }

        if req.HttpResponse.StatusCode '= 200 {
            set result.error = "Bridge returned HTTP "_req.HttpResponse.StatusCode
            set result.detail = req.HttpResponse.Data.Read()
            return result
        }

        // Parse response
        set responseBody = req.HttpResponse.Data.Read()
        set result = ##class(%DynamicObject).%FromJSON(responseBody)
    } catch ex {
        set result.error = "Bridge client error: "_ex.DisplayString()
        do ##class(AIAgent.Util.Logger).Error("BridgeClient", "SendMessage failed", ex.DisplayString())
    }
    return result
]]></Implementation>
</Method>

<Method name="SendMessageStream">
<Description>Send a chat message and stream the response via a callback.
The callback method receives each token chunk.
Returns a status and the full accumulated response.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>conversationId:%String,message:%String,*fullResponse:%String,preferredRunner:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set fullResponse = ""
    set sc = $$$OK
    try {
        set req = ..CreateRequest("/api/chat/stream")
        set body = ##class(%DynamicObject).%New()
        set body.conversationId = conversationId
        set body.message = message
        set body.namespace = $namespace
        if preferredRunner '= "" { set body.preferredRunner = preferredRunner }
        set body.productionStatus = ##class(AIAgent.Engine.ProductionManager).GetStatus()

        do req.EntityBody.Write(body.%ToJSON())
        set sc = req.Post("/api/chat/stream")
        if $$$ISERR(sc) return sc
        if req.HttpResponse.StatusCode '= 200 {
            do ##class(AIAgent.Util.Logger).Error("BridgeClient", "SendMessageStream HTTP error", "HTTP "_req.HttpResponse.StatusCode_": "_req.HttpResponse.Data.Read())
            return $$$ERROR($$$GeneralError, "Bridge returned HTTP "_req.HttpResponse.StatusCode)
        }

        // Read SSE stream
        set stream = req.HttpResponse.Data
        while 'stream.AtEnd {
            set line = stream.ReadLine()
            // SSE format: "data: {...}\n"
            if $extract(line, 1, 6) = "data: " {
                // Always proxy raw SSE data line to the caller first.
                // This keeps UI streaming working even if local JSON parse fails.
                write line, !!, *-3
                set jsonStr = $zstrip($extract(line, 7, *), "<W")
                try {
                    set chunk = ##class(%DynamicObject).%FromJSON(jsonStr)
                    // IRIS 2022.1-safe extraction: rely on %Get default behavior,
                    // avoid %IsDefined checks that can be version-sensitive.
                    set tok = chunk.%Get("token")
                    if tok '= "" {
                        set fullResponse = fullResponse _ tok
                    }
                    set rsp = chunk.%Get("response")
                    if (rsp '= "") && (fullResponse = "") {
                        set fullResponse = rsp
                    }
                    set fr = chunk.%Get("finalResponse")
                    if fr '= "" {
                        // Authoritative fallback emitted by bridge route:
                        // use this value to guarantee persistence when token
                        // parsing is lossy in older IRIS JSON handling.
                        set fullResponse = fr
                    }
                } catch {
                    // Fallback: when JSON parse fails, attempt to recover token text.
                    set tokenRaw = $piece($piece(jsonStr, """token"":""", 2), """,""done""", 1)
                    if tokenRaw '= "" {
                        set wrapper = "{""t"":"""_tokenRaw_"""}"
                        try {
                            set decoded = ##class(%DynamicObject).%FromJSON(wrapper)
                            set tok2 = decoded.%Get("t")
                            if tok2 '= "" {
                                set fullResponse = fullResponse _ tok2
                            }
                        } catch {}
                    }
                }
            }
        }
    } catch ex {
        set sc = ex.AsStatus()
        do ##class(AIAgent.Util.Logger).Error("BridgeClient", "SendMessageStream failed", ex.DisplayString())
    }
    return sc
]]></Implementation>
</Method>

<Method name="HealthCheck">
<Description>Check if the bridge is healthy.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    try {
        set req = ..CreateRequest("/api/health")
        set sc = req.Get("/api/health")
        if $$$ISERR(sc) {
            set result.healthy = 0
            set result.error = $system.Status.GetOneErrorText(sc)
            return result
        }
        if req.HttpResponse.StatusCode = 200 {
            set responseBody = req.HttpResponse.Data.Read()
            set result = ##class(%DynamicObject).%FromJSON(responseBody)
            set result.healthy = 1
        } else {
            set result.healthy = 0
            set result.error = "HTTP "_req.HttpResponse.StatusCode
        }
    } catch ex {
        set result.healthy = 0
        set result.error = ex.DisplayString()
    }
    return result
]]></Implementation>
</Method>

<Method name="ListRunners">
<Description>Get the list of available AI runners from the bridge.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    try {
        set req = ..CreateRequest("/api/runners")
        set sc = req.Get("/api/runners")
        if $$$ISOK(sc) && (req.HttpResponse.StatusCode = 200) {
            set responseBody = req.HttpResponse.Data.Read()
            return ##class(%DynamicArray).%FromJSON(responseBody)
        }
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("BridgeClient", "ListRunners failed", ex.DisplayString())
    }
    return ##class(%DynamicArray).%New()
]]></Implementation>
</Method>

<Method name="CreateRequest">
<Description>Internal: create a configured HTTP request to the bridge.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>path:%String</FormalSpec>
<ReturnType>%Net.HttpRequest</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set baseUrl = ..GetBridgeURL()
    set req = ##class(%Net.HttpRequest).%New()

    // Parse URL components
    set host = $piece($piece(baseUrl, "//", 2), ":", 1)
    set port = $piece($piece(baseUrl, "//", 2), ":", 2)
    set:port="" port = $select(baseUrl["https":443, 1:80)
    set:port["/" port = $piece(port, "/", 1)

    set req.Server = host
    set req.Port = port
    set req.Timeout = ..#TIMEOUT
    set req.ContentType = "application/json"
    if baseUrl [ "https" {
        set req.Https = 1
    }

    return req
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Engine.Orchestrator">
<Description>Core engine: High-level workflow orchestrator.
Coordinates the full lifecycle: message → AI → generate → review → deploy → test.
Acts as the main entry point called by the REST API Dispatcher.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Abstract>1</Abstract>
<Method name="ProcessMessage">
<Description>Process a user message within a conversation.
This is the main entry point for the chat workflow.
Returns a %DynamicObject with the AI response and any generated code.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>conversationId:%String,userMessage:%String,preferredRunner:%String=&quot;&quot;</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    try {
        // 1. Ensure conversation exists
        set conv = ##class(AIAgent.Model.Conversation).FindById(conversationId)
        if '$isobject(conv) {
            set conv = ##class(AIAgent.Model.Conversation).Create("New Conversation", $namespace)
            if '$isobject(conv) {
                set result.error = "Failed to create conversation"
                return result
            }
            set conversationId = conv.ConversationId
        }

        // 2. Save the user message
        set userMsg = ##class(AIAgent.Model.Message).Create(conversationId, "user", userMessage)
        if '$isobject(userMsg) {
            set result.error = "Failed to save user message"
            return result
        }

        // 3. Build context for the AI bridge
        // Include conversation history, production status, existing classes
        set context = ..BuildContext(conversationId)

        // 4. Send to AI Bridge
        set bridgeResponse = ##class(AIAgent.Engine.BridgeClient).SendMessage(conversationId, userMessage, conv.TargetNamespace, preferredRunner)
        if bridgeResponse.error '= "" {
            set result.error = bridgeResponse.error
            // Save error as system message
            do ##class(AIAgent.Model.Message).Create(conversationId, "system", "Error: "_bridgeResponse.error, "orchestrator")
            return result
        }

        // 5. Save the assistant response
        set responseText = bridgeResponse.%Get("response")
        set agentName = bridgeResponse.%Get("agent")
        set runnerUsed = bridgeResponse.%Get("runner")
        set assistantMsg = ##class(AIAgent.Model.Message).Create(conversationId, "assistant", responseText, agentName, runnerUsed)

        // 6. Check if the response includes generated code
        if $isobject(bridgeResponse.%Get("generation")) {
            set genData = bridgeResponse.generation
            set gen = ##class(AIAgent.Model.Generation).Create(conversationId, genData.%Get("description"), conv.TargetNamespace, runnerUsed)
            if $isobject(gen) {
                set assistantMsg.GenerationId = gen.GenerationId
                do assistantMsg.%Save()

                // Save each generated class
                set classes = genData.%Get("classes")
                if $isobject(classes) {
                    set iter = classes.%GetIterator()
                    while iter.%GetNext(.idx, .cls) {
                        set className = cls.%Get("className")
                        set classType = cls.%Get("classType")
                        set source = cls.%Get("source")

                        // Check if class already exists (for diff)
                        set previousSource = ""
                        if ##class(AIAgent.Engine.CodeManager).ClassExists(className) {
                            do ##class(AIAgent.Engine.CodeManager).ReadClass(className, .previousSource)
                        }

                        do ##class(AIAgent.Model.GenerationClass).Create(gen.GenerationId, className, classType, source, previousSource)
                    }
                }

                set result.generationId = gen.GenerationId
            }
        }

        // 7. Update conversation title if this is the first message
        if conv.Title = "" || (conv.Title = "New Conversation") {
            // Use first 100 chars of user message as title
            set conv.Title = $extract(userMessage, 1, 100)
            do conv.%Save()
        }

        set result.conversationId = conversationId
        set result.messageId = assistantMsg.MessageId
        set result.response = responseText
        set result.agent = agentName
        set result.runner = runnerUsed
    } catch ex {
        set result.error = "Orchestrator error: "_ex.DisplayString()
        do ##class(AIAgent.Util.Logger).Error("Orchestrator", "ProcessMessage failed", ex.DisplayString())
    }
    return result
]]></Implementation>
</Method>

<Method name="ApproveAndDeploy">
<Description>Approve a generation and deploy it.
Creates a version snapshot, compiles all classes, adds hosts to production.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>generationId:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    set result = ##class(%DynamicObject).%New()
    set result.generationId = generationId
    set compileResults = ##class(%DynamicArray).%New()
    try {
        set gen = ##class(AIAgent.Model.Generation).FindById(generationId)
        if '$isobject(gen) {
            set result.error = "Generation '"_generationId_"' not found"
            return result
        }
        if gen.Status '= "preview" {
            set result.error = "Generation is '"_gen.Status_"', expected 'preview'"
            return result
        }

        // 1. Create version snapshot
        set ver = ##class(AIAgent.Engine.VersionManager).CreateSnapshot(generationId, "Pre-deployment snapshot for "_gen.Description)
        if '$isobject(ver) {
            set result.error = "Failed to create version snapshot"
            return result
        }
        set result.versionId = ver.VersionId

        // 2. Mark as approved
        do gen.UpdateStatus("approved")
        set gen.VersionId = ver.VersionId
        do gen.%Save()

        // 3. Compile each class
        set allSuccess = 1
        set sql = "SELECT ID FROM AIAgent_Model.GenerationClass WHERE GenerationId = ?"
        set stmt = ##class(%SQL.Statement).%New()
        do stmt.%Prepare(sql)
        set rs = stmt.%Execute(generationId)

        while rs.%Next() {
            set gc = ##class(AIAgent.Model.GenerationClass).%OpenId(rs.%GetData(1))
            if '$isobject(gc) continue

            set source = gc.GetSource()
            set className = gc.ClassName

            set compileEntry = ##class(%DynamicObject).%New()
            set compileEntry.className = className

            // Write and compile
            set sc = ##class(AIAgent.Engine.CodeManager).WriteClass(className, source, .errMsg)
            if $$$ISOK(sc) {
                do gc.SetCompileResult("success")
                set compileEntry.status = "success"
            } else {
                do gc.SetCompileResult("error", errMsg)
                set compileEntry.status = "error"
                set compileEntry.errors = errMsg
                set allSuccess = 0
            }
            do compileResults.%Push(compileEntry)
        }

        set result.compileResults = compileResults
        set result.allCompiled = allSuccess

        if allSuccess {
            // 4. Mark as deployed
            do gen.UpdateStatus("deployed")

            // 5. Update production if it's running
            try {
                do ##class(AIAgent.Engine.ProductionManager).UpdateProduction()
            } catch {}

            set result.success = 1
            set result.message = "Deployed successfully"
            do ##class(AIAgent.Model.AuditEntry).LogSuccess("deploy", generationId, gen.ClassCount_" classes compiled and deployed")
        } else {
            set result.success = 0
            set result.message = "Some classes failed to compile — deployment incomplete"
            do ##class(AIAgent.Model.AuditEntry).LogFailure("deploy", generationId, "Compilation errors occurred")
        }
    } catch ex {
        set result.error = ex.DisplayString()
        do ##class(AIAgent.Model.AuditEntry).LogFailure("deploy", generationId, ex.DisplayString())
    }
    return result
]]></Implementation>
</Method>

<Method name="RejectGeneration">
<Description>Reject a generation (mark as rejected, do not deploy).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>generationId:%String,reason:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set gen = ##class(AIAgent.Model.Generation).FindById(generationId)
    if '$isobject(gen) {
        return $$$ERROR($$$GeneralError, "Generation not found")
    }
    do gen.UpdateStatus("rejected")
    do ##class(AIAgent.Model.AuditEntry).LogSuccess("reject", generationId, reason)
    return $$$OK
]]></Implementation>
</Method>

<Method name="BuildContext">
<Description>Build context object for the AI bridge.
Includes conversation history and production metadata.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>conversationId:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set ctx = ##class(%DynamicObject).%New()

    // Conversation history (last 20 messages)
    set messages = ##class(AIAgent.Model.Message).GetByConversation(conversationId)
    set ctx.messages = messages

    // Current production status
    set ctx.productionStatus = ##class(AIAgent.Engine.ProductionManager).GetStatus()

    // Namespace info
    set ctx.namespace = $namespace

    return ctx
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Templates.BusinessService">
<Description>Template generator for HL7 TCP Business Service classes.
Produces compilable ObjectScript for receiving HL7 messages over TCP.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%RegisteredObject</Super>
<Method name="Generate">
<Description>Generate a complete HL7 TCP Business Service class.
&lt;p&gt;Parameters:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;className - Fully qualified class name (e.g., AIAgent.Generated.Pharmacy.Service.RxReceiver)&lt;/li&gt;
&lt;li&gt;description - Human-readable purpose of this service&lt;/li&gt;
&lt;li&gt;port - TCP listener port number&lt;/li&gt;
&lt;li&gt;targetProcess - Business host name to route messages to&lt;/li&gt;
&lt;li&gt;hl7Schema - HL7 schema category (e.g., &quot;2.4&quot;, &quot;CERNER2.3&quot;)&lt;/li&gt;
&lt;li&gt;ackMode - ACK mode: &quot;Application&quot;, &quot;Immediate&quot;, or &quot;Never&quot; (default &quot;Application&quot;)&lt;/li&gt;
&lt;/ul&gt;</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,port:%Integer,targetProcess:%String,hl7Schema:%String=&quot;2.4&quot;,ackMode:%String=&quot;Application&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set source = ""
    set $p(className,".",1) = $p(className,".",1)  // validate
    set nl = $c(13,10)

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessService" _ nl
    set source = source _ "{" _ nl _ nl

    // Parameters
    set source = source _ "Parameter ADAPTER = ""EnsLib.HL7.Adapter.TCPInboundAdapter"";" _ nl _ nl

    // SETTINGS
    set source = source _ "/// Configurable settings exposed in the Management Portal." _ nl
    set source = source _ "Parameter SETTINGS = ""TargetConfigName:Basic,Port:Basic,MessageSchemaCategory:Basic,AckMode:Basic"";" _ nl _ nl

    // Properties
    set source = source _ "/// Target business process or router to send messages to." _ nl
    set source = source _ "Property TargetConfigName As %String(MAXLEN = 256) [ InitialExpression = """ _ targetProcess _ """ ];" _ nl _ nl
    set source = source _ "/// TCP port to listen on." _ nl
    set source = source _ "Property Port As %Integer [ InitialExpression = " _ port _ " ];" _ nl _ nl
    set source = source _ "/// HL7 schema category for parsing." _ nl
    set source = source _ "Property MessageSchemaCategory As %String(MAXLEN = 128) [ InitialExpression = """ _ hl7Schema _ """ ];" _ nl _ nl
    set source = source _ "/// ACK mode: Application, Immediate, or Never." _ nl
    set source = source _ "Property AckMode As %String [ InitialExpression = """ _ ackMode _ """ ];" _ nl _ nl

    // OnInit
    set source = source _ "/// Configure the TCP adapter on startup." _ nl
    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.Port = ..Port" _ nl
    set source = source _ "    set ..Adapter.MessageSchemaCategory = ..MessageSchemaCategory" _ nl
    set source = source _ "    set ..Adapter.AckMode = ..AckMode" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    // OnProcessInput
    set source = source _ "/// Process each inbound HL7 message." _ nl
    set source = source _ "Method OnProcessInput(pInput As EnsLib.HL7.Message, Output pOutput As EnsLib.HL7.Message) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        $$$LOGINFO(""Received HL7 message: "" _ pInput.GetValueAt(""MSH:9.1"") _ ""^"" _ pInput.GetValueAt(""MSH:9.2""))" _ nl
    set source = source _ "        " _ nl
    set source = source _ "        // Route to target process/router" _ nl
    set source = source _ "        set tSC = ..SendRequestSync(..TargetConfigName, pInput, .pOutput)" _ nl
    set source = source _ "        if $$$ISERR(tSC) {" _ nl
    set source = source _ "            $$$LOGERROR(""Failed to send to "" _ ..TargetConfigName _ "": "" _ $system.Status.GetErrorText(tSC))" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "        $$$LOGERROR(""Exception in OnProcessInput: "" _ ex.DisplayString())" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

<Method name="GenerateHTTP">
<Description>Generate an HTTP-based Business Service for REST inbound.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,targetProcess:%String,contentType:%String=&quot;application/json&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessService" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HTTP.InboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""TargetConfigName:Basic,Port:Basic"";" _ nl _ nl

    set source = source _ "Property TargetConfigName As %String(MAXLEN = 256) [ InitialExpression = """ _ targetProcess _ """ ];" _ nl _ nl

    set source = source _ "Method OnProcessInput(pInput As %Stream.Object, Output pOutput As %Stream.Object) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        // Create request from HTTP body" _ nl
    set source = source _ "        set tRequest = ##class(Ens.StreamContainer).%New(pInput)" _ nl
    set source = source _ "        set tSC = ..SendRequestSync(..TargetConfigName, tRequest, .tResponse)" _ nl
    set source = source _ "        if $$$ISERR(tSC) {" _ nl
    set source = source _ "            $$$LOGERROR(""Send failed: "" _ $system.Status.GetErrorText(tSC))" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl
    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

<Method name="GenerateFile">
<Description>Generate a File-based Business Service for reading files from a directory.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,targetProcess:%String,filePath:%String,fileSpec:%String=&quot;*.hl7&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessService" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HL7.Adapter.FileInboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""TargetConfigName:Basic,FilePath:Basic,FileSpec:Basic"";" _ nl _ nl

    set source = source _ "Property TargetConfigName As %String(MAXLEN = 256) [ InitialExpression = """ _ targetProcess _ """ ];" _ nl _ nl
    set source = source _ "Property FilePath As %String(MAXLEN = 1024) [ InitialExpression = """ _ filePath _ """ ];" _ nl _ nl
    set source = source _ "Property FileSpec As %String(MAXLEN = 128) [ InitialExpression = """ _ fileSpec _ """ ];" _ nl _ nl

    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.FilePath = ..FilePath" _ nl
    set source = source _ "    set ..Adapter.FileSpec = ..FileSpec" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "Method OnProcessInput(pInput As EnsLib.HL7.Message, Output pOutput As EnsLib.HL7.Message) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        $$$LOGINFO(""Processing file HL7: "" _ pInput.GetValueAt(""MSH:9""))" _ nl
    set source = source _ "        set tSC = ..SendRequestSync(..TargetConfigName, pInput, .pOutput)" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl
    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Templates.BusinessProcess">
<Description>Template generator for Business Process classes (BPL and code-based).
Produces compilable ObjectScript for message routing and orchestration.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%RegisteredObject</Super>
<Method name="GenerateBPL">
<Description>Generate a BPL (Business Process Language) process class.
BPL processes are XML-defined workflows ideal for routing, transformation, and orchestration.
&lt;p&gt;Parameters:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;className - Fully qualified class name&lt;/li&gt;
&lt;li&gt;description - Human-readable purpose&lt;/li&gt;
&lt;li&gt;requestType - Input message class (e.g., &quot;EnsLib.HL7.Message&quot;)&lt;/li&gt;
&lt;li&gt;responseType - Output message class (e.g., &quot;EnsLib.HL7.Message&quot;)&lt;/li&gt;
&lt;li&gt;targets - $ListBuild of target business host names to route to&lt;/li&gt;
&lt;li&gt;transformNames - $ListBuild of DTL transform class names (parallel to targets, &quot;&quot; for no transform)&lt;/li&gt;
&lt;/ul&gt;</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,requestType:%String=&quot;EnsLib.HL7.Message&quot;,responseType:%String=&quot;EnsLib.HL7.Message&quot;,targets:%List=&quot;&quot;,transformNames:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessProcessBPL" _ nl
    set source = source _ "{" _ nl _ nl

    // XData BPL block
    set source = source _ "XData BPL [ XMLNamespace = ""http://www.intersystems.com/bpl"" ]" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<process language='objectscript' request='" _ requestType _ "' response='" _ responseType _ "'>" _ nl
    set source = source _ "<context>" _ nl
    set source = source _ "  <property name='ErrorCount' type='%Integer' initialexpression='0' />" _ nl
    set source = source _ "</context>" _ nl
    set source = source _ "<sequence>" _ nl _ nl

    // Trace entry
    set source = source _ "  <trace value='""Process started: "" _ request.GetValueAt(""MSH:9"")' />" _ nl _ nl

    // Generate a call+transform for each target
    set targetCount = $ll(targets)
    for i = 1:1:targetCount {
        set target = $lg(targets, i)
        set transform = $lg(transformNames, i)
        if target = "" continue

        if transform '= "" {
            // Transform then send
            set source = source _ "  <!-- Transform and send to " _ target _ " -->" _ nl
            set source = source _ "  <transform class='" _ transform _ "' source='request' target='request' />" _ nl
        }
        set source = source _ "  <call name='" _ target _ "' target='" _ target _ "' async='1'>" _ nl
        set source = source _ "    <request type='" _ requestType _ "' actions='set callrequest=request' />" _ nl
        set source = source _ "    <response type='" _ responseType _ "' actions='set response=callresponse' />" _ nl
        set source = source _ "  </call>" _ nl _ nl
    }

    // If no targets were provided, generate a placeholder
    if targetCount = 0 {
        set source = source _ "  <!-- TODO: Add routing targets -->" _ nl
        set source = source _ "  <trace value='""No targets configured — message will not be forwarded""' />" _ nl _ nl
    }

    set source = source _ "  <trace value='""Process complete""' />" _ nl
    set source = source _ "</sequence>" _ nl
    set source = source _ "</process>" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

<Method name="GenerateCode">
<Description>Generate a code-based Business Process (non-BPL) with OnRequest/OnResponse.
Use this when the process logic is too complex for BPL (loops, dynamic routing, etc.).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,requestType:%String=&quot;EnsLib.HL7.Message&quot;,responseType:%String=&quot;EnsLib.HL7.Message&quot;,targets:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessProcess" _ nl
    set source = source _ "{" _ nl _ nl

    // SETTINGS for target config names
    set targetCount = $ll(targets)
    set settingsList = ""
    for i = 1:1:targetCount {
        set target = $lg(targets, i)
        if target = "" continue
        set prop = "Target" _ i
        set source = source _ "Property " _ prop _ " As %String(MAXLEN = 256) [ InitialExpression = """ _ target _ """ ];" _ nl
        set settingsList = settingsList _ $s(settingsList'="":",",1:"") _ prop _ ":Basic"
    }
    if settingsList '= "" {
        set source = source _ nl _ "Parameter SETTINGS = """ _ settingsList _ """;" _ nl
    }
    set source = source _ nl

    // OnRequest
    set source = source _ "/// Handle inbound request." _ nl
    set source = source _ "Method OnRequest(pRequest As " _ requestType _ ", Output pResponse As " _ responseType _ ") As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        $$$LOGINFO(""Processing: "" _ pRequest.GetValueAt(""MSH:9.1"") _ ""^"" _ pRequest.GetValueAt(""MSH:9.2""))" _ nl _ nl

    for i = 1:1:targetCount {
        set target = $lg(targets, i)
        if target = "" continue
        set prop = "Target" _ i
        set source = source _ "        // Send to " _ target _ nl
        set source = source _ "        set tSC = ..SendRequestAsync(.." _ prop _ ", pRequest)" _ nl
        set source = source _ "        if $$$ISERR(tSC) {" _ nl
        set source = source _ "            $$$LOGERROR(""Send to " _ target _ " failed: "" _ $system.Status.GetErrorText(tSC))" _ nl
        set source = source _ "        }" _ nl _ nl
    }

    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "        $$$LOGERROR(""Exception: "" _ ex.DisplayString())" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    // OnResponse
    set source = source _ "/// Handle responses from downstream operations." _ nl
    set source = source _ "Method OnResponse(pRequest As %Library.Persistent, ByRef pResponse As %Library.Persistent, pCallRequest As %Library.Persistent, pCallResponse As %Library.Persistent, pCompletionKey As %String) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

<Method name="GenerateRouterConfig">
<Description>Generate an HL7 Message Router (uses EnsLib.HL7.MsgRouter.RoutingEngine).
This doesn't generate a class but rather the production configuration for a router.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>routerName:%String,description:%String,schemaCategory:%String=&quot;2.4&quot;,ruleClass:%String=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "// Production host configuration for HL7 Router: " _ routerName _ nl
    set source = source _ "// " _ description _ nl
    set source = source _ "//" _ nl
    set source = source _ "// Add to production via Management Portal or Ens.Director:" _ nl
    set source = source _ "//" _ nl
    set source = source _ "// Class: EnsLib.HL7.MsgRouter.RoutingEngine" _ nl
    set source = source _ "// Name: " _ routerName _ nl
    set source = source _ "// Settings:" _ nl
    set source = source _ "//   BusinessRuleName = " _ ruleClass _ nl
    set source = source _ "//   MessageSchemaCategory = " _ schemaCategory _ nl
    set source = source _ "//   BadMessageHandler = (optional error handler)" _ nl
    set source = source _ "//   Validation = (optional validation level)" _ nl

    quit source
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Templates.BusinessOperation">
<Description>Template generator for Business Operation classes.
Produces compilable ObjectScript for outbound HL7 TCP, HTTP, file, and email operations.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%RegisteredObject</Super>
<Method name="GenerateTCP">
<Description>Generate an HL7 TCP outbound Business Operation.
Sends HL7 messages to downstream systems over TCP.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,ipAddress:%String,port:%Integer,hl7Schema:%String=&quot;2.4&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessOperation" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HL7.Adapter.TCPOutboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""IPAddress:Basic,Port:Basic,MessageSchemaCategory:Basic,ReconnectRetry:Connection"";" _ nl _ nl
    set source = source _ "Parameter INVOCATION = ""Queue"";" _ nl _ nl

    set source = source _ "Property IPAddress As %String(MAXLEN = 256) [ InitialExpression = """ _ ipAddress _ """ ];" _ nl _ nl
    set source = source _ "Property Port As %Integer [ InitialExpression = " _ port _ " ];" _ nl _ nl
    set source = source _ "Property MessageSchemaCategory As %String [ InitialExpression = """ _ hl7Schema _ """ ];" _ nl _ nl
    set source = source _ "Property ReconnectRetry As %Integer [ InitialExpression = 5 ];" _ nl _ nl

    // OnInit
    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.IPAddress = ..IPAddress" _ nl
    set source = source _ "    set ..Adapter.Port = ..Port" _ nl
    set source = source _ "    set ..Adapter.MessageSchemaCategory = ..MessageSchemaCategory" _ nl
    set source = source _ "    set ..Adapter.ReconnectRetry = ..ReconnectRetry" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    // MessageMap
    set source = source _ "XData MessageMap" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<MapItems>" _ nl
    set source = source _ "  <MapItem MessageType=""EnsLib.HL7.Message"">" _ nl
    set source = source _ "    <Method>SendHL7Message</Method>" _ nl
    set source = source _ "  </MapItem>" _ nl
    set source = source _ "</MapItems>" _ nl
    set source = source _ "}" _ nl _ nl

    // Send method
    set source = source _ "/// Send HL7 message via TCP adapter." _ nl
    set source = source _ "Method SendHL7Message(pRequest As EnsLib.HL7.Message, Output pResponse As EnsLib.HL7.Message) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        $$$LOGINFO(""Sending "" _ pRequest.GetValueAt(""MSH:9"") _ "" to "" _ ..IPAddress _ "":"" _ ..Port)" _ nl
    set source = source _ "        set tSC = ..Adapter.SendMessageSync(pRequest, .pResponse)" _ nl
    set source = source _ "        if $$$ISERR(tSC) {" _ nl
    set source = source _ "            $$$LOGERROR(""TCP send failed: "" _ $system.Status.GetErrorText(tSC))" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "        $$$LOGERROR(""Exception: "" _ ex.DisplayString())" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
]]></Implementation>
</Method>

<Method name="GenerateHTTP">
<Description>Generate an HTTP outbound Business Operation.
Sends data to REST APIs or web services.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,httpServer:%String,httpPort:%Integer=443,urlPath:%String=&quot;/api&quot;,sslConfig:%String=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessOperation" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HTTP.OutboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""HTTPServer:Basic,HTTPPort:Basic,URL:Basic,SSLConfig:Connection"";" _ nl _ nl
    set source = source _ "Parameter INVOCATION = ""Queue"";" _ nl _ nl

    set source = source _ "Property HTTPServer As %String(MAXLEN = 256) [ InitialExpression = """ _ httpServer _ """ ];" _ nl _ nl
    set source = source _ "Property HTTPPort As %Integer [ InitialExpression = " _ httpPort _ " ];" _ nl _ nl
    set source = source _ "Property URL As %String(MAXLEN = 1024) [ InitialExpression = """ _ urlPath _ """ ];" _ nl _ nl
    if sslConfig '= "" {
        set source = source _ "Property SSLConfig As %String [ InitialExpression = """ _ sslConfig _ """ ];" _ nl _ nl
    }

    // OnInit
    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.HTTPServer = ..HTTPServer" _ nl
    set source = source _ "    set ..Adapter.HTTPPort = ..HTTPPort" _ nl
    set source = source _ "    set ..Adapter.URL = ..URL" _ nl
    if sslConfig '= "" {
        set source = source _ "    set ..Adapter.SSLConfig = ..SSLConfig" _ nl
    }
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    // MessageMap
    set source = source _ "XData MessageMap" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<MapItems>" _ nl
    set source = source _ "  <MapItem MessageType=""Ens.StreamContainer"">" _ nl
    set source = source _ "    <Method>SendHTTPRequest</Method>" _ nl
    set source = source _ "  </MapItem>" _ nl
    set source = source _ "</MapItems>" _ nl
    set source = source _ "}" _ nl _ nl

    // Send method
    set source = source _ "/// Send HTTP POST request." _ nl
    set source = source _ "Method SendHTTPRequest(pRequest As Ens.StreamContainer, Output pResponse As %Net.HttpResponse) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        set tHttpRequest = ##class(%Net.HttpRequest).%New()" _ nl
    set source = source _ "        set tHttpRequest.ContentType = ""application/json""" _ nl
    set source = source _ "        do tHttpRequest.EntityBody.CopyFrom(pRequest.Stream)" _ nl
    set source = source _ "        set tSC = ..Adapter.SendFormDataArray(.tHttpResponse, ""POST"", tHttpRequest)" _ nl
    set source = source _ "        if $$$ISERR(tSC) {" _ nl
    set source = source _ "            $$$LOGERROR(""HTTP send failed: "" _ $system.Status.GetErrorText(tSC))" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "        set pResponse = tHttpResponse" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
]]></Implementation>
</Method>

<Method name="GenerateFile">
<Description>Generate a File outbound Business Operation.
Writes messages or data to files in a directory.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,filePath:%String,fileExtension:%String=&quot;.hl7&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessOperation" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HL7.Adapter.FileOutboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""FilePath:Basic,FileExtension:Basic"";" _ nl _ nl
    set source = source _ "Parameter INVOCATION = ""Queue"";" _ nl _ nl

    set source = source _ "Property FilePath As %String(MAXLEN = 1024) [ InitialExpression = """ _ filePath _ """ ];" _ nl _ nl
    set source = source _ "Property FileExtension As %String [ InitialExpression = """ _ fileExtension _ """ ];" _ nl _ nl

    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.FilePath = ..FilePath" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    // MessageMap
    set source = source _ "XData MessageMap" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<MapItems>" _ nl
    set source = source _ "  <MapItem MessageType=""EnsLib.HL7.Message"">" _ nl
    set source = source _ "    <Method>WriteHL7ToFile</Method>" _ nl
    set source = source _ "  </MapItem>" _ nl
    set source = source _ "</MapItems>" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "Method WriteHL7ToFile(pRequest As EnsLib.HL7.Message, Output pResponse As Ens.Response) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        set tFilename = $tr($zdt($h,3),"" :"",""-"") _ ""_"" _ pRequest.GetValueAt(""MSH:9.1"") _ ..FileExtension" _ nl
    set source = source _ "        $$$LOGINFO(""Writing to file: "" _ tFilename)" _ nl
    set source = source _ "        set tSC = ..Adapter.PutLine(..FilePath _ ""/"" _ tFilename, pRequest.OutputToString())" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
]]></Implementation>
</Method>

<Method name="GenerateEmail">
<Description>Generate an Email notification Business Operation.
Sends email alerts via SMTP.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,smtpServer:%String,fromAddress:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessOperation" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.EMail.OutboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""SMTPServer:Basic,From:Basic,SSLConfig:Connection"";" _ nl _ nl
    set source = source _ "Parameter INVOCATION = ""Queue"";" _ nl _ nl

    set source = source _ "Property SMTPServer As %String(MAXLEN = 256) [ InitialExpression = """ _ smtpServer _ """ ];" _ nl _ nl
    set source = source _ "Property From As %String(MAXLEN = 256) [ InitialExpression = """ _ fromAddress _ """ ];" _ nl _ nl

    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.SMTPServer = ..SMTPServer" _ nl
    set source = source _ "    set ..Adapter.From = ..From" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "XData MessageMap" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<MapItems>" _ nl
    set source = source _ "  <MapItem MessageType=""Ens.AlertRequest"">" _ nl
    set source = source _ "    <Method>SendAlert</Method>" _ nl
    set source = source _ "  </MapItem>" _ nl
    set source = source _ "</MapItems>" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "/// Send alert email notification." _ nl
    set source = source _ "Method SendAlert(pRequest As Ens.AlertRequest, Output pResponse As Ens.Response) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        set tMailMsg = ##class(%Net.MailMessage).%New()" _ nl
    set source = source _ "        set tMailMsg.From = ..From" _ nl
    set source = source _ "        set tMailMsg.Subject = ""IRIS Alert: "" _ pRequest.AlertText" _ nl
    set source = source _ "        set tMailMsg.IsHTML = 0" _ nl
    set source = source _ "        do tMailMsg.TextData.Write(""Alert from: "" _ pRequest.SourceConfigName _ $c(13,10))" _ nl
    set source = source _ "        do tMailMsg.TextData.Write(""Time: "" _ $zdt($h, 3) _ $c(13,10))" _ nl
    set source = source _ "        do tMailMsg.TextData.Write(""Details: "" _ pRequest.AlertText)" _ nl
    set source = source _ "        set tSC = ..Adapter.SendMail(tMailMsg)" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Templates.DataTransformation">
<Description>Template generator for Data Transformation (DTL) classes.
Produces compilable ObjectScript DTL XML definitions for HL7 message transformations.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%RegisteredObject</Super>
<Method name="GenerateHL7">
<Description>Generate an HL7-to-HL7 DTL transformation class.
&lt;p&gt;Parameters:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;className - Fully qualified class name&lt;/li&gt;
&lt;li&gt;description - Human-readable purpose&lt;/li&gt;
&lt;li&gt;sourceDocType - Source HL7 DocType (e.g., &quot;2.4:ADT_A01&quot;)&lt;/li&gt;
&lt;li&gt;targetDocType - Target HL7 DocType (e.g., &quot;2.4:ADT_A01&quot;)&lt;/li&gt;
&lt;li&gt;fieldMappings - $ListBuild of &quot;sourceField=targetField&quot; pairs (e.g., &quot;PID:3.1=PID:3.1&quot;)&lt;/li&gt;
&lt;li&gt;setValues - $ListBuild of &quot;field=value&quot; pairs for hardcoded values (e.g., &quot;MSH:3.1=IRIS&quot;)&lt;/li&gt;
&lt;/ul&gt;</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,sourceDocType:%String=&quot;2.4:ADT_A01&quot;,targetDocType:%String=&quot;2.4:ADT_A01&quot;,fieldMappings:%List=&quot;&quot;,setValues:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.DataTransformDTL [ DependsOn = (EnsLib.HL7.Message) ]" _ nl
    set source = source _ "{" _ nl _ nl

    // Parameters
    set source = source _ "Parameter IGNOREMISSINGSOURCE = 1;" _ nl
    set source = source _ "Parameter REPORTERRORS = 1;" _ nl
    set source = source _ "Parameter TREATEMPTYREPEATINGFIELDASNULL = 0;" _ nl _ nl

    // XData DTL block
    set source = source _ "XData DTL [ XMLNamespace = ""http://www.intersystems.com/dtl"" ]" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<transform sourceClass='EnsLib.HL7.Message' targetClass='EnsLib.HL7.Message'"
    set source = source _ " sourceDocType='" _ sourceDocType _ "' targetDocType='" _ targetDocType _ "'"
    set source = source _ " create='copy' language='objectscript'>" _ nl _ nl

    // Comment
    set source = source _ "  <!-- " _ description _ " -->" _ nl _ nl

    // Field mappings (source -> target)
    set mapCount = $ll(fieldMappings)
    if mapCount > 0 {
        set source = source _ "  <!-- Field Mappings -->" _ nl
        for i = 1:1:mapCount {
            set mapping = $lg(fieldMappings, i)
            set srcField = $p(mapping, "=", 1)
            set tgtField = $p(mapping, "=", 2)
            if (srcField '= "") && (tgtField '= "") {
                set source = source _ "  <assign value='source.{" _ srcField _ "}' property='target.{" _ tgtField _ "}' action='set' />" _ nl
            }
        }
        set source = source _ nl
    }

    // Hardcoded set values
    set setCount = $ll(setValues)
    if setCount > 0 {
        set source = source _ "  <!-- Static Values -->" _ nl
        for i = 1:1:setCount {
            set setValue = $lg(setValues, i)
            set field = $p(setValue, "=", 1)
            set value = $p(setValue, "=", 2, 999)
            if (field '= "") && (value '= "") {
                set source = source _ "  <assign value='""" _ value _ """' property='target.{" _ field _ "}' action='set' />" _ nl
            }
        }
        set source = source _ nl
    }

    // If no mappings, add copy-all comment
    if (mapCount = 0) && (setCount = 0) {
        set source = source _ "  <!-- Using create='copy' — all segments are copied from source to target -->" _ nl
        set source = source _ "  <!-- Add specific field overrides below -->" _ nl _ nl
        set source = source _ "  <!-- Example: set target MSH:3 (Sending Application) -->" _ nl
        set source = source _ "  <!-- <assign value='""IRIS""' property='target.{MSH:3.1}' action='set' /> -->" _ nl _ nl
    }

    set source = source _ "</transform>" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

<Method name="GenerateHL7ToObject">
<Description>Generate an HL7-to-Object DTL (e.g., HL7 -&gt; FHIR or custom class).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,sourceDocType:%String=&quot;2.4:ADT_A01&quot;,targetClass:%String=&quot;Ens.Request&quot;,fieldMappings:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.DataTransformDTL [ DependsOn = (EnsLib.HL7.Message, " _ targetClass _ ") ]" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter IGNOREMISSINGSOURCE = 1;" _ nl
    set source = source _ "Parameter REPORTERRORS = 1;" _ nl _ nl

    set source = source _ "XData DTL [ XMLNamespace = ""http://www.intersystems.com/dtl"" ]" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<transform sourceClass='EnsLib.HL7.Message' targetClass='" _ targetClass _ "'"
    set source = source _ " sourceDocType='" _ sourceDocType _ "'"
    set source = source _ " create='new' language='objectscript'>" _ nl _ nl

    // Field mappings
    set mapCount = $ll(fieldMappings)
    if mapCount > 0 {
        for i = 1:1:mapCount {
            set mapping = $lg(fieldMappings, i)
            set srcField = $p(mapping, "=", 1)
            set tgtProp = $p(mapping, "=", 2)
            if (srcField '= "") && (tgtProp '= "") {
                set source = source _ "  <assign value='source.{" _ srcField _ "}' property='target." _ tgtProp _ "' action='set' />" _ nl
            }
        }
    } else {
        set source = source _ "  <!-- Map HL7 fields to object properties -->" _ nl
        set source = source _ "  <!-- <assign value='source.{PID:3.1}' property='target.MRN' action='set' /> -->" _ nl
    }

    set source = source _ nl _ "</transform>" _ nl
    set source = source _ "}" _ nl _ nl
    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

<Method name="GenerateCodeTransform">
<Description>Generate a code-based (non-DTL) transformation class.
Use when transformation logic is too complex for DTL XML (lookups, conditionals, loops).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,sourceType:%String=&quot;EnsLib.HL7.Message&quot;,targetType:%String=&quot;EnsLib.HL7.Message&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Code-based transformation (non-DTL) for complex logic." _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.DataTransform" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "ClassMethod Transform(source As " _ sourceType _ ", ByRef target As " _ targetType _ ") As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        // Create target as copy of source" _ nl
    set source = source _ "        set target = source.%ConstructClone()" _ nl _ nl
    set source = source _ "        // --- Add transformation logic here ---" _ nl _ nl
    set source = source _ "        // Example: Update sending application" _ nl
    set source = source _ "        // do target.SetValueAt(""IRIS"", ""MSH:3.1"")" _ nl _ nl
    set source = source _ "        // Example: Lookup table reference" _ nl
    set source = source _ "        // set mappedValue = ##class(Ens.Util.FunctionSet).Lookup(""MyTable"", source.GetValueAt(""PID:3.1""), """")" _ nl _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "        $$$LOGERROR(""Transform error: "" _ ex.DisplayString())" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Templates.RoutingRule">
<Description>Template generator for Business Routing Rule classes.
Produces compilable ObjectScript rule definitions used by EnsLib.HL7.MsgRouter.RoutingEngine.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%RegisteredObject</Super>
<Method name="Generate">
<Description>Generate a routing rule class with message-type-based routing.
&lt;p&gt;Parameters:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;className - Fully qualified class name&lt;/li&gt;
&lt;li&gt;description - Human-readable purpose&lt;/li&gt;
&lt;li&gt;rules - $ListBuild of rule specs, each formatted as &quot;condition|target|transform|enabled&quot;
where condition is an HL7 expression (e.g., &quot;HL7.{MSH:9.1}=&quot;&quot;ADT&quot;&quot;&quot;),
target is the business host name, transform is DTL class (or &quot;&quot;), enabled is &quot;1&quot;/&quot;0&quot;&lt;/li&gt;
&lt;/ul&gt;</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,rules:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.Rule.Definition" _ nl
    set source = source _ "{" _ nl _ nl

    // XData RuleDefinition
    set source = source _ "XData RuleDefinition [ XMLNamespace = ""http://www.intersystems.com/rule"" ]" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<ruleDefinition>" _ nl
    set source = source _ "<ruleset>" _ nl _ nl

    // Generate rules
    set ruleCount = $ll(rules)
    if ruleCount > 0 {
        for i = 1:1:ruleCount {
            set ruleSpec = $lg(rules, i)
            set condition = $p(ruleSpec, "|", 1)
            set target = $p(ruleSpec, "|", 2)
            set transform = $p(ruleSpec, "|", 3)
            set enabled = $p(ruleSpec, "|", 4)
            if enabled = "" set enabled = "1"

            set source = source _ "  <rule name='Rule" _ i _ "' disabled='" _ $s(enabled="1":"false",1:"true") _ "'>" _ nl

            // Condition (when clause)
            if condition '= "" {
                set source = source _ "    <when condition='" _ $zcvt(condition, "O", "XML") _ "'>" _ nl
            } else {
                set source = source _ "    <when condition='1'>" _ nl
            }

            // Send action
            if transform '= "" {
                set source = source _ "      <send transform='" _ transform _ "' target='" _ target _ "' />" _ nl
            } else {
                set source = source _ "      <send target='" _ target _ "' />" _ nl
            }

            set source = source _ "    </when>" _ nl
            set source = source _ "  </rule>" _ nl _ nl
        }
    } else {
        // Generate example rules
        set source = source _ "  <!-- Example: Route ADT messages -->" _ nl
        set source = source _ "  <rule name='RouteADT'>" _ nl
        set source = source _ "    <when condition='HL7.{MSH:9.1}=""ADT""'>" _ nl
        set source = source _ "      <send target='TargetOperationName' />" _ nl
        set source = source _ "    </when>" _ nl
        set source = source _ "  </rule>" _ nl _ nl
        set source = source _ "  <!-- Example: Route ORM messages with transform -->" _ nl
        set source = source _ "  <rule name='RouteORM'>" _ nl
        set source = source _ "    <when condition='HL7.{MSH:9.1}=""ORM""'>" _ nl
        set source = source _ "      <send transform='My.DTL.Transform' target='TargetOperationName' />" _ nl
        set source = source _ "    </when>" _ nl
        set source = source _ "  </rule>" _ nl _ nl
    }

    set source = source _ "</ruleset>" _ nl
    set source = source _ "</ruleDefinition>" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

<Method name="GenerateBradfordStandard">
<Description>Generate a routing rule with common Bradford TIE patterns.
Pre-fills rules for ADT, ORM, ORU, RDE message type routing.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,adtTarget:%String=&quot;&quot;,ormTarget:%String=&quot;&quot;,oruTarget:%String=&quot;&quot;,rdeTarget:%String=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set rules = ""

    if adtTarget '= "" {
        set rules = rules _ $lb("HL7.{MSH:9.1}=""ADT""|" _ adtTarget _ "||1")
    }
    if ormTarget '= "" {
        set rules = rules _ $lb("HL7.{MSH:9.1}=""ORM""|" _ ormTarget _ "||1")
    }
    if oruTarget '= "" {
        set rules = rules _ $lb("HL7.{MSH:9.1}=""ORU""|" _ oruTarget _ "||1")
    }
    if rdeTarget '= "" {
        set rules = rules _ $lb("HL7.{MSH:9.1}=""RDE""|" _ rdeTarget _ "||1")
    }

    quit ..Generate(className, description, rules)
]]></Implementation>
</Method>

<Method name="GenerateContentBased">
<Description>Generate a content-based routing rule that checks specific HL7 field values.
Useful for routing based on patient location, ordering facility, etc.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,fieldPath:%String,valueTargetPairs:%List</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set rules = ""
    set pairCount = $ll(valueTargetPairs)

    for i = 1:1:pairCount {
        set pair = $lg(valueTargetPairs, i)
        set value = $p(pair, "=", 1)
        set target = $p(pair, "=", 2)
        if (value '= "") && (target '= "") {
            set condition = "HL7.{" _ fieldPath _ "}=""" _ value _ """"
            set rules = rules _ $lb(condition _ "|" _ target _ "||1")
        }
    }

    quit ..Generate(className, description, rules)
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Templates.MessageClass">
<Description>Template generator for persistent Message classes (Request/Response).
Produces compilable ObjectScript for custom message objects used between production hosts.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%RegisteredObject</Super>
<Method name="GenerateRequest">
<Description>Generate a persistent Request message class.
&lt;p&gt;Parameters:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;className - Fully qualified class name&lt;/li&gt;
&lt;li&gt;description - Human-readable purpose&lt;/li&gt;
&lt;li&gt;properties - $ListBuild of &quot;name:type:maxlen:description&quot; specs
(e.g., &quot;PatientMRN:%String:64:Patient MRN from PID:3.1&quot;)&lt;/li&gt;
&lt;/ul&gt;</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,properties:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    quit ..GenerateMessage(className, description, "Ens.Request", properties)
]]></Implementation>
</Method>

<Method name="GenerateResponse">
<Description>Generate a persistent Response message class.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,properties:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    quit ..GenerateMessage(className, description, "Ens.Response", properties)
]]></Implementation>
</Method>

<Method name="GenerateMessage">
<Description>Generate a persistent message class (base for Request and Response).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,superClass:%String,properties:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends " _ superClass _ nl
    set source = source _ "{" _ nl _ nl

    // Generate properties
    set propCount = $ll(properties)
    for i = 1:1:propCount {
        set propSpec = $lg(properties, i)
        set propName = $p(propSpec, ":", 1)
        set propType = $p(propSpec, ":", 2)
        set propMaxLen = $p(propSpec, ":", 3)
        set propDesc = $p(propSpec, ":", 4, 999)

        if propName = "" continue
        if propType = "" set propType = "%String"
        if propMaxLen = "" set propMaxLen = "256"

        if propDesc '= "" {
            set source = source _ "/// " _ propDesc _ nl
        }

        // Build type with parameters
        if propType = "%String" {
            set source = source _ "Property " _ propName _ " As %String(MAXLEN = " _ propMaxLen _ ");" _ nl _ nl
        } elseif propType = "%Stream.GlobalCharacter" {
            set source = source _ "Property " _ propName _ " As %Stream.GlobalCharacter;" _ nl _ nl
        } else {
            set source = source _ "Property " _ propName _ " As " _ propType _ ";" _ nl _ nl
        }
    }

    // If no properties, add example placeholder
    if propCount = 0 {
        set source = source _ "/// Patient MRN" _ nl
        set source = source _ "Property PatientMRN As %String(MAXLEN = 64);" _ nl _ nl
        set source = source _ "/// Patient Name" _ nl
        set source = source _ "Property PatientName As %String(MAXLEN = 256);" _ nl _ nl
    }

    // Storage
    set storageName = $tr(className, ".", "")
    set source = source _ "Storage Default" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<Type>%Storage.Persistent</Type>" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
]]></Implementation>
</Method>

<Method name="GeneratePair">
<Description>Generate a pair of Request/Response classes for a specific use case.
Returns a $ListBuild of two items: (requestSource, responseSource).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>baseClassName:%String,description:%String,requestProps:%List=&quot;&quot;,responseProps:%List=&quot;&quot;</FormalSpec>
<ReturnType>%List</ReturnType>
<Implementation><![CDATA[
    set reqClass = baseClassName _ "Request"
    set respClass = baseClassName _ "Response"
    set reqSource = ..GenerateRequest(reqClass, description _ " - Request message.", requestProps)
    set respSource = ..GenerateResponse(respClass, description _ " - Response message.", responseProps)
    quit $lb(reqSource, respSource)
]]></Implementation>
</Method>

<Method name="GenerateComplex">
<Description>Generate a complex message class with nested objects (for rich data).</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,description:%String,superClass:%String=&quot;Ens.Request&quot;,sections:%List=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Complex message with structured data sections." _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends " _ superClass _ nl
    set source = source _ "{" _ nl _ nl

    // Timestamp
    set source = source _ "/// Timestamp when this message was created." _ nl
    set source = source _ "Property Timestamp As %TimeStamp [ InitialExpression = {$zdt($h, 3)} ];" _ nl _ nl

    // Source system
    set source = source _ "/// Source system identifier." _ nl
    set source = source _ "Property SourceSystem As %String(MAXLEN = 128);" _ nl _ nl

    // Add sections as stream properties
    set sectionCount = $ll(sections)
    for i = 1:1:sectionCount {
        set sectionName = $lg(sections, i)
        if sectionName '= "" {
            set source = source _ "/// " _ sectionName _ " data section (JSON stream)." _ nl
            set source = source _ "Property " _ sectionName _ " As %Stream.GlobalCharacter;" _ nl _ nl
        }
    }

    // Utility method: set section from dynamic object
    set source = source _ "/// Set a section's data from a %DynamicObject." _ nl
    set source = source _ "Method SetSectionData(sectionName As %String, data As %DynamicObject) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        set tProp = $property($this, sectionName)" _ nl
    set source = source _ "        if '$isobject(tProp) {" _ nl
    set source = source _ "            set tProp = ##class(%Stream.GlobalCharacter).%New()" _ nl
    set source = source _ "            set $property($this, sectionName) = tProp" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "        do tProp.Clear()" _ nl
    set source = source _ "        do tProp.Write(data.%ToJSON())" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    // Storage
    set source = source _ "Storage Default" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<Type>%Storage.Persistent</Type>" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.Templates.Factory">
<Description>Template Factory: unified entry point for all COS template generators.
The AI orchestrator calls this class to generate structurally correct ObjectScript
scaffolding for any component type. AI fills in the business logic; templates ensure
the class structure is always valid and compilable.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%RegisteredObject</Super>
<Method name="Generate">
<Description>Generate a COS class from a template, based on component type.
&lt;p&gt;Parameters:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;componentType - One of: BusinessService, BusinessProcess, BusinessOperation,
DataTransformation, RoutingRule, RequestMessage, ResponseMessage&lt;/li&gt;
&lt;li&gt;spec - %DynamicObject with component-specific parameters.
Common fields: className, description.
Type-specific fields vary (see individual template classes).&lt;/li&gt;
&lt;/ul&gt;
Returns the generated ObjectScript source as a string.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>componentType:%String,spec:%DynamicObject</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set className = spec.className
    set description = spec.%Get("description", "Generated by IRIS Copilot")

    if componentType = "BusinessService" {
        // Determine adapter type
        set adapterType = spec.%Get("adapterType", "TCP")
        if adapterType = "HTTP" {
            quit ##class(AIAgent.Templates.BusinessService).GenerateHTTP(
                className, description,
                spec.%Get("targetProcess", ""))
        }
        elseif adapterType = "File" {
            quit ##class(AIAgent.Templates.BusinessService).GenerateFile(
                className, description,
                spec.%Get("targetProcess", ""),
                spec.%Get("filePath", ""),
                spec.%Get("fileSpec", "*.hl7"))
        }
        else {
            // Default: TCP HL7
            quit ##class(AIAgent.Templates.BusinessService).Generate(
                className, description,
                +spec.%Get("port", 0),
                spec.%Get("targetProcess", ""),
                spec.%Get("hl7Schema", "2.4"),
                spec.%Get("ackMode", "Application"))
        }
    }

    if componentType = "BusinessProcess" {
        set processType = spec.%Get("processType", "BPL")
        // Convert targets JSON array to $ListBuild
        set targets = ..JSONArrayToList(spec.%Get("targets"))
        set transforms = ..JSONArrayToList(spec.%Get("transforms"))
        if processType = "Code" {
            quit ##class(AIAgent.Templates.BusinessProcess).GenerateCode(
                className, description,
                spec.%Get("requestType", "EnsLib.HL7.Message"),
                spec.%Get("responseType", "EnsLib.HL7.Message"),
                targets)
        }
        else {
            quit ##class(AIAgent.Templates.BusinessProcess).GenerateBPL(
                className, description,
                spec.%Get("requestType", "EnsLib.HL7.Message"),
                spec.%Get("responseType", "EnsLib.HL7.Message"),
                targets, transforms)
        }
    }

    if componentType = "BusinessOperation" {
        set adapterType = spec.%Get("adapterType", "TCP")
        if adapterType = "HTTP" {
            quit ##class(AIAgent.Templates.BusinessOperation).GenerateHTTP(
                className, description,
                spec.%Get("httpServer", ""),
                +spec.%Get("httpPort", 443),
                spec.%Get("urlPath", "/api"),
                spec.%Get("sslConfig", ""))
        }
        elseif adapterType = "File" {
            quit ##class(AIAgent.Templates.BusinessOperation).GenerateFile(
                className, description,
                spec.%Get("filePath", ""),
                spec.%Get("fileExtension", ".hl7"))
        }
        elseif adapterType = "Email" {
            quit ##class(AIAgent.Templates.BusinessOperation).GenerateEmail(
                className, description,
                spec.%Get("smtpServer", ""),
                spec.%Get("fromAddress", ""))
        }
        else {
            quit ##class(AIAgent.Templates.BusinessOperation).GenerateTCP(
                className, description,
                spec.%Get("ipAddress", ""),
                +spec.%Get("port", 0),
                spec.%Get("hl7Schema", "2.4"))
        }
    }

    if componentType = "DataTransformation" {
        set dtlType = spec.%Get("dtlType", "HL7")
        set fieldMappings = ..JSONArrayToList(spec.%Get("fieldMappings"))
        if dtlType = "HL7ToObject" {
            quit ##class(AIAgent.Templates.DataTransformation).GenerateHL7ToObject(
                className, description,
                spec.%Get("sourceDocType", "2.4:ADT_A01"),
                spec.%Get("targetClass", "Ens.Request"),
                fieldMappings)
        }
        elseif dtlType = "Code" {
            quit ##class(AIAgent.Templates.DataTransformation).GenerateCodeTransform(
                className, description,
                spec.%Get("sourceType", "EnsLib.HL7.Message"),
                spec.%Get("targetType", "EnsLib.HL7.Message"))
        }
        else {
            set setValues = ..JSONArrayToList(spec.%Get("setValues"))
            quit ##class(AIAgent.Templates.DataTransformation).GenerateHL7(
                className, description,
                spec.%Get("sourceDocType", "2.4:ADT_A01"),
                spec.%Get("targetDocType", "2.4:ADT_A01"),
                fieldMappings, setValues)
        }
    }

    if componentType = "RoutingRule" {
        set rules = ..JSONArrayToList(spec.%Get("rules"))
        if rules '= "" {
            quit ##class(AIAgent.Templates.RoutingRule).Generate(className, description, rules)
        }
        // Try Bradford standard pattern
        quit ##class(AIAgent.Templates.RoutingRule).GenerateBradfordStandard(
            className, description,
            spec.%Get("adtTarget", ""),
            spec.%Get("ormTarget", ""),
            spec.%Get("oruTarget", ""),
            spec.%Get("rdeTarget", ""))
    }

    if componentType = "RequestMessage" {
        set properties = ..JSONArrayToList(spec.%Get("properties"))
        quit ##class(AIAgent.Templates.MessageClass).GenerateRequest(className, description, properties)
    }

    if componentType = "ResponseMessage" {
        set properties = ..JSONArrayToList(spec.%Get("properties"))
        quit ##class(AIAgent.Templates.MessageClass).GenerateResponse(className, description, properties)
    }

    // Unknown type — return error comment
    quit "// ERROR: Unknown component type: " _ componentType _ $c(13,10) _ "// Supported types: BusinessService, BusinessProcess, BusinessOperation, DataTransformation, RoutingRule, RequestMessage, ResponseMessage"
]]></Implementation>
</Method>

<Method name="ListComponentTypes">
<Description>List all supported component types and their parameters.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicArray</ReturnType>
<Implementation><![CDATA[
    set types = []
    do types.%Push(..TypeInfo("BusinessService", "Inbound HL7/HTTP/File listener", "port,targetProcess,hl7Schema,ackMode,adapterType(TCP|HTTP|File),filePath,fileSpec"))
    do types.%Push(..TypeInfo("BusinessProcess", "Message orchestration (BPL or code)", "processType(BPL|Code),requestType,responseType,targets[],transforms[]"))
    do types.%Push(..TypeInfo("BusinessOperation", "Outbound TCP/HTTP/File/Email sender", "adapterType(TCP|HTTP|File|Email),ipAddress,port,hl7Schema,httpServer,httpPort,urlPath,sslConfig,filePath,smtpServer,fromAddress"))
    do types.%Push(..TypeInfo("DataTransformation", "HL7 field mapping (DTL or code)", "dtlType(HL7|HL7ToObject|Code),sourceDocType,targetDocType,fieldMappings[],setValues[],targetClass"))
    do types.%Push(..TypeInfo("RoutingRule", "Message routing rules", "rules[](condition|target|transform|enabled),adtTarget,ormTarget,oruTarget,rdeTarget"))
    do types.%Push(..TypeInfo("RequestMessage", "Persistent request message class", "properties[](name:type:maxlen:description)"))
    do types.%Push(..TypeInfo("ResponseMessage", "Persistent response message class", "properties[](name:type:maxlen:description)"))
    quit types
]]></Implementation>
</Method>

<Method name="TypeInfo">
<Description>Helper: build a type info object.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name:%String,description:%String,parameters:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set info = {}
    set info.name = name
    set info.description = description
    set info.parameters = parameters
    quit info
]]></Implementation>
</Method>

<Method name="JSONArrayToList">
<Description>Helper: convert a %DynamicArray to a $ListBuild.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>arr:%DynamicArray</FormalSpec>
<ReturnType>%List</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    if '$isobject(arr) quit ""
    set list = ""
    set iter = arr.%GetIterator()
    while iter.%GetNext(.key, .value) {
        set list = list _ $lb(value)
    }
    quit list
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.API.Dispatcher">
<Description>REST API Dispatcher for the IRIS AI Agent Platform (IRIS Copilot).
Serves as the single HTTP entry point for all client interactions.
Delegates to Engine classes for business logic and uses AIAgent.Util.JSON for response formatting.

Deployed as web application /ai via AIAgent.Install.Installer.

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Super>%CSP.REST</Super>
<Parameter name="CONTENTTYPE">
<Default>application/json</Default>
</Parameter>

<Parameter name="CHARSET">
<Default>utf-8</Default>
</Parameter>

<Parameter name="HandleCorsRequest">
<Default>1</Default>
</Parameter>

<Method name="OnHandleCorsRequest">
<Description>Handle CORS preflight and response headers.
Allows localhost (any port) and *.nhs.uk origins.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>url:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set origin = %request.GetCgiEnv("HTTP_ORIGIN")

    // Allow localhost on any port and any *.nhs.uk subdomain
    set allowed = 0
    if origin [ "://localhost" {
        set allowed = 1
    } elseif origin [ ".nhs.uk" {
        // Validate it ends with .nhs.uk (prevent suffix attacks)
        set host = $piece($piece(origin, "://", 2), "/", 1)
        set host = $piece(host, ":", 1)
        if ($extract(host, *-5, *) = ".nhs.uk") || (host = "nhs.uk") {
            set allowed = 1
        }
    }

    if allowed {
        do %response.SetHeader("Access-Control-Allow-Origin", origin)
    } else {
        do %response.SetHeader("Access-Control-Allow-Origin", "")
    }

    do %response.SetHeader("Access-Control-Allow-Credentials", "true")
    do %response.SetHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
    do %response.SetHeader("Access-Control-Allow-Headers", "Content-Type, Authorization, X-Requested-With, Accept")
    do %response.SetHeader("Access-Control-Max-Age", "3600")

    return $$$OK
]]></Implementation>
</Method>

<Method name="SendMessage">
<Description>POST /chat
Send a message within a conversation. Creates a new conversation if conversationId is empty.
Body: {&quot;conversationId&quot;:&quot;...&quot;, &quot;message&quot;:&quot;...&quot;}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        if '$isobject(body) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_BODY", "Request body must be valid JSON", 400))
            return $$$OK
        }

        set message = body.%Get("message")
        if message = "" {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'message' is required", 400))
            return $$$OK
        }
        set preferredRunner = body.%Get("preferredRunner")

        set conversationId = body.%Get("conversationId")
        if conversationId = "" {
            // Create a new conversation
            set conv = ##class(AIAgent.Model.Conversation).Create("", $namespace)
            if '$isobject(conv) {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("CREATE_FAILED", "Failed to create conversation", 500))
                return $$$OK
            }
            set conversationId = conv.ConversationId
        }

        set result = ##class(AIAgent.Engine.Orchestrator).ProcessMessage(conversationId, message, preferredRunner)

        if result.error '= "" {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("ORCHESTRATOR_ERROR", result.error, 500))
            return $$$OK
        }

        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(result))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "SendMessage", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="SendMessageSSE">
<Description>POST /chat/stream
Send a message and receive the response as Server-Sent Events (SSE).
Body: {&quot;conversationId&quot;:&quot;...&quot;, &quot;message&quot;:&quot;...&quot;}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        if '$isobject(body) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_BODY", "Request body must be valid JSON", 400))
            return $$$OK
        }

        set message = body.%Get("message")
        if message = "" {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'message' is required", 400))
            return $$$OK
        }
        set preferredRunner = body.%Get("preferredRunner")

        set conversationId = body.%Get("conversationId")
        if conversationId = "" {
            set conv = ##class(AIAgent.Model.Conversation).Create("", $namespace)
            if '$isobject(conv) {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("CREATE_FAILED", "Failed to create conversation", 500))
                return $$$OK
            }
            set conversationId = conv.ConversationId
        }

        // Set SSE response headers
        set %response.ContentType = "text/event-stream"
        set %response.CharSet = "utf-8"
        do %response.SetHeader("Cache-Control", "no-cache")
        do %response.SetHeader("Connection", "keep-alive")
        do %response.SetHeader("X-Accel-Buffering", "no")

        // Save the user message first
        set userMsg = ##class(AIAgent.Model.Message).Create(conversationId, "user", message)

        // Send conversationId as first event
        set initData = ##class(%DynamicObject).%New()
        set initData.conversationId = conversationId
        set initData.type = "init"
        write "data: "_initData.%ToJSON(), !!, *-3

        // Stream the response from the bridge
        set sc = ##class(AIAgent.Engine.BridgeClient).SendMessageStream(conversationId, message, .fullResponse, preferredRunner)

        // Reliability fallback: if streaming returned no content, do a non-stream
        // bridge call and emit/persist that response so the user never gets an
        // empty assistant message.
        if $$$ISOK(sc) && (fullResponse = "") {
            set fallback = ##class(AIAgent.Engine.BridgeClient).SendMessage(conversationId, message, $namespace, preferredRunner)
            if $isobject(fallback) && (fallback.%Get("error") = "") {
                set fallbackText = fallback.%Get("response")
                if fallbackText '= "" {
                    set fullResponse = fallbackText
                    set fbData = ##class(%DynamicObject).%New()
                    set fbData.token = fallbackText
                    set fbData.done = 0
                    set fbData.type = "fallback"
                    write "data: "_fbData.%ToJSON(), !!, *-3
                }
            }
        }

        if $$$ISOK(sc) {
            if fullResponse = "" {
                set fullResponse = "(No response content returned by bridge stream)"
            }
            do ##class(AIAgent.Model.Message).Create(conversationId, "assistant", fullResponse)
        }

        // Send done event
        set doneData = ##class(%DynamicObject).%New()
        set doneData.type = "done"
        set doneData.conversationId = conversationId
        write "data: "_doneData.%ToJSON(), !!, *-3

    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "SendMessageSSE", ex.DisplayString())
        set errData = ##class(%DynamicObject).%New()
        set errData.type = "error"
        set errData.message = ex.DisplayString()
        try {
            write "data: "_errData.%ToJSON(), !!, *-3
        } catch {}
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ListConversations">
<Description>GET /conversations
List conversations with optional pagination and status filter.
Query params: page (default 1), pageSize (default 20), status (optional)</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set page = ##class(AIAgent.Util.JSON).GetIntParam("page", 1)
        set pageSize = ##class(AIAgent.Util.JSON).GetIntParam("pageSize", 20)
        set status = ##class(AIAgent.Util.JSON).GetParam("status")

        set result = ##class(AIAgent.Model.Conversation).List(page, pageSize, status)
        do ##class(AIAgent.Util.JSON).WriteJSON(result)
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ListConversations", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="CreateConversation">
<Description>POST /conversations
Create a new conversation.
Body: {&quot;title&quot;:&quot;...&quot;, &quot;targetNamespace&quot;:&quot;...&quot;}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        set title = ""
        set targetNs = ""
        if $isobject(body) {
            set title = body.%Get("title")
            set targetNs = body.%Get("targetNamespace")
            if targetNs = "" {
                set targetNs = body.%Get("namespace")
            }
        }

        set conv = ##class(AIAgent.Model.Conversation).Create(title, targetNs)
        if '$isobject(conv) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("CREATE_FAILED", "Failed to create conversation", 500))
            return $$$OK
        }

        set %response.Status = "201 Created"
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(conv.ToJSON()))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "CreateConversation", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="GetConversation">
<Description>GET /conversations/:id
Get a conversation with its messages.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set conv = ##class(AIAgent.Model.Conversation).FindById(id)
        if '$isobject(conv) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NOT_FOUND", "Conversation '"_id_"' not found", 404))
            return $$$OK
        }

        set data = conv.ToJSON()
        // Include messages
        set data.messages = ##class(AIAgent.Model.Message).GetByConversation(id)
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "GetConversation", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="DeleteConversation">
<Description>DELETE /conversations/:id
Delete (archive) a conversation.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set conv = ##class(AIAgent.Model.Conversation).FindById(id)
        if '$isobject(conv) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NOT_FOUND", "Conversation '"_id_"' not found", 404))
            return $$$OK
        }

        // Soft-delete by archiving
        set conv.Status = "archived"
        set sc = conv.%Save()
        if $$$ISERR(sc) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
            return $$$OK
        }

        do ##class(AIAgent.Model.AuditEntry).LogSuccess("delete", "conversation:"_id)
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(conv.ToJSON()))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "DeleteConversation", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="PreviewGeneration">
<Description>POST /generate/preview
Preview a generation without deploying. Delegates to the Orchestrator.
Body: {&quot;conversationId&quot;:&quot;...&quot;, &quot;message&quot;:&quot;...&quot;}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        if '$isobject(body) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_BODY", "Request body must be valid JSON", 400))
            return $$$OK
        }

        set conversationId = body.%Get("conversationId")
        set message = body.%Get("message")
        if message = "" {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'message' is required", 400))
            return $$$OK
        }

        if conversationId = "" {
            set conv = ##class(AIAgent.Model.Conversation).Create("Code Generation", $namespace)
            if '$isobject(conv) {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("CREATE_FAILED", "Failed to create conversation", 500))
                return $$$OK
            }
            set conversationId = conv.ConversationId
        }

        // ProcessMessage will return the generation in preview status
        set result = ##class(AIAgent.Engine.Orchestrator).ProcessMessage(conversationId, message)

        if result.error '= "" {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("GENERATION_ERROR", result.error, 500))
            return $$$OK
        }

        // If a generation was created, include its details
        if result.generationId '= "" {
            set gen = ##class(AIAgent.Model.Generation).FindById(result.generationId)
            if $isobject(gen) {
                set result.generation = gen.ToJSON()
            }
        }

        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(result))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "PreviewGeneration", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ApproveGeneration">
<Description>POST /generate/approve
Approve a generation and deploy it (compile classes, update production).
Body: {&quot;generationId&quot;:&quot;...&quot;}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        if '$isobject(body) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_BODY", "Request body must be valid JSON", 400))
            return $$$OK
        }

        set generationId = body.%Get("generationId")
        if generationId = "" {
            set gen = ##class(AIAgent.Model.Generation).FindLatestByStatus("preview")
            if '$isobject(gen) {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NO_PENDING_GENERATION", "No pending preview generation available to approve", 409))
                return $$$OK
            }
            set generationId = gen.GenerationId
        }

        set result = ##class(AIAgent.Engine.Orchestrator).ApproveAndDeploy(generationId)

        if result.error '= "" {
            set httpStatus = $select(result.error [ "not found":404, result.error [ "expected":409, 1:500)
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("APPROVAL_ERROR", result.error, httpStatus))
            return $$$OK
        }

        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(result))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ApproveGeneration", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="RejectGeneration">
<Description>POST /generate/reject
Reject a generation (do not deploy).
Body: {&quot;generationId&quot;:&quot;...&quot;, &quot;reason&quot;:&quot;...&quot;}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        if '$isobject(body) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_BODY", "Request body must be valid JSON", 400))
            return $$$OK
        }

        set generationId = body.%Get("generationId")
        if generationId = "" {
            set gen = ##class(AIAgent.Model.Generation).FindLatestByStatus("preview")
            if '$isobject(gen) {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NO_PENDING_GENERATION", "No pending preview generation available to reject", 409))
                return $$$OK
            }
            set generationId = gen.GenerationId
        }

        set reason = body.%Get("reason")
        set sc = ##class(AIAgent.Engine.Orchestrator).RejectGeneration(generationId, reason)

        if $$$ISERR(sc) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc, 404))
            return $$$OK
        }

        set data = ##class(%DynamicObject).%New()
        set data.generationId = generationId
        set data.status = "rejected"
        set data.reason = reason
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "RejectGeneration", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="GetProductionStatus">
<Description>GET /production/status
Get current production name, status, and namespace.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set data = ##class(AIAgent.Engine.ProductionManager).GetStatus()
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "GetProductionStatus", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="GetProductionTopology">
<Description>GET /production/topology
Get full production topology: all business hosts with their configurations.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set data = ##class(AIAgent.Engine.ProductionManager).GetTopology()
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "GetProductionTopology", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="StartProduction">
<Description>POST /production/start
Start the production.
Body (optional): {&quot;productionName&quot;:&quot;...&quot;}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        set productionName = ""
        if $isobject(body) {
            set productionName = body.%Get("productionName")
        }

        set sc = ##class(AIAgent.Engine.ProductionManager).StartProduction(productionName)

        if $$$ISERR(sc) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
            return $$$OK
        }

        // Return fresh status after starting
        set data = ##class(AIAgent.Engine.ProductionManager).GetStatus()
        set data.action = "started"
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "StartProduction", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="StopProduction">
<Description>POST /production/stop
Stop the production.
Body (optional): {&quot;timeout&quot;: 300}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        set timeout = 300
        if $isobject(body) && (body.%Get("timeout") '= "") {
            set timeout = +body.%Get("timeout")
        }

        set sc = ##class(AIAgent.Engine.ProductionManager).StopProduction(timeout)

        if $$$ISERR(sc) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
            return $$$OK
        }

        set data = ##class(AIAgent.Engine.ProductionManager).GetStatus()
        set data.action = "stopped"
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "StopProduction", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="GetEventLog">
<Description>GET /production/events
Get recent event log entries.
Query params: count (default 50), configName (optional)</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set count = ##class(AIAgent.Util.JSON).GetIntParam("count", 50)
        set configName = ##class(AIAgent.Util.JSON).GetParam("configName")

        set data = ##class(AIAgent.Engine.ProductionManager).GetEventLog(count, configName)
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "GetEventLog", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="GetQueueCounts">
<Description>GET /production/queues
Get message queue depths for all hosts.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set data = ##class(AIAgent.Engine.ProductionManager).GetQueueCounts()
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "GetQueueCounts", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ListClasses">
<Description>GET /classes
List classes matching a pattern.
Query params: pattern (default &quot;AIAgent.Generated.%&quot;)</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set pattern = ##class(AIAgent.Util.JSON).GetParam("pattern", "AIAgent.Generated.%")

        set data = ##class(AIAgent.Engine.CodeManager).ListClasses(pattern)
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ListClasses", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ReadClass">
<Description>GET /classes/:className
Read the full source of a class.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        // URL-decode the class name (dots may be encoded as %2E)
        set className = $zconvert(className, "I", "URL")

        if '##class(AIAgent.Engine.CodeManager).ClassExists(className) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NOT_FOUND", "Class '"_className_"' not found", 404))
            return $$$OK
        }

        set sc = ##class(AIAgent.Engine.CodeManager).ReadClass(className, .source)
        if $$$ISERR(sc) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
            return $$$OK
        }

        set data = ##class(%DynamicObject).%New()
        set data.className = className
        set data.source = source
        set data.exists = 1
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ReadClass", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ListLookupTables">
<Description>GET /lookups
List all lookup tables and their entry counts.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set data = ##class(AIAgent.Engine.CodeManager).ListLookupTables()
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ListLookupTables", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ReadLookupTable">
<Description>GET /lookups/:tableName
Read entries from a specific lookup table.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>tableName:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set tableName = $zconvert(tableName, "I", "URL")

        set data = ##class(AIAgent.Engine.CodeManager).ReadLookupTable(tableName)
        set result = ##class(%DynamicObject).%New()
        set result.tableName = tableName
        set result.entries = data
        set result.entryCount = data.%Size()
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(result))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ReadLookupTable", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ListHL7Schemas">
<Description>GET /hl7schemas
List all HL7 schemas (standard and custom).</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set data = ##class(AIAgent.Engine.CodeManager).ListHL7Schemas()
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ListHL7Schemas", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ExecuteSQL">
<Description>POST /sql
Execute a read-only SQL query and return results.
Body: {&quot;query&quot;:&quot;SELECT ...&quot;}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        if '$isobject(body) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_BODY", "Request body must be valid JSON", 400))
            return $$$OK
        }

        set query = body.%Get("query")
        if query = "" {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'query' is required", 400))
            return $$$OK
        }

        set result = ##class(AIAgent.Engine.CodeManager).ExecuteSQL(query)

        if result.error '= "" {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("SQL_ERROR", result.error, 400))
            return $$$OK
        }

        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(result))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ExecuteSQL", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="RunTests">
<Description>POST /lifecycle/test
Run unit tests for a class or pattern.
Body: {&quot;testClass&quot;:&quot;...&quot;, &quot;pattern&quot;:&quot;...&quot;}
If testClass is provided, runs a single test class.
If pattern is provided, runs all matching test classes.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        if '$isobject(body) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_BODY", "Request body must be valid JSON", 400))
            return $$$OK
        }

        set testClass = body.%Get("testClass")
        set pattern = body.%Get("pattern")

        if (testClass = "") && (pattern = "") {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'testClass' or 'pattern' is required", 400))
            return $$$OK
        }

        if testClass '= "" {
            // Run a single test class
            set result = ##class(AIAgent.Engine.TestRunner).RunTestClass(testClass)
        } else {
            // Run a test suite matching the pattern
            set result = ##class(AIAgent.Engine.TestRunner).RunTestSuite(pattern)
        }

        if result.error '= "" {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("TEST_ERROR", result.error, 400))
            return $$$OK
        }

        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(result))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "RunTests", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="Rollback">
<Description>POST /lifecycle/rollback/:id
Rollback to a specific version snapshot.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set id = $zconvert(id, "I", "URL")

        set sc = ##class(AIAgent.Engine.VersionManager).Rollback(id, .log)

        if $$$ISERR(sc) {
            set errMsg = $system.Status.GetOneErrorText(sc)
            set httpStatus = $select(errMsg [ "not found":404, errMsg [ "empty":400, 1:500)
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("ROLLBACK_ERROR", errMsg, httpStatus))
            return $$$OK
        }

        set data = ##class(%DynamicObject).%New()
        set data.versionId = id
        set data.status = "rolled_back"
        set data.log = log
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "Rollback", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ListVersions">
<Description>GET /lifecycle/versions
List version snapshots.
Query params: page (default 1), pageSize (default 20)</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set page = ##class(AIAgent.Util.JSON).GetIntParam("page", 1)
        set pageSize = ##class(AIAgent.Util.JSON).GetIntParam("pageSize", 20)

        set data = ##class(AIAgent.Engine.VersionManager).ListVersions(page, pageSize)
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ListVersions", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="ListRunners">
<Description>GET /runners
List available AI runners from the bridge.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set data = ##class(AIAgent.Engine.BridgeClient).ListRunners()
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "ListRunners", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="RunnerHealthCheck">
<Description>GET /runners/health
Check connectivity and health of the AI runner bridge.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set data = ##class(AIAgent.Engine.BridgeClient).HealthCheck()
        if 'data.healthy {
            set %response.Status = "503 Service Unavailable"
        }
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "RunnerHealthCheck", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="GetCapabilities">
<Description>GET /capabilities
Return effective generic capabilities for the current user and namespace.
Query params: namespace (optional, defaults to current)</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set ns = ##class(AIAgent.Util.JSON).GetParam("namespace", $namespace)
        set data = ..BuildCapabilities(ns)
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "GetCapabilities", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="Operate">
<Description>POST /operate
Generic operation gateway (additive path).
Body: {&quot;namespace&quot;:&quot;...&quot;,&quot;op&quot;:&quot;discover|query|mutate|execute|govern&quot;,&quot;target&quot;:&quot;...&quot;,&quot;action&quot;:&quot;...&quot;,&quot;args&quot;:{},&quot;dryRun&quot;:true|false}</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set body = ##class(AIAgent.Util.JSON).ReadRequestJSON()
        if '$isobject(body) {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_BODY", "Request body must be valid JSON", 400))
            return $$$OK
        }

        set op = body.%Get("op")
        set target = body.%Get("target")
        if (op = "") || (target = "") {
            do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'op' and 'target' are required", 400))
            return $$$OK
        }

        set ns = body.%Get("namespace")
        if ns = "" set ns = $namespace
        set action = body.%Get("action")
        set dryRun = +body.%Get("dryRun")
        set args = body.%Get("args")
        if '$isobject(args) {
            set args = ##class(%DynamicObject).%New()
        }

        set result = ##class(%DynamicObject).%New()
        set meta = ##class(%DynamicObject).%New()
        set meta.namespace = ns
        set meta.executedBy = $username
        set meta.requiresApproval = 0

        if op = "discover" {
            if target = "capabilities" {
                set result.data = ..BuildCapabilities(ns)
                set meta.capability = "discover.capabilities"
            } elseif target = "namespaces" {
                set arr = ##class(%DynamicArray).%New()
                do arr.%Push($namespace)
                set result.data = arr
                set meta.capability = "discover.namespaces"
            } elseif target = "targets" {
                set result.data = ..BuildTargetCatalog()
                set meta.capability = "discover.targets"
            } elseif target = "invoke-policy" {
                set result.data = ..GetInvocationPolicy()
                set meta.capability = "discover.invoke.policy"
            } else {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("UNSUPPORTED_TARGET", "Unsupported discover target: "_target, 400))
                return $$$OK
            }
        } elseif op = "query" {
            if target = "production/status" {
                set result.data = ##class(AIAgent.Engine.ProductionManager).GetStatus()
                set meta.capability = "production.status.read"
            } elseif target = "production/topology" {
                set result.data = ##class(AIAgent.Engine.ProductionManager).GetTopology()
                set meta.capability = "production.topology.read"
            } elseif target = "production/events" {
                set count = args.%Get("count")
                if count = "" set count = 50
                set cfg = args.%Get("configName")
                set result.data = ##class(AIAgent.Engine.ProductionManager).GetEventLog(count, cfg)
                set meta.capability = "production.events.read"
            } elseif target = "production/queues" {
                set result.data = ##class(AIAgent.Engine.ProductionManager).GetQueueCounts()
                set meta.capability = "production.queues.read"
            } elseif target = "lookups" {
                set result.data = ##class(AIAgent.Engine.CodeManager).ListLookupTables()
                set meta.capability = "lookup.catalog.read"
            } elseif target = "hl7schemas" {
                set result.data = ##class(AIAgent.Engine.CodeManager).ListHL7Schemas()
                set meta.capability = "hl7schemas.read"
            } elseif $extract(target,1,7) = "lookup/" {
                set tableName = $extract(target,8,*)
                set entries = ##class(AIAgent.Engine.CodeManager).ReadLookupTable(tableName)
                set obj = ##class(%DynamicObject).%New()
                set obj.tableName = tableName
                set obj.entries = entries
                set obj.entryCount = entries.%Size()
                set result.data = obj
                set meta.capability = "lookup.read"
            } elseif target = "classes" {
                set pattern = args.%Get("pattern")
                if pattern = "" set pattern = "AIAgent.Generated.%"
                set result.data = ##class(AIAgent.Engine.CodeManager).ListClasses(pattern)
                set meta.capability = "class.catalog.read"
            } elseif target = "dictionary/classes" {
                set pattern = args.%Get("pattern")
                if pattern = "" set pattern = "%"
                set maxRows = +args.%Get("maxRows")
                if maxRows<1 set maxRows = 500
                set result.data = ..ListDictionaryClasses(pattern, maxRows)
                set meta.capability = "dictionary.classes.read"
            } elseif $extract(target,1,6) = "class/" {
                set className = $extract(target,7,*)
                if '##class(AIAgent.Engine.CodeManager).ClassExists(className) {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NOT_FOUND", "Class '"_className_"' not found", 404))
                    return $$$OK
                }
                set sc = ##class(AIAgent.Engine.CodeManager).ReadClass(className, .source)
                if $$$ISERR(sc) {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
                    return $$$OK
                }
                set obj = ##class(%DynamicObject).%New()
                set obj.className = className
                set obj.source = source
                set result.data = obj
                set meta.capability = "class.read"
            } elseif $extract(target,1,10) = "classmeta/" {
                set className = $extract(target,11,*)
                if className = "" {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "classmeta target requires class name, e.g. classmeta/AIAgent.API.Dispatcher", 400))
                    return $$$OK
                }
                if '##class(AIAgent.Engine.CodeManager).ClassExists(className) {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NOT_FOUND", "Class '"_className_"' not found", 404))
                    return $$$OK
                }
                set result.data = ..GetClassMetadata(className)
                set meta.capability = "class.meta.read"
            } elseif target = "lifecycle/versions" {
                set page = args.%Get("page")
                if page = "" set page = 1
                set pageSize = args.%Get("pageSize")
                if pageSize = "" set pageSize = 20
                set result.data = ##class(AIAgent.Engine.VersionManager).ListVersions(page, pageSize)
                set meta.capability = "lifecycle.versions.read"
            } elseif target = "sql/select" {
                set query = args.%Get("query")
                if query = "" set query = args.%Get("sql")
                set queryTrim = $zstrip(query, "<W")
                if queryTrim = "" {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'args.query' is required for target sql/select", 400))
                    return $$$OK
                }
                set low = $zconvert(queryTrim, "L")
                if $extract(low,1,6) '= "select" {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INVALID_QUERY", "Only SELECT queries are allowed for target sql/select", 400))
                    return $$$OK
                }
                set sqlResult = ##class(AIAgent.Engine.CodeManager).ExecuteSQL(queryTrim)
                if sqlResult.error '= "" {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("SQL_ERROR", sqlResult.error, 400))
                    return $$$OK
                }
                set result.data = sqlResult
                set meta.capability = "sql.read"
            } else {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("UNSUPPORTED_TARGET", "Unsupported query target: "_target, 400))
                return $$$OK
            }
        } elseif op = "execute" {
            set meta.requiresApproval = 1
            if dryRun {
                set plan = ##class(%DynamicObject).%New()
                set plan.status = "dry_run"
                set plan.target = target
                set plan.message = "Execution was not applied because dryRun=true"
                set result.data = plan
                set meta.capability = "execute.plan"
            } elseif (target = "generation/approve") || (target = "generate/approve") {
                set generationId = args.%Get("generationId")
                if generationId = "" {
                    set gen = ##class(AIAgent.Model.Generation).FindLatestByStatus("preview")
                    if '$isobject(gen) {
                        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NO_PENDING_GENERATION", "No pending preview generation available to approve", 409))
                        return $$$OK
                    }
                    set generationId = gen.GenerationId
                }
                set result.data = ##class(AIAgent.Engine.Orchestrator).ApproveAndDeploy(generationId)
                set meta.capability = "execute.generation.approve"
            } elseif (target = "generation/reject") || (target = "generate/reject") {
                set generationId = args.%Get("generationId")
                if generationId = "" {
                    set gen = ##class(AIAgent.Model.Generation).FindLatestByStatus("preview")
                    if '$isobject(gen) {
                        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("NO_PENDING_GENERATION", "No pending preview generation available to reject", 409))
                        return $$$OK
                    }
                    set generationId = gen.GenerationId
                }
                set reason = args.%Get("reason")
                set sc = ##class(AIAgent.Engine.Orchestrator).RejectGeneration(generationId, reason)
                if $$$ISERR(sc) {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
                    return $$$OK
                }
                set obj = ##class(%DynamicObject).%New()
                set obj.generationId = generationId
                set obj.status = "rejected"
                set obj.reason = reason
                set result.data = obj
                set meta.capability = "execute.generation.reject"
            } elseif target = "production/start" {
                set productionName = args.%Get("productionName")
                set sc = ##class(AIAgent.Engine.ProductionManager).StartProduction(productionName)
                if $$$ISERR(sc) {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
                    return $$$OK
                }
                set result.data = ##class(AIAgent.Engine.ProductionManager).GetStatus()
                set meta.capability = "execute.production.start"
            } elseif target = "production/stop" {
                set timeout = args.%Get("timeout")
                if timeout = "" set timeout = 300
                set sc = ##class(AIAgent.Engine.ProductionManager).StopProduction(timeout)
                if $$$ISERR(sc) {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
                    return $$$OK
                }
                set result.data = ##class(AIAgent.Engine.ProductionManager).GetStatus()
                set meta.capability = "execute.production.stop"
            } elseif target = "lifecycle/rollback" {
                set versionId = args.%Get("versionId")
                if versionId = "" set versionId = args.%Get("id")
                if versionId = "" {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'args.versionId' is required for target lifecycle/rollback", 400))
                    return $$$OK
                }
                set sc = ##class(AIAgent.Engine.VersionManager).Rollback(versionId, .rollbackLog)
                if $$$ISERR(sc) {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
                    return $$$OK
                }
                set obj = ##class(%DynamicObject).%New()
                set obj.versionId = versionId
                set obj.status = "rolled_back"
                set obj.log = rollbackLog
                set result.data = obj
                set meta.capability = "execute.lifecycle.rollback"
            } elseif target = "class/invoke" {
                set className = args.%Get("className")
                set methodName = args.%Get("method")
                if (className = "") || (methodName = "") {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'args.className' and 'args.method' are required for target class/invoke", 400))
                    return $$$OK
                }
                set allowed = ..IsInvocationAllowed(className, methodName, .denyReason)
                if 'allowed {
                    do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("FORBIDDEN", "Invocation denied by policy: "_denyReason, 403))
                    return $$$OK
                }
                if dryRun {
                    set plan = ##class(%DynamicObject).%New()
                    set plan.status = "dry_run"
                    set plan.target = target
                    set plan.className = className
                    set plan.method = methodName
                    set plan.message = "Invocation allowed by policy but not executed because dryRun=true"
                    set result.data = plan
                    set meta.capability = "execute.class.invoke"
                } else {
                    set invokeResult = ..InvokeClassMethod(className, methodName, args.%Get("arguments"), .invokeSc)
                    if $$$ISERR(invokeSc) {
                        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(invokeSc))
                        return $$$OK
                    }
                    set obj = ##class(%DynamicObject).%New()
                    set obj.className = className
                    set obj.method = methodName
                    set obj.result = invokeResult
                    set result.data = obj
                    set meta.capability = "execute.class.invoke"
                }
            } else {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("UNSUPPORTED_TARGET", "Unsupported execute target: "_target, 400))
                return $$$OK
            }
        } elseif op = "mutate" {
            set meta.requiresApproval = 1
            if dryRun {
                set plan = ##class(%DynamicObject).%New()
                set plan.status = "dry_run"
                set plan.target = target
                set plan.message = "Mutation was not applied because dryRun=true"
                set result.data = plan
                set meta.capability = "mutate.plan"
            } elseif target = "production/host/add" {
                set items = ##class(%DynamicArray).%New()
                set configs = args.%Get("configs")
                if $isobject(configs) {
                    for i=0:1:(configs.%Size()-1) {
                        set cfg = configs.%Get(i)
                        if '$isobject(cfg) continue
                        set sc = ##class(AIAgent.Engine.ProductionManager).EnsureBusinessHost(cfg, .opResult)
                        if $$$ISERR(sc) {
                            set errObj = ##class(%DynamicObject).%New()
                            set errObj.action = "add"
                            set errObj.hostName = cfg.%Get("name")
                            set errObj.status = "error"
                            set errObj.error = $system.Status.GetOneErrorText(sc)
                            do items.%Push(errObj)
                        } else {
                            do items.%Push(opResult)
                        }
                    }
                } else {
                    set hostConfig = args.%Get("config")
                    if '$isobject(hostConfig) set hostConfig = args
                    set sc = ##class(AIAgent.Engine.ProductionManager).EnsureBusinessHost(hostConfig, .opResult)
                    if $$$ISERR(sc) {
                        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
                        return $$$OK
                    }
                    do items.%Push(opResult)
                }
                set out = ##class(%DynamicObject).%New()
                set out.target = target
                set out.count = items.%Size()
                set out.results = items
                set result.data = out
                set meta.capability = "mutate.production.host.add"
            } elseif target = "production/host/remove" {
                set items = ##class(%DynamicArray).%New()
                set names = args.%Get("names")
                if $isobject(names) {
                    for i=0:1:(names.%Size()-1) {
                        set hostName = names.%Get(i)
                        set sc = ##class(AIAgent.Engine.ProductionManager).RemoveBusinessHostEx(hostName, .opResult)
                        if $$$ISERR(sc) {
                            set errObj = ##class(%DynamicObject).%New()
                            set errObj.action = "remove"
                            set errObj.hostName = hostName
                            set errObj.status = "error"
                            set errObj.error = $system.Status.GetOneErrorText(sc)
                            do items.%Push(errObj)
                        } else {
                            do items.%Push(opResult)
                        }
                    }
                } else {
                    set hostName = args.%Get("name")
                    if hostName = "" set hostName = args.%Get("itemName")
                    if hostName = "" {
                        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'args.name' is required for target production/host/remove", 400))
                        return $$$OK
                    }
                    set sc = ##class(AIAgent.Engine.ProductionManager).RemoveBusinessHostEx(hostName, .opResult)
                    if $$$ISERR(sc) {
                        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
                        return $$$OK
                    }
                    do items.%Push(opResult)
                }
                set out = ##class(%DynamicObject).%New()
                set out.target = target
                set out.count = items.%Size()
                set out.results = items
                set result.data = out
                set meta.capability = "mutate.production.host.remove"
            } elseif target = "production/host/settings" {
                set items = ##class(%DynamicArray).%New()
                set updates = args.%Get("updates")
                if $isobject(updates) {
                    for i=0:1:(updates.%Size()-1) {
                        set upd = updates.%Get(i)
                        if '$isobject(upd) continue
                        set hostName = upd.%Get("name")
                        if hostName = "" set hostName = upd.%Get("itemName")
                        set settings = upd.%Get("settings")
                        if (hostName = "") || ('$isobject(settings)) continue
                        set sc = ##class(AIAgent.Engine.ProductionManager).UpdateHostSettingsEx(hostName, settings, .opResult)
                        if $$$ISERR(sc) {
                            set errObj = ##class(%DynamicObject).%New()
                            set errObj.action = "settings"
                            set errObj.hostName = hostName
                            set errObj.status = "error"
                            set errObj.error = $system.Status.GetOneErrorText(sc)
                            do items.%Push(errObj)
                        } else {
                            do items.%Push(opResult)
                        }
                    }
                } else {
                    set hostName = args.%Get("name")
                    if hostName = "" set hostName = args.%Get("itemName")
                    set settings = args.%Get("settings")
                    if (hostName = "") || ('$isobject(settings)) {
                        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("MISSING_FIELD", "'args.name' and object 'args.settings' are required for target production/host/settings", 400))
                        return $$$OK
                    }
                    set sc = ##class(AIAgent.Engine.ProductionManager).UpdateHostSettingsEx(hostName, settings, .opResult)
                    if $$$ISERR(sc) {
                        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).StatusToError(sc))
                        return $$$OK
                    }
                    do items.%Push(opResult)
                }
                set out = ##class(%DynamicObject).%New()
                set out.target = target
                set out.count = items.%Size()
                set out.results = items
                set result.data = out
                set meta.capability = "mutate.production.host.settings"
            } else {
                do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("UNSUPPORTED_TARGET", "Unsupported mutate target: "_target, 400))
                return $$$OK
            }
        } else {
            set meta.requiresApproval = 1
            set result.data = ##class(%DynamicObject).%New()
            set result.data.status = "pending_implementation"
            set result.data.message = "Operation '"_op_"' is recognized but not yet enabled in generic gateway."
            set meta.capability = op_".pending"
        }

        set result.meta = meta
        set result.dryRun = dryRun
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(result))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "Operate", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="BuildCapabilities">
<Description>Build effective capabilities for current user/session.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ns:%String=&quot;&quot;</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set data = ##class(%DynamicObject).%New()
    if ns = "" set ns = $namespace
    set data.namespace = ns
    set data.username = $username
    set data.ensembleAvailable = ##class(%Dictionary.CompiledClass).%ExistsId("Ens.Director")
    set caps = ##class(%DynamicArray).%New()

    // Discover + query capabilities (read-first phase)
    do caps.%Push(..Cap("discover.capabilities", ns, 1))
    do caps.%Push(..Cap("discover.namespaces", ns, 1))
    do caps.%Push(..Cap("discover.targets", ns, 1))
    do caps.%Push(..Cap("discover.invoke.policy", ns, 1))
    do caps.%Push(..Cap("production.status.read", ns, data.ensembleAvailable))
    do caps.%Push(..Cap("production.topology.read", ns, data.ensembleAvailable))
    do caps.%Push(..Cap("production.events.read", ns, data.ensembleAvailable))
    do caps.%Push(..Cap("production.queues.read", ns, data.ensembleAvailable))
    do caps.%Push(..Cap("lookup.catalog.read", ns, 1))
    do caps.%Push(..Cap("lookup.read", ns, 1))
    do caps.%Push(..Cap("hl7schemas.read", ns, 1))
    do caps.%Push(..Cap("class.catalog.read", ns, 1))
    do caps.%Push(..Cap("class.read", ns, 1))
    do caps.%Push(..Cap("class.meta.read", ns, 1))
    do caps.%Push(..Cap("dictionary.classes.read", ns, 1))
    do caps.%Push(..Cap("sql.read", ns, 1))
    do caps.%Push(..Cap("lifecycle.versions.read", ns, 1))

    // Generic execute/mutate capabilities (approval-gated)
    do caps.%Push(..Cap("execute.generation.approve", ns, 1, "approval_required"))
    do caps.%Push(..Cap("execute.generation.reject", ns, 1, "approval_required"))
    do caps.%Push(..Cap("execute.production.start", ns, data.ensembleAvailable, "approval_required"))
    do caps.%Push(..Cap("execute.production.stop", ns, data.ensembleAvailable, "approval_required"))
    do caps.%Push(..Cap("execute.lifecycle.rollback", ns, 1, "approval_required"))
    do caps.%Push(..Cap("execute.class.invoke", ns, 1, "approval_required_policy_guarded"))
    do caps.%Push(..Cap("mutate.production.host.add", ns, data.ensembleAvailable, "approval_required"))
    do caps.%Push(..Cap("mutate.production.host.remove", ns, data.ensembleAvailable, "approval_required"))
    do caps.%Push(..Cap("mutate.production.host.settings", ns, data.ensembleAvailable, "approval_required"))
    do caps.%Push(..Cap("govern.*", ns, 0, "pending_approval_pipeline"))

    set data.capabilities = caps
    return data
]]></Implementation>
</Method>

<Method name="Cap">
<ClassMethod>1</ClassMethod>
<FormalSpec>capability:%String,ns:%String,allowed:%Integer=1,reason:%String=&quot;&quot;</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set obj = ##class(%DynamicObject).%New()
    set obj.capability = capability
    set obj.namespace = ns
    set obj.allowed = allowed
    if reason '= "" set obj.reason = reason
    return obj
]]></Implementation>
</Method>

<Method name="BuildTargetCatalog">
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicArray</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    do arr.%Push("discover/capabilities")
    do arr.%Push("discover/namespaces")
    do arr.%Push("discover/targets")
    do arr.%Push("discover/invoke-policy")
    do arr.%Push("query/production/status")
    do arr.%Push("query/production/topology")
    do arr.%Push("query/production/events")
    do arr.%Push("query/production/queues")
    do arr.%Push("query/lookups")
    do arr.%Push("query/lookup/<TableName>")
    do arr.%Push("query/hl7schemas")
    do arr.%Push("query/classes")
    do arr.%Push("query/dictionary/classes")
    do arr.%Push("query/class/<ClassName>")
    do arr.%Push("query/classmeta/<ClassName>")
    do arr.%Push("query/lifecycle/versions")
    do arr.%Push("query/sql/select")
    do arr.%Push("mutate/production/host/add (approval-gated)")
    do arr.%Push("mutate/production/host/remove (approval-gated)")
    do arr.%Push("mutate/production/host/settings (approval-gated)")
    do arr.%Push("execute/generation/approve (approval-gated)")
    do arr.%Push("execute/generation/reject (approval-gated)")
    do arr.%Push("execute/production/start (approval-gated)")
    do arr.%Push("execute/production/stop (approval-gated)")
    do arr.%Push("execute/lifecycle/rollback (approval-gated)")
    do arr.%Push("execute/class/invoke (approval-gated, policy-guarded)")
    do arr.%Push("govern/* (approval-gated; pending rollout)")
    return arr
]]></Implementation>
</Method>

<Method name="ListDictionaryClasses">
<ClassMethod>1</ClassMethod>
<FormalSpec>pattern:%String=&quot;%&quot;,maxRows:%Integer=500</FormalSpec>
<ReturnType>%DynamicArray</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set arr = ##class(%DynamicArray).%New()
    set sql = "SELECT TOP ? Name, Super, ProcedureBlock FROM %Dictionary.ClassDefinition WHERE Name LIKE ? ORDER BY Name"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute(maxRows, pattern)
    while rs.%Next() {
        set obj = ##class(%DynamicObject).%New()
        set obj.name = rs.%GetData(1)
        set obj.super = rs.%GetData(2)
        set obj.procedureBlock = rs.%GetData(3)
        do arr.%Push(obj)
    }
    return arr
]]></Implementation>
</Method>

<Method name="GetClassMetadata">
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set out = ##class(%DynamicObject).%New()
    set out.className = className
    set methods = ##class(%DynamicArray).%New()
    set properties = ##class(%DynamicArray).%New()
    set parameters = ##class(%DynamicArray).%New()
    set out.methods = methods
    set out.properties = properties
    set out.parameters = parameters

    set def = ##class(%Dictionary.ClassDefinition).%OpenId(className)
    if $isobject(def) {
        set out.super = def.Super
        set out.description = def.Description
        set out.procedureBlock = def.ProcedureBlock
    }

    set stmtM = ##class(%SQL.Statement).%New()
    do stmtM.%Prepare("SELECT Name, ReturnType, FormalSpec, ClassMethod, Final, Private FROM %Dictionary.MethodDefinition WHERE parent = ? ORDER BY Name")
    set rsM = stmtM.%Execute(className)
    while rsM.%Next() {
        set m = ##class(%DynamicObject).%New()
        set m.name = rsM.%GetData(1)
        set m.returnType = rsM.%GetData(2)
        set m.formalSpec = rsM.%GetData(3)
        set m.classMethod = rsM.%GetData(4)
        set m.final = rsM.%GetData(5)
        set m.private = rsM.%GetData(6)
        do methods.%Push(m)
    }

    set stmtP = ##class(%SQL.Statement).%New()
    do stmtP.%Prepare("SELECT Name, Type, Required, InitialExpression FROM %Dictionary.PropertyDefinition WHERE parent = ? ORDER BY Name")
    set rsP = stmtP.%Execute(className)
    while rsP.%Next() {
        set p = ##class(%DynamicObject).%New()
        set p.name = rsP.%GetData(1)
        set p.type = rsP.%GetData(2)
        set p.required = rsP.%GetData(3)
        set p.initialExpression = rsP.%GetData(4)
        do properties.%Push(p)
    }

    set stmtQ = ##class(%SQL.Statement).%New()
    do stmtQ.%Prepare("SELECT Name, Default FROM %Dictionary.ParameterDefinition WHERE parent = ? ORDER BY Name")
    set rsQ = stmtQ.%Execute(className)
    while rsQ.%Next() {
        set q = ##class(%DynamicObject).%New()
        set q.name = rsQ.%GetData(1)
        set q.default = rsQ.%GetData(2)
        do parameters.%Push(q)
    }

    return out
]]></Implementation>
</Method>

<Method name="GetInvocationPolicy">
<ClassMethod>1</ClassMethod>
<ReturnType>%DynamicObject</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set obj = ##class(%DynamicObject).%New()
    set mode = $get(^AIAgent.Config("GenericOperate","Invoke","Mode"), "allow-by-default")
    set obj.mode = mode

    set allow = ##class(%DynamicArray).%New()
    set i = ""
    for {
        set i = $order(^AIAgent.Config("GenericOperate","Invoke","AllowClassPattern", i))
        quit:i=""
        do allow.%Push(^AIAgent.Config("GenericOperate","Invoke","AllowClassPattern", i))
    }
    if allow.%Size()=0 {
        do allow.%Push("%")
    }
    set obj.allowClassPattern = allow

    set deny = ##class(%DynamicArray).%New()
    do deny.%Push("%SYS.%")
    do deny.%Push("%SYSTEM.%")
    do deny.%Push("Security.%")
    do deny.%Push("%Installer.%")
    set obj.denyClassPattern = deny

    set denyMethods = ##class(%DynamicArray).%New()
    do denyMethods.%Push("Delete%")
    do denyMethods.%Push("Purge%")
    do denyMethods.%Push("Drop%")
    do denyMethods.%Push("Shutdown%")
    do denyMethods.%Push("Kill%")
    set obj.denyMethodPattern = denyMethods

    set obj.maxArguments = +$get(^AIAgent.Config("GenericOperate","Invoke","MaxArguments"), 4)
    return obj
]]></Implementation>
</Method>

<Method name="IsInvocationAllowed">
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,methodName:%String,*reason:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set reason = ""
    set policy = ..GetInvocationPolicy()
    set mode = policy.%Get("mode")
    if mode = "" set mode = "allow-by-default"

    set deny = policy.%Get("denyClassPattern")
    if $isobject(deny) {
        for i=0:1:deny.%Size()-1 {
            set p = deny.%Get(i)
            if ..LikePattern(className, p) {
                set reason = "Class pattern denied ("_p_")"
                quit 0
            }
        }
    }

    set denyM = policy.%Get("denyMethodPattern")
    if $isobject(denyM) {
        for i=0:1:denyM.%Size()-1 {
            set p = denyM.%Get(i)
            if ..LikePattern(methodName, p) {
                set reason = "Method pattern denied ("_p_")"
                quit 0
            }
        }
    }

    set allow = policy.%Get("allowClassPattern")
    set classAllowed = (mode="allow-by-default")
    if $isobject(allow) {
        set classAllowed = 0
        for i=0:1:allow.%Size()-1 {
            set p = allow.%Get(i)
            if ..LikePattern(className, p) {
                set classAllowed = 1
                quit
            }
        }
    }
    if 'classAllowed {
        set reason = "Class not matched by allow policy"
        quit 0
    }

    if '##class(%Dictionary.ClassDefinition).%ExistsId(className) {
        set reason = "Class not found: "_className
        quit 0
    }
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare("SELECT COUNT(*) FROM %Dictionary.MethodDefinition WHERE parent = ? AND Name = ? AND ClassMethod = 1")
    set rs = stmt.%Execute(className, methodName)
    set found = 0
    if rs.%Next() set found = +rs.%GetData(1)
    if 'found {
        set reason = "ClassMethod not found: "_className_"."_methodName
        quit 0
    }
    quit 1
]]></Implementation>
</Method>

<Method name="InvokeClassMethod">
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,methodName:%String,args:%DynamicArray,*sc:%Status</FormalSpec>
<ReturnType>%String</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set sc = $$$OK
    set ret = ""
    try {
        set maxArgs = +$get(^AIAgent.Config("GenericOperate","Invoke","MaxArguments"), 4)
        if '$isobject(args) {
            set argCount = 0
        } else {
            set argCount = args.%Size()
        }
        if argCount>maxArgs {
            set sc = $$$ERROR($$$GeneralError, "Too many arguments. Max="_maxArgs)
        } else {
            if argCount=0 {
                set ret = $classmethod(className, methodName)
            } elseif argCount=1 {
                set ret = $classmethod(className, methodName, args.%Get(0))
            } elseif argCount=2 {
                set ret = $classmethod(className, methodName, args.%Get(0), args.%Get(1))
            } elseif argCount=3 {
                set ret = $classmethod(className, methodName, args.%Get(0), args.%Get(1), args.%Get(2))
            } elseif argCount=4 {
                set ret = $classmethod(className, methodName, args.%Get(0), args.%Get(1), args.%Get(2), args.%Get(3))
            }
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    quit ret
]]></Implementation>
</Method>

<Method name="LikePattern">
<ClassMethod>1</ClassMethod>
<FormalSpec>value:%String,pattern:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    // Lightweight SQL-LIKE style matcher for % wildcard.
    if pattern = "%" quit 1
    if pattern = value quit 1
    if pattern'["%" quit 0

    set starts = ($extract(pattern,1)="%")
    set ends = ($extract(pattern,*)="%")
    set core = pattern
    if starts set core = $extract(core,2,*)
    if ends set core = $extract(core,1,*-1)
    if core = "" quit 1

    if starts,ends {
        quit (value[core)
    } elseif ends {
        quit ($extract(value,1,$length(core))=core)
    } elseif starts {
        quit ($extract(value,*-$length(core)+1,*)=core)
    }
    quit 0
]]></Implementation>
</Method>

<Method name="GetAuditLog">
<Description>GET /audit
Get audit log entries with optional filters.
Query params: action, actor, page (default 1), pageSize (default 50)</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set action = ##class(AIAgent.Util.JSON).GetParam("action")
        set actor = ##class(AIAgent.Util.JSON).GetParam("actor")
        set page = ##class(AIAgent.Util.JSON).GetIntParam("page", 1)
        set pageSize = ##class(AIAgent.Util.JSON).GetIntParam("pageSize", 50)

        set data = ##class(AIAgent.Model.AuditEntry).Query(action, actor, page, pageSize)
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        do ##class(AIAgent.Util.Logger).Error("Dispatcher", "GetAuditLog", ex.DisplayString())
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("INTERNAL_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="HealthCheck">
<Description>GET /health
Health check endpoint. Returns platform version, IRIS version, namespace, and uptime info.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    try {
        set data = ##class(%DynamicObject).%New()
        set data.status = "healthy"
        set data.platform = "IRIS AI Agent Platform"
        set data.version = "1.0.0"
        set data.irisVersion = $system.Version.GetNumber()
        set data.irisProduct = $system.Version.GetProduct()
        set data.namespace = $namespace
        set data.timestamp = ##class(AIAgent.Util.JSON).Now()
        set data.username = $username

        // Check if Ensemble/HealthConnect is available
        set data.ensembleAvailable = ##class(%Dictionary.CompiledClass).%ExistsId("Ens.Director")

        // Check bridge connectivity
        set bridgeHealth = ##class(AIAgent.Engine.BridgeClient).HealthCheck()
        set data.bridgeHealthy = bridgeHealth.healthy
        set data.bridgeUrl = ##class(AIAgent.Engine.BridgeClient).GetBridgeURL()

        // Production status (only if Ensemble is available)
        if data.ensembleAvailable {
            set prodStatus = ##class(AIAgent.Engine.ProductionManager).GetStatus()
            set data.productionName = prodStatus.productionName
            set data.productionStatus = prodStatus.statusText
        }

        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).SuccessResponse(data))
    } catch ex {
        // Even health check errors should return a structured response
        do ##class(AIAgent.Util.JSON).WriteJSON(##class(AIAgent.Util.JSON).ErrorResponse("HEALTH_ERROR", ex.DisplayString(), 500))
    }
    return $$$OK
]]></Implementation>
</Method>

<XData name="UrlMap">
<Description>URL routing map.</Description>
<XMLNamespace>http://www.intersystems.com/urlmap</XMLNamespace>
<Data><![CDATA[
<Routes>
    <!-- Chat -->
    <Route Url="/chat" Method="POST" Call="SendMessage" />
    <Route Url="/chat/stream" Method="POST" Call="SendMessageSSE" />
    <Route Url="/conversations" Method="GET" Call="ListConversations" />
    <Route Url="/conversations" Method="POST" Call="CreateConversation" />
    <Route Url="/conversations/:id" Method="GET" Call="GetConversation" />
    <Route Url="/conversations/:id" Method="DELETE" Call="DeleteConversation" />

    <!-- Code Generation & Review -->
    <Route Url="/generate/preview" Method="POST" Call="PreviewGeneration" />
    <Route Url="/generate/approve" Method="POST" Call="ApproveGeneration" />
    <Route Url="/generate/reject" Method="POST" Call="RejectGeneration" />

    <!-- Production Management -->
    <Route Url="/production/status" Method="GET" Call="GetProductionStatus" />
    <Route Url="/production/topology" Method="GET" Call="GetProductionTopology" />
    <Route Url="/production/start" Method="POST" Call="StartProduction" />
    <Route Url="/production/stop" Method="POST" Call="StopProduction" />
    <Route Url="/production/events" Method="GET" Call="GetEventLog" />
    <Route Url="/production/queues" Method="GET" Call="GetQueueCounts" />

    <!-- Code Management -->
    <Route Url="/classes" Method="GET" Call="ListClasses" />
    <Route Url="/classes/:className" Method="GET" Call="ReadClass" />
    <Route Url="/lookups" Method="GET" Call="ListLookupTables" />
    <Route Url="/lookups/:tableName" Method="GET" Call="ReadLookupTable" />
    <Route Url="/hl7schemas" Method="GET" Call="ListHL7Schemas" />
    <Route Url="/sql" Method="POST" Call="ExecuteSQL" />

    <!-- Lifecycle -->
    <Route Url="/lifecycle/test" Method="POST" Call="RunTests" />
    <Route Url="/lifecycle/rollback/:id" Method="POST" Call="Rollback" />
    <Route Url="/lifecycle/versions" Method="GET" Call="ListVersions" />

    <!-- Runner Management -->
    <Route Url="/runners" Method="GET" Call="ListRunners" />
    <Route Url="/runners/health" Method="GET" Call="RunnerHealthCheck" />
    <Route Url="/capabilities" Method="GET" Call="GetCapabilities" />
    <Route Url="/operate" Method="POST" Call="Operate" />

    <!-- Audit -->
    <Route Url="/audit" Method="GET" Call="GetAuditLog" />

    <!-- System -->
    <Route Url="/health" Method="GET" Call="HealthCheck" />
</Routes>
]]></Data>
</XData>

</Class>

<Class name="AIAgent.Test.E2E">
<Description>IRIS-side E2E probes for generic gateway and bridge APIs.
Run from IRIS terminal:
do ##class(AIAgent.Test.E2E).Run()</Description>
<Abstract>1</Abstract>
<Method name="Run">
<ClassMethod>1</ClassMethod>
<FormalSpec>bridgeBase:%String=&quot;http://localhost:3100&quot;,irisBase:%String=&quot;http://localhost:52773&quot;,ns:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    if ns = "" set ns = $namespace

    write !, "AIAgent.Test.E2E starting..."
    write !, "  bridgeBase: ", bridgeBase
    write !, "  irisBase:   ", irisBase
    write !, "  namespace:  ", ns, !

    do ..RunCase("bridge-health", bridgeBase_"/api/health", "GET", "", "status", "ok", .sc)
    do ..RunCase("iris-health", irisBase_"/ai/health", "GET", "", "status", "ok", .sc)

    set body = ##class(%DynamicObject).%New()
    set body.namespace = ns
    set body.op = "query"
    set body.target = "production/topology"
    set body.action = "read"
    set body.args = ##class(%DynamicObject).%New()
    set body.dryRun = 0
    do ..RunCase("operate-topology", bridgeBase_"/api/iris/operate", "POST", body.%ToJSON(), "status", "ok", .sc)

    set body2 = ##class(%DynamicObject).%New()
    set body2.namespace = ns
    set body2.op = "discover"
    set body2.target = "invoke-policy"
    set body2.action = "read"
    set body2.args = ##class(%DynamicObject).%New()
    set body2.dryRun = 0
    do ..RunCase("operate-invoke-policy", bridgeBase_"/api/iris/operate", "POST", body2.%ToJSON(), "status", "ok", .sc)

    set body3 = ##class(%DynamicObject).%New()
    set body3.namespace = ns
    set body3.conversationId = "iris-e2e-"_$piece($horolog,",",2)
    set body3.preferredRunner = "openai-codex-sdk"
    set body3.message = "list classes in the BRI.* packages"
    do ..RunCase("chat-class-query", bridgeBase_"/api/chat", "POST", body3.%ToJSON(), "runner", "", .sc)

    set body4 = ##class(%DynamicObject).%New()
    set body4.namespace = ns
    set body4.conversationId = "iris-e2e-"_$piece($horolog,",",2)_"-2"
    set body4.preferredRunner = "openai-codex-sdk"
    set body4.message = "Create a plan to add a disabled test business host named AIAgent.DryRun.TestHost, dry-run only."
    do ..RunCase("chat-dryrun-host-add", bridgeBase_"/api/chat", "POST", body4.%ToJSON(), "runner", "", .sc)

    write !, "AIAgent.Test.E2E complete."
    quit sc
]]></Implementation>
</Method>

<Method name="RunCase">
<ClassMethod>1</ClassMethod>
<FormalSpec>name:%String,url:%String,method:%String,body:%String,key:%String,expected:%String,&amp;sc:%Status</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
    set status = "PASS"
    try {
        set json = ..HttpJson(url, method, body)
        if '$isobject(json) {
            set status = "FAIL"
            set sc = $$$ERROR($$$GeneralError, name_" returned non-JSON")
        } else {
            if (expected '= "") && (json.%Get(key)'=expected) {
                set status = "FAIL"
                set sc = $$$ERROR($$$GeneralError, name_" expected "_key_"="_expected_" got "_json.%Get(key))
            }
        }
        write !, "[", status, "] ", name, " -> ", url
        if $isobject(json) {
            write !, "    response: ", $extract(json.%ToJSON(),1,220)
        }
    } catch ex {
        set status = "FAIL"
        set sc = ex.AsStatus()
        write !, "[FAIL] ", name, " -> ", ex.DisplayString()
    }
    quit
]]></Implementation>
</Method>

<Method name="HttpJson">
<ClassMethod>1</ClassMethod>
<FormalSpec>url:%String,method:%String=&quot;GET&quot;,body:%String=&quot;&quot;</FormalSpec>
<ReturnType>%DynamicObject</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set req = ##class(%Net.HttpRequest).%New()
    set req.Server = ..ExtractServer(url)
    set req.Port = ..ExtractPort(url)
    set req.Https = ..IsHttps(url)
    set req.SSLConfiguration = ""
    set req.ContentType = "application/json"
    set req.Timeout = 20
    if method="POST" {
        do req.EntityBody.Write(body)
        set sc = req.Post(..ExtractPath(url))
    } else {
        set sc = req.Get(..ExtractPath(url))
    }
    if $$$ISERR(sc) {
        do $system.Status.DecomposeStatus(sc,.errs)
        set msg = $get(errs(1))
        throw ##class(%Exception.General).%New("HTTP request failed: "_msg)
    }
    set rsp = req.HttpResponse
    set txt = rsp.Data.Read()
    if rsp.StatusCode<200 || rsp.StatusCode>299 {
        throw ##class(%Exception.General).%New("HTTP "_rsp.StatusCode_": "_$extract(txt,1,240))
    }
    quit ##class(%DynamicObject).%FromJSON(txt)
]]></Implementation>
</Method>

<Method name="IsHttps">
<ClassMethod>1</ClassMethod>
<FormalSpec>url:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    quit ($extract(url,1,8)="https://")
]]></Implementation>
</Method>

<Method name="ExtractServer">
<ClassMethod>1</ClassMethod>
<FormalSpec>url:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set u = $piece(url,"://",2,*)
    set hp = $piece(u,"/",1)
    quit $piece(hp,":",1)
]]></Implementation>
</Method>

<Method name="ExtractPort">
<ClassMethod>1</ClassMethod>
<FormalSpec>url:%String</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set u = $piece(url,"://",2,*)
    set hp = $piece(u,"/",1)
    set p = $piece(hp,":",2)
    if p="" quit $select(..IsHttps(url):443,1:80)
    quit +p
]]></Implementation>
</Method>

<Method name="ExtractPath">
<ClassMethod>1</ClassMethod>
<FormalSpec>url:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Private>1</Private>
<Implementation><![CDATA[
    set u = $piece(url,"://",2,*)
    set p = $piece(u,"/",2,*)
    quit "/"_p
]]></Implementation>
</Method>

</Class>

<Class name="AIAgent.UI.Chat">
<Super>%CSP.Page</Super>
<Parameter name="CONTENTTYPE">
<Description>Content type for this page.</Description>
<Default>text/html</Default>
</Parameter>

<Parameter name="PAGETITLE">
<Description>Page title shown in browser tab.</Description>
<Default>OpenLI IRIS CoPilot</Default>
</Parameter>

<Parameter name="SECURITYRESOURCE">
<Description>Require authenticated session.</Description>
<Default>%Development</Default>
</Parameter>

<Method name="OnPage">
<Description>Render the full chat interface as a single self-contained HTML page.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    &html<<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLI IRIS CoPilot</title>

    <!-- Alpine.js for reactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* ===== CSS Reset & Base ===== */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --nhs-blue: #005EB8;
            --nhs-blue-dark: #003d7a;
            --nhs-blue-light: #4189d4;
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1c2129;
            --bg-elevated: #21262d;
            --bg-hover: #292e36;
            --border-color: #30363d;
            --border-light: #3d444d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --user-bubble: #1a3a5c;
            --ai-bubble: #1c2129;
            --success: #2ea043;
            --warning: #d29922;
            --error: #f85149;
            --code-bg: #0d1117;
            --sidebar-width: 280px;
            --right-panel-width: 380px;
            --input-area-height: auto;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        /* ===== Scrollbar ===== */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

        /* ===== App Layout ===== */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* ===== Left Sidebar: Conversations ===== */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: margin-left var(--transition-normal), opacity var(--transition-normal);
            z-index: 20;
        }

        .sidebar.collapsed {
            margin-left: calc(-1 * var(--sidebar-width));
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-header h2 .logo-icon {
            width: 20px;
            height: 20px;
            background: var(--nhs-blue);
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
        }

        .btn-new-chat {
            background: var(--nhs-blue);
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background var(--transition-fast);
        }

        .btn-new-chat:hover { background: var(--nhs-blue-dark); }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .conversation-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background var(--transition-fast);
            margin-bottom: 2px;
        }

        .conversation-item:hover { background: var(--bg-hover); }

        .conversation-item.active {
            background: var(--nhs-blue);
            color: #fff;
        }

        .conversation-item .conv-title {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-item .conv-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .conversation-item.active .conv-meta { color: rgba(255,255,255,0.7); }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        /* ===== Main Chat Area ===== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            min-height: 48px;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-icon {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            width: 34px;
            height: 34px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all var(--transition-fast);
        }

        .btn-icon:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-light);
        }

        .conversation-title-display {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 400px;
        }

        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .health-badge.online {
            background: rgba(46, 160, 67, 0.15);
            color: var(--success);
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        .health-badge.offline {
            background: rgba(248, 81, 73, 0.15);
            color: var(--error);
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .health-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
        }

        .health-badge.online .health-dot { background: var(--success); }
        .health-badge.offline .health-dot { background: var(--error); }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 0;
        }

        .messages-inner {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px 24px;
        }

        .welcome-logo {
            width: 64px;
            height: 64px;
            background: var(--nhs-blue);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 24px;
        }

        .welcome-screen h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome-screen p {
            color: var(--text-secondary);
            font-size: 15px;
            max-width: 500px;
            margin-bottom: 32px;
        }

        .welcome-suggestions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 600px;
            width: 100%;
        }

        .suggestion-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 16px;
            text-align: left;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .suggestion-card:hover {
            border-color: var(--nhs-blue);
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .suggestion-card strong {
            display: block;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 13px;
        }

        /* Message Bubbles */
        .message-row {
            display: flex;
            margin-bottom: 24px;
            gap: 12px;
        }

        .message-row.user { justify-content: flex-end; }
        .message-row.assistant { justify-content: flex-start; }
        .message-row.system { justify-content: center; }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .message-row.assistant .message-avatar {
            background: var(--nhs-blue);
            color: #fff;
        }

        .message-row.user .message-avatar {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            word-break: break-word;
        }

        .message-row.user .message-bubble {
            background: var(--user-bubble);
            color: var(--text-primary);
            border-bottom-right-radius: 4px;
        }

        .message-row.assistant .message-bubble {
            background: var(--ai-bubble);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-row.system .message-bubble {
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            font-style: italic;
            padding: 4px 12px;
        }

        .message-bubble .message-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-row.user .message-bubble .message-meta { justify-content: flex-end; }

        .agent-badge {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 4px;
            background: rgba(0, 94, 184, 0.2);
            color: var(--nhs-blue-light);
            font-weight: 500;
        }

        .runner-badge {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 4px;
            background: rgba(210, 153, 34, 0.15);
            color: var(--warning);
            font-weight: 500;
        }

        /* Generation card within message */
        .generation-card {
            margin-top: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }

        .generation-card .gen-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .generation-card .gen-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--nhs-blue-light);
        }

        .generation-card .gen-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .gen-status.preview { background: rgba(210,153,34,0.15); color: var(--warning); }
        .gen-status.approved { background: rgba(46,160,67,0.15); color: var(--success); }
        .gen-status.deployed { background: rgba(0,94,184,0.15); color: var(--nhs-blue-light); }
        .gen-status.rejected { background: rgba(248,81,73,0.15); color: var(--error); }

        .generation-card .gen-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-approve, .btn-reject {
            padding: 5px 14px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-approve {
            background: var(--success);
            color: #fff;
        }

        .btn-approve:hover { background: #2c974b; }

        .btn-reject {
            background: transparent;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .btn-reject:hover { background: rgba(248,81,73,0.1); }

        /* Markdown rendered content */
        .message-bubble h1, .message-bubble h2, .message-bubble h3,
        .message-bubble h4, .message-bubble h5, .message-bubble h6 {
            margin: 16px 0 8px 0;
            font-weight: 600;
        }
        .message-bubble h1 { font-size: 1.3em; }
        .message-bubble h2 { font-size: 1.15em; }
        .message-bubble h3 { font-size: 1.05em; }

        .message-bubble p { margin: 8px 0; }
        .message-bubble p:first-child { margin-top: 0; }
        .message-bubble p:last-child { margin-bottom: 0; }

        .message-bubble ul, .message-bubble ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-bubble li { margin: 4px 0; }

        .message-bubble pre {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            overflow-x: auto;
            margin: 12px 0;
            font-size: 13px;
            line-height: 1.45;
        }

        .message-bubble code {
            font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .message-bubble :not(pre) code {
            background: var(--bg-elevated);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .message-bubble blockquote {
            border-left: 3px solid var(--nhs-blue);
            padding-left: 12px;
            margin: 8px 0;
            color: var(--text-secondary);
        }

        .message-bubble table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .message-bubble th, .message-bubble td {
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            text-align: left;
            font-size: 13px;
        }

        .message-bubble th {
            background: var(--bg-elevated);
            font-weight: 600;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--ai-bubble);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typing-bounce 1.4s ease-in-out infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        /* Input Area */
        .input-area {
            padding: 16px 24px 20px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-box {
            display: flex;
            align-items: flex-end;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 4px;
            transition: border-color var(--transition-fast);
        }

        .input-box:focus-within {
            border-color: var(--nhs-blue);
        }

        .input-box textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            line-height: 1.5;
            padding: 10px 14px;
            resize: none;
            max-height: 200px;
            min-height: 24px;
        }

        .input-box textarea::placeholder { color: var(--text-muted); }

        .btn-send {
            width: 36px;
            height: 36px;
            background: var(--nhs-blue);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin: 2px;
            transition: all var(--transition-fast);
        }

        .btn-send:hover { background: var(--nhs-blue-dark); }

        .btn-send:disabled {
            background: var(--bg-elevated);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .input-hint {
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* ===== Right Panel ===== */
        .right-panel {
            width: var(--right-panel-width);
            min-width: var(--right-panel-width);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: margin-right var(--transition-normal), opacity var(--transition-normal);
            z-index: 20;
            overflow: hidden;
        }

        .right-panel.collapsed {
            margin-right: calc(-1 * var(--right-panel-width));
            opacity: 0;
            pointer-events: none;
        }

        .right-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .right-panel-header h3 {
            font-size: 13px;
            font-weight: 600;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-tab {
            flex: 1;
            padding: 10px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--transition-fast);
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }

        .panel-tab:hover { color: var(--text-primary); }

        .panel-tab.active {
            color: var(--nhs-blue-light);
            border-bottom-color: var(--nhs-blue);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Code Review Section */
        .review-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 16px;
            font-size: 13px;
        }

        .review-class {
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .review-class-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .review-class-name {
            font-size: 12px;
            font-weight: 600;
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            color: var(--nhs-blue-light);
        }

        .review-class-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .review-class-source {
            padding: 12px;
            background: var(--code-bg);
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            color: var(--text-primary);
            max-height: 300px;
            overflow-y: auto;
        }

        .review-actions {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .review-actions .btn-approve,
        .review-actions .btn-reject { flex: 1; }

        /* Production Status Section */
        .status-section {
            margin-bottom: 20px;
        }

        .status-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .status-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .status-row:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .status-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-value {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .status-value.running { color: var(--success); }
        .status-value.stopped { color: var(--error); }
        .status-value.suspended { color: var(--warning); }

        /* Runner Status Section */
        .runner-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .runner-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .runner-model {
            font-size: 11px;
            color: var(--text-muted);
        }

        .runner-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .runner-status-dot.available { background: var(--success); }
        .runner-status-dot.unavailable { background: var(--error); }

        /* ===== Responsive ===== */
        @media (max-width: 1200px) {
            .right-panel { --right-panel-width: 320px; }
        }

        @media (max-width: 1024px) {
            .sidebar { --sidebar-width: 260px; }
            .right-panel {
                position: fixed;
                right: 0;
                top: 0;
                bottom: 0;
                z-index: 100;
                box-shadow: -4px 0 24px rgba(0,0,0,0.3);
            }
            .right-panel.collapsed {
                margin-right: 0;
                transform: translateX(100%);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 100;
                box-shadow: 4px 0 24px rgba(0,0,0,0.3);
            }
            .sidebar.collapsed {
                margin-left: 0;
                transform: translateX(-100%);
            }
            .welcome-suggestions {
                grid-template-columns: 1fr;
            }
            .message-bubble { max-width: 88%; }
            .conversation-title-display { max-width: 180px; }
        }

        /* ===== Overlay for mobile panels ===== */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 90;
            cursor: pointer;
        }

        /* ===== ObjectScript Syntax Highlighting ===== */
        .cos-keyword { color: #ff7b72; }
        .cos-string { color: #a5d6ff; }
        .cos-comment { color: #8b949e; font-style: italic; }
        .cos-classref { color: #d2a8ff; }
        .cos-macro { color: #7ee787; }
        .cos-number { color: #79c0ff; }
    </style>
</head>
<body>

<div class="app-container" x-data="chatApp()" x-init="init()">

    <!-- Mobile overlay when sidebar/panel is open -->
    <template x-if="showMobileOverlay">
        <div class="panel-overlay" @click="closePanels()"></div>
    </template>

    <!-- ===== LEFT SIDEBAR: Conversations ===== -->
    <aside class="sidebar" :class="{ 'collapsed': !sidebarOpen }">
        <div class="sidebar-header">
            <h2>
                <span class="logo-icon">IC</span>
                OpenLI IRIS CoPilot
            </h2>
            <button class="btn-new-chat" @click="createConversation()" :disabled="isStreaming">
                + New
            </button>
        </div>

        <div class="conversation-list">
            <template x-if="conversations.length === 0">
                <div style="text-align:center; color:var(--text-muted); padding:24px 8px; font-size:12px;">
                    No conversations yet.<br>Start a new chat to begin.
                </div>
            </template>
            <template x-for="conv in conversations" :key="conv.conversationId">
                <div class="conversation-item"
                     :class="{ 'active': currentConversationId === conv.conversationId }"
                     @click="selectConversation(conv.conversationId)">
                    <div class="conv-title" x-text="conv.title || 'New Conversation'"></div>
                    <div class="conv-meta" x-text="formatDate(conv.updatedAt || conv.createdAt)"></div>
                </div>
            </template>
        </div>

        <div class="sidebar-footer">
            IRIS AI Agent Platform &middot; <span x-text="currentNamespace"></span>
        </div>
    </aside>

    <!-- ===== MAIN CHAT AREA ===== -->
    <main class="main-area">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="btn-icon" @click="sidebarOpen = !sidebarOpen"
                        title="Toggle sidebar">
                    &#9776;
                </button>
                <span class="conversation-title-display"
                      x-text="currentConversation ? (currentConversation.title || 'New Conversation') : 'OpenLI IRIS CoPilot'">
                </span>
            </div>
            <div class="top-bar-right">
                <div class="health-badge" :class="bridgeHealthy ? 'online' : 'offline'">
                    <span class="health-dot"></span>
                    <span x-text="bridgeHealthy ? 'Bridge Online' : 'Bridge Offline'"></span>
                </div>
                <button class="btn-icon" @click="rightPanelOpen = !rightPanelOpen"
                        title="Toggle details panel">
                    &#9881;
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div class="messages-container" x-ref="messagesContainer">
            <!-- Welcome screen when no conversation selected -->
            <template x-if="!currentConversationId">
                <div class="welcome-screen">
                    <div class="welcome-logo">IC</div>
                    <h1>OpenLI IRIS CoPilot</h1>
                    <p>AI-powered assistant for building and managing InterSystems IRIS interoperability productions. Ask me to create services, processes, operations, transforms, and more.</p>
                    <div class="welcome-suggestions">
                        <div class="suggestion-card" @click="useSuggestion('List all production hosts with full details.')">
                            <strong>Production Topology</strong>
                            List all hosts with class, category, and enabled state
                        </div>
                        <div class="suggestion-card" @click="useSuggestion('Show queue depth for all hosts.')">
                            <strong>Queue Depth</strong>
                            Show queue counts across production hosts
                        </div>
                        <div class="suggestion-card" @click="useSuggestion('Show recent production events.')">
                            <strong>Recent Events</strong>
                            Review latest production event log entries
                        </div>
                        <div class="suggestion-card" @click="useSuggestion('Show lookup table ErrorCodes content.')">
                            <strong>Lookup Content</strong>
                            Read live lookup table values from IRIS
                        </div>
                    </div>
                </div>
            </template>

            <!-- Conversation messages -->
            <template x-if="currentConversationId">
                <div class="messages-inner">
                    <template x-for="msg in messages" :key="msg.messageId">
                        <div class="message-row" :class="msg.role">
                            <!-- AI avatar (left) -->
                            <template x-if="msg.role === 'assistant'">
                                <div class="message-avatar">IC</div>
                            </template>

                            <!-- Bubble -->
                            <div class="message-bubble">
                                <template x-if="msg.role === 'assistant'">
                                    <div x-html="renderMarkdown(formatDisplayContent(msg.content))"></div>
                                </template>
                                <template x-if="msg.role !== 'assistant'">
                                    <div x-text="msg.content"></div>
                                </template>

                                <!-- Generation card if attached -->
                                <template x-if="msg.generationId">
                                    <div class="generation-card">
                                        <div class="gen-header">
                                            <span class="gen-title">Code Generation</span>
                                            <span class="gen-status"
                                                  :class="getGenerationStatus(msg.generationId)"
                                                  x-text="getGenerationStatus(msg.generationId)">
                                            </span>
                                        </div>
                                        <div style="font-size:12px; color:var(--text-secondary); margin-bottom:8px;"
                                             x-text="getGenerationDescription(msg.generationId)"></div>
                                        <template x-if="getGenerationStatus(msg.generationId) === 'preview'">
                                            <div class="gen-actions">
                                                <button class="btn-approve" @click="approveGeneration(msg.generationId)">
                                                    Approve &amp; Deploy
                                                </button>
                                                <button class="btn-reject" @click="rejectGeneration(msg.generationId)">
                                                    Reject
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Meta -->
                                <template x-if="msg.role !== 'system'">
                                    <div class="message-meta">
                                        <span x-text="formatTime(msg.timestamp)"></span>
                                        <template x-if="msg.agentName">
                                            <span class="agent-badge" x-text="msg.agentName"></span>
                                        </template>
                                        <template x-if="msg.runnerUsed">
                                            <span class="runner-badge" x-text="msg.runnerUsed"></span>
                                        </template>
                                    </div>
                                </template>
                            </div>

                            <!-- User avatar (right) -->
                            <template x-if="msg.role === 'user'">
                                <div class="message-avatar" x-text="userInitials"></div>
                            </template>
                        </div>
                    </template>

                    <!-- Streaming message in progress -->
                    <template x-if="isStreaming && streamingContent">
                        <div class="message-row assistant">
                            <div class="message-avatar">IC</div>
                            <div class="message-bubble">
                                <div x-html="renderMarkdown(formatDisplayContent(streamingContent))"></div>
                            </div>
                        </div>
                    </template>

                    <!-- Typing indicator -->
                    <template x-if="isStreaming && !streamingContent">
                        <div class="typing-indicator">
                            <div class="message-avatar" style="background:var(--nhs-blue); color:#fff; width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:600;">IC</div>
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-wrapper">
                <div class="input-box">
                    <textarea x-ref="chatInput"
                              x-model="inputText"
                              @keydown.enter.prevent="handleEnter($event)"
                              @input="autoResize($event)"
                              placeholder="Describe what you want to build..."
                              rows="1"
                              :disabled="isStreaming"></textarea>
                    <button class="btn-send"
                            @click="sendMessage()"
                            :disabled="!inputText.trim() || isStreaming"
                            title="Send message">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M14.5 1.5L7 9M14.5 1.5L10 14.5L7 9M14.5 1.5L1.5 6L7 9"
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <div class="input-hint">
                    Press <strong>Enter</strong> to send, <strong>Shift+Enter</strong> for new line
                </div>
            </div>
        </div>
    </main>

    <!-- ===== RIGHT PANEL: Details ===== -->
    <aside class="right-panel" :class="{ 'collapsed': !rightPanelOpen }">
        <div class="right-panel-header">
            <h3>Details</h3>
            <button class="btn-icon" @click="rightPanelOpen = false" style="width:28px;height:28px;font-size:14px;">
                &#10005;
            </button>
        </div>

        <!-- Tabs -->
        <div class="panel-tabs">
            <button class="panel-tab" :class="{ 'active': panelTab === 'review' }"
                    @click="panelTab = 'review'">Code Review</button>
            <button class="panel-tab" :class="{ 'active': panelTab === 'production' }"
                    @click="panelTab = 'production'">Production</button>
            <button class="panel-tab" :class="{ 'active': panelTab === 'runners' }"
                    @click="panelTab = 'runners'">Runners</button>
            <button class="panel-tab" :class="{ 'active': panelTab === 'raw' }"
                    @click="panelTab = 'raw'">Raw</button>
        </div>

        <div class="panel-content">

            <!-- Code Review Tab -->
            <template x-if="panelTab === 'review'">
                <div>
                    <template x-if="!activeGeneration">
                        <div class="review-empty">
                            No code generation to review.<br>
                            Chat with the AI to generate InterSystems classes.
                        </div>
                    </template>
                    <template x-if="activeGeneration">
                        <div>
                            <div style="margin-bottom:12px;">
                                <div style="font-size:13px; font-weight:600; margin-bottom:4px;"
                                     x-text="activeGeneration.description || 'Generated Code'"></div>
                                <div style="font-size:11px; color:var(--text-muted);">
                                    <span x-text="(activeGeneration.classes || []).length"></span> class(es) &middot;
                                    Status: <span class="gen-status" :class="activeGeneration.status"
                                                  x-text="activeGeneration.status"></span>
                                </div>
                            </div>

                            <template x-for="cls in (activeGeneration.classes || [])" :key="cls.className">
                                <div class="review-class">
                                    <div class="review-class-header">
                                        <span class="review-class-name" x-text="cls.className"></span>
                                        <span class="review-class-type" x-text="cls.classType || 'Class'"></span>
                                    </div>
                                    <div class="review-class-source" x-html="highlightCOS(cls.source || '')"></div>
                                    <template x-if="cls.compileStatus === 'error'">
                                        <div style="padding:8px 12px; font-size:12px; color:var(--error); background:rgba(248,81,73,0.08); border-top:1px solid var(--border-color);">
                                            <strong>Compile Error:</strong> <span x-text="cls.compileErrors"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <template x-if="activeGeneration.status === 'preview'">
                                <div class="review-actions" style="padding:12px 0; border-top:none;">
                                    <button class="btn-approve" @click="approveGeneration(activeGeneration.generationId)">
                                        Approve &amp; Deploy All
                                    </button>
                                    <button class="btn-reject" @click="rejectGeneration(activeGeneration.generationId)">
                                        Reject All
                                    </button>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>

            <!-- Production Status Tab -->
            <template x-if="panelTab === 'production'">
                <div>
                    <div class="status-section">
                        <div class="status-section-title">Current Production</div>
                        <div class="status-card">
                            <div class="status-row">
                                <span class="status-label">Name</span>
                                <span class="status-value" x-text="productionStatus.name || 'None'"></span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">Status</span>
                                <span class="status-value"
                                      :class="(productionStatus.status || '').toLowerCase()"
                                      x-text="productionStatus.status || 'Unknown'"></span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">Namespace</span>
                                <span class="status-value" x-text="currentNamespace"></span>
                            </div>
                            <template x-if="productionStatus.lastStarted">
                                <div class="status-row">
                                    <span class="status-label">Started</span>
                                    <span class="status-value" x-text="formatDate(productionStatus.lastStarted)"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <template x-if="productionStatus.hosts && productionStatus.hosts.length">
                        <div class="status-section">
                            <div class="status-section-title">Business Hosts</div>
                            <div class="status-card" style="padding:0;">
                                <template x-for="host in productionStatus.hosts" :key="host.name">
                                    <div class="status-row" style="padding:8px 12px;">
                                        <span class="status-label" x-text="host.name" style="font-size:11px; font-family:monospace;"></span>
                                        <span class="status-value" :class="(host.status || '').toLowerCase()"
                                              x-text="host.status || 'Unknown'" style="font-size:11px;"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <button class="btn-new-chat" @click="refreshProductionStatus()" style="width:100%; justify-content:center; margin-top:8px;">
                        Refresh Status
                    </button>
                </div>
            </template>

            <!-- Runners Tab -->
            <template x-if="panelTab === 'runners'">
                <div>
                    <div class="status-section-title" style="margin-bottom:12px;">Available AI Runners</div>
                    <div class="status-row" style="margin-bottom:10px;">
                        <span class="status-label">Selected Runner</span>
                        <span class="status-value" x-text="selectedRunner || 'Server Default'"></span>
                    </div>
                    <template x-if="runners.length === 0">
                        <div class="review-empty" style="padding:24px;">
                            No runners detected.<br>
                            Ensure the AI Agent Bridge is running.
                        </div>
                    </template>
                    <template x-for="runner in runners" :key="runner.id || runner.name">
                        <div class="runner-item">
                            <div>
                                <div class="runner-name" x-text="runner.name || runner.id"></div>
                                <div class="runner-model" x-text="runner.model || runner.description || ''"></div>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button class="btn-icon"
                                        :disabled="runner.available === false || runner.isPlaceholder"
                                        :title="runner.available === false ? 'Unavailable' : 'Use this runner'"
                                        @click="selectRunner(runner.id)"
                                        style="width:auto; padding:2px 8px; border-radius:6px;"
                                        x-text="selectedRunner === runner.id ? 'Selected' : 'Use'">
                                </button>
                                <div class="runner-status-dot"
                                     :class="runner.available !== false ? 'available' : 'unavailable'"
                                     :title="runner.available !== false ? 'Available' : 'Unavailable'">
                                </div>
                            </div>
                        </div>
                    </template>

                    <button class="btn-new-chat" @click="refreshRunners()" style="width:100%; justify-content:center; margin-top:12px;">
                        Refresh Runners
                    </button>
                </div>
            </template>

            <!-- Raw Tab -->
            <template x-if="panelTab === 'raw'">
                <div>
                    <div class="status-section-title" style="margin-bottom:12px;">Raw Stream Responses</div>
                    <template x-if="rawResponses.length === 0">
                        <div class="review-empty" style="padding:24px;">
                            No raw stream events captured yet.
                        </div>
                    </template>
                    <template x-if="rawResponses.length !== 0">
                        <div style="display:flex; flex-direction:column; gap:8px; max-height:58vh; overflow:auto;">
                            <template x-for="(evt, idx) in rawResponses" :key="idx">
                                <div style="background:#111827; color:#d1d5db; border-radius:8px; padding:8px;">
                                    <div style="font-size:11px; color:#93c5fd; margin-bottom:4px;" x-text="evt.timestamp + '  ' + evt.kind"></div>
                                    <pre style="margin:0; white-space:pre-wrap; font-size:11px;" x-text="evt.raw"></pre>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>

        </div>
    </aside>

</div>
>
    // Output JavaScript from XData block (avoids CSP &html<> bracket parsing issues)
    do ..WriteScript()
    &html<
</body>
</html>>
    quit $$$OK
]]></Implementation>
</Method>

<Method name="WriteScript">
<Description>Write JavaScript to the output device from XData block.
This avoids CSP &amp;html&lt;&gt; bracket parsing issues with JS arrow functions,
comparison operators, and other special characters.</Description>
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<Implementation><![CDATA[
    write "<script>",!
    set xdata = ##class(%Dictionary.XDataDefinition).IDKEYOpen("AIAgent.UI.Chat","ChatScript")
    if $isobject(xdata) {
        while 'xdata.Data.AtEnd {
            write xdata.Data.ReadLine(),!
        }
    }
    write "</script>",!
]]></Implementation>
</Method>

<XData name="ChatScript">
<MimeType>application/javascript</MimeType>
<Data><![CDATA[
// ===== Marked.js Configuration =====
if (typeof marked !== 'undefined') {
    marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false
    });
}

// ===== Alpine.js Chat Application =====
function chatApp() {
    return {
        // ----- State -----
        sidebarOpen: true,
        rightPanelOpen: false,
        panelTab: 'review',

        conversations: [],
        currentConversationId: null,
        currentConversation: null,
        messages: [],

        inputText: '',
        isStreaming: false,
        streamingContent: '',
        eventSource: null,
        rawResponses: [],

        bridgeHealthy: false,
        productionStatus: {},
        runners: [],
        selectedRunner: '',
        generations: {},

        currentNamespace: '',
        userInitials: 'U',

        // ----- Computed -----
        get showMobileOverlay() {
            if (window.innerWidth > 1024) return false;
            return (this.sidebarOpen || this.rightPanelOpen);
        },

        get activeGeneration() {
            let active = null;
            for (const msg of this.messages) {
                if (msg.generationId && this.generations[msg.generationId]) {
                    const gen = this.generations[msg.generationId];
                    if (!active || gen.status === 'preview') {
                        active = gen;
                    }
                }
            }
            return active;
        },

        // ----- Initialization -----
        async init() {
            this.currentNamespace = this.getNamespaceFromUrl();
            this.userInitials = this.getUserInitials();
            try { this.selectedRunner = localStorage.getItem('aiagent.selectedRunner') || ''; } catch (e) {}
            this.currentConversationId = this.getStoredConversationId();

            await Promise.allSettled([
                this.loadConversations(),
                this.checkHealth(),
                this.refreshRunners()
            ]);
            await this.restoreConversationAfterRefresh();

            // Periodic health check (30 minutes to reduce runner probe traffic)
            setInterval(() => { this.checkHealth(); }, 1800000);

            // Focus the input
            this.$nextTick(() => {
                if (this.$refs.chatInput) this.$refs.chatInput.focus();
            });
        },

        getNamespaceFromUrl() {
            const path = window.location.pathname;
            const match = path.match(/\/csp\/([^\/]+)\//i);
            return match ? match[1].toUpperCase() : 'USER';
        },

        getUserInitials() {
            return 'U';
        },

        // ----- API Helpers -----
        getBaseUrl() {
            return '/ai';
        },

        async apiFetch(path, options = {}) {
            const url = this.getBaseUrl() + path;
            const defaults = {
                headers: { 'Content-Type': 'application/json' }
            };
            const config = { ...defaults, ...options };
            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }
            try {
                const response = await fetch(url, config);
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error('HTTP ' + response.status + ': ' + text);
                }
                return await response.json();
            } catch (err) {
                console.error('API error:', path, err);
                throw err;
            }
        },

        unwrapApi(result) {
            if (result && typeof result === 'object' && Object.prototype.hasOwnProperty.call(result, 'data')) {
                return result.data;
            }
            return result;
        },

        getStoredConversationId() {
            try { return localStorage.getItem('aiagent.currentConversationId') || ''; } catch (e) {}
            return '';
        },

        storeConversationId(id) {
            try {
                if (id) localStorage.setItem('aiagent.currentConversationId', id);
                else localStorage.removeItem('aiagent.currentConversationId');
            } catch (e) {}
        },

        // ----- Conversations -----
        async loadConversations() {
            try {
                const result = await this.apiFetch('/conversations');
                const payload = this.unwrapApi(result);
                if (Array.isArray(payload)) {
                    this.conversations = payload;
                } else if (payload && Array.isArray(payload.data)) {
                    this.conversations = payload.data;
                } else {
                    this.conversations = [];
                }
            } catch (err) {
                console.error('Failed to load conversations:', err);
                this.conversations = [];
            }
        },

        async restoreConversationAfterRefresh() {
            if (!Array.isArray(this.conversations) || this.conversations.length === 0) return;
            const savedId = this.currentConversationId || this.getStoredConversationId();
            if (savedId && this.conversations.some(c => c.conversationId === savedId)) {
                await this.selectConversation(savedId);
                return;
            }
            await this.selectConversation(this.conversations[0].conversationId);
        },

        async selectConversation(id) {
            if (this.isStreaming) return;
            this.currentConversationId = id;
            this.storeConversationId(id);
            this.messages = [];
            this.streamingContent = '';
            this.rawResponses = [];
            this.generations = {};

            try {
                const result = await this.apiFetch('/conversations/' + id);
                const payload = this.unwrapApi(result) || {};
                this.currentConversation = payload.conversation || payload;
                this.messages = payload.messages || [];

                for (const msg of this.messages) {
                    if (msg.generationId && !this.generations[msg.generationId]) {
                        await this.loadGeneration(msg.generationId);
                    }
                }
            } catch (err) {
                console.error('Failed to load conversation:', err);
            }

            this.scrollToBottom();
            this.closePanels();

            this.$nextTick(() => {
                if (this.$refs.chatInput) this.$refs.chatInput.focus();
            });
        },

        async createConversation() {
            if (this.isStreaming) return;
            try {
                const result = await this.apiFetch('/conversations', {
                    method: 'POST',
                    body: { title: '', targetNamespace: this.currentNamespace }
                });
                const payload = this.unwrapApi(result) || {};
                const conv = payload.conversation || payload;
                if (conv && conv.conversationId) {
                    this.conversations.unshift(conv);
                    this.currentConversationId = conv.conversationId;
                    this.storeConversationId(conv.conversationId);
                    this.currentConversation = conv;
                    this.messages = [];
                    this.generations = {};
                    this.streamingContent = '';
                }
            } catch (err) {
                console.error('Failed to create conversation:', err);
            }

            this.$nextTick(() => {
                if (this.$refs.chatInput) this.$refs.chatInput.focus();
            });
        },

        async loadGeneration(generationId) {
            try {
                const result = await this.apiFetch('/generations/' + generationId);
                const payload = this.unwrapApi(result) || {};
                const gen = payload.generation || payload;
                if (gen) {
                    this.generations[generationId] = gen;
                }
            } catch (err) {
                console.error('Failed to load generation:', err);
            }
        },

        // ----- Messaging -----
        handleEnter(event) {
            if (event.shiftKey) {
                const ta = event.target;
                const start = ta.selectionStart;
                const end = ta.selectionEnd;
                this.inputText = this.inputText.substring(0, start) + '\n' + this.inputText.substring(end);
                this.$nextTick(() => {
                    ta.selectionStart = ta.selectionEnd = start + 1;
                    this.autoResize({ target: ta });
                });
                return;
            }
            this.sendMessage();
        },

        async sendMessage() {
            const text = this.inputText.trim();
            if (!text || this.isStreaming) return;

            if (!this.currentConversationId) {
                await this.createConversation();
                if (!this.currentConversationId) return;
            }

            const userMsg = {
                messageId: 'temp-' + Date.now(),
                conversationId: this.currentConversationId,
                role: 'user',
                content: text,
                timestamp: new Date().toISOString()
            };
            this.messages.push(userMsg);
            this.inputText = '';

            if (this.$refs.chatInput) {
                this.$refs.chatInput.style.height = 'auto';
            }

            this.scrollToBottom();

            this.isStreaming = true;
            this.streamingContent = '';
            this.rawResponses = [];

            try {
                const streamUrl = this.getBaseUrl() + '/chat/stream';
                const body = JSON.stringify({
                    conversationId: this.currentConversationId,
                    message: text,
                    namespace: this.currentNamespace,
                    preferredRunner: this.selectedRunner || undefined
                });

                const response = await fetch(streamUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });

                if (!response.ok) {
                    throw new Error('Stream request failed: HTTP ' + response.status);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let assistantMsg = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (jsonStr === '[DONE]') {
                                continue;
                            }
                            try {
                                const chunk = JSON.parse(jsonStr);
                                this.captureRawResponse('sse-json', jsonStr);

                                if (chunk.token) {
                                    this.streamingContent += chunk.token;
                                    this.scrollToBottom();
                                }

                                if (chunk.response && !this.streamingContent) {
                                    this.streamingContent += chunk.response;
                                    this.scrollToBottom();
                                }
                                if (chunk.finalResponse) {
                                    this.streamingContent = chunk.finalResponse;
                                    this.scrollToBottom();
                                }

                                if (chunk.runner) {
                                    if (!assistantMsg) assistantMsg = {};
                                    assistantMsg.runner = chunk.runner;
                                }

                                if (chunk.error) {
                                    this.streamingContent += '\n\n**Error:** ' + chunk.error;
                                }

                                if (chunk.messageId) {
                                    assistantMsg = chunk;
                                }

                                if (chunk.generationId) {
                                    await this.loadGeneration(chunk.generationId);
                                    if (assistantMsg) {
                                        assistantMsg.generationId = chunk.generationId;
                                    }
                                }
                            } catch (parseErr) {
                                this.captureRawResponse('sse-raw', jsonStr);
                            }
                        }
                    }
                }

                if (this.streamingContent && this.streamingContent.trim()) {
                    const finalMsg = {
                        messageId: (assistantMsg && assistantMsg.messageId) || ('ai-' + Date.now()),
                        conversationId: this.currentConversationId,
                        role: 'assistant',
                        content: this.streamingContent,
                        timestamp: new Date().toISOString(),
                        agentName: assistantMsg ? assistantMsg.agent : '',
                        runnerUsed: assistantMsg ? assistantMsg.runner : (this.selectedRunner || ''),
                        generationId: assistantMsg ? assistantMsg.generationId : ''
                    };
                    this.messages.push(finalMsg);

                    if (finalMsg.generationId) {
                        this.panelTab = 'review';
                        this.rightPanelOpen = true;
                    }
                } else {
                    this.messages.push({
                        messageId: 'sys-' + Date.now(),
                        conversationId: this.currentConversationId,
                        role: 'system',
                        content: 'No response payload was returned from the stream.',
                        timestamp: new Date().toISOString()
                    });
                }

                if (this.currentConversation &&
                    (!this.currentConversation.title || this.currentConversation.title === 'New Conversation')) {
                    this.currentConversation.title = text.substring(0, 100);
                    const idx = this.conversations.findIndex(c => c.conversationId === this.currentConversationId);
                    if (idx !== -1) {
                        this.conversations[idx].title = this.currentConversation.title;
                    }
                }

            } catch (err) {
                console.error('Stream error:', err);
                this.messages.push({
                    messageId: 'err-' + Date.now(),
                    conversationId: this.currentConversationId,
                    role: 'system',
                    content: 'Connection error: ' + err.message,
                    timestamp: new Date().toISOString()
                });
            } finally {
                this.isStreaming = false;
                this.streamingContent = '';
                await this.reloadCurrentConversation();
                this.scrollToBottom();
                this.$nextTick(() => {
                    if (this.$refs.chatInput) this.$refs.chatInput.focus();
                });
            }
        },

        async reloadCurrentConversation() {
            if (!this.currentConversationId) return;
            try {
                const result = await this.apiFetch('/conversations/' + this.currentConversationId);
                const payload = this.unwrapApi(result) || {};
                this.currentConversation = payload.conversation || payload;
                this.messages = payload.messages || [];
            } catch (err) {
                console.error('Failed to reload conversation:', err);
            }
        },

        captureRawResponse(kind, raw) {
            this.rawResponses.push({
                timestamp: new Date().toLocaleTimeString(),
                kind: kind || 'raw',
                raw: String(raw || '')
            });
            if (this.rawResponses.length > 200) {
                this.rawResponses = this.rawResponses.slice(this.rawResponses.length - 200);
            }
        },

        useSuggestion(text) {
            this.inputText = text;
            this.$nextTick(() => {
                this.sendMessage();
            });
        },

        // ----- Code Generation Actions -----
        async approveGeneration(generationId) {
            try {
                const result = await this.apiFetch('/generate/approve', {
                    method: 'POST',
                    body: { generationId: generationId }
                });

                await this.loadGeneration(generationId);

                const gen = this.generations[generationId];
                const statusText = (result.success || (gen && gen.status === 'deployed'))
                    ? 'Code generation approved and deployed successfully.'
                    : 'Code generation approved. ' + (result.message || '');

                this.messages.push({
                    messageId: 'sys-' + Date.now(),
                    conversationId: this.currentConversationId,
                    role: 'system',
                    content: statusText,
                    timestamp: new Date().toISOString()
                });

                this.scrollToBottom();
                this.refreshProductionStatus();
            } catch (err) {
                console.error('Approve failed:', err);
                this.messages.push({
                    messageId: 'err-' + Date.now(),
                    conversationId: this.currentConversationId,
                    role: 'system',
                    content: 'Approval failed: ' + err.message,
                    timestamp: new Date().toISOString()
                });
            }
        },

        async rejectGeneration(generationId) {
            try {
                await this.apiFetch('/generate/reject', {
                    method: 'POST',
                    body: { generationId: generationId }
                });

                await this.loadGeneration(generationId);

                this.messages.push({
                    messageId: 'sys-' + Date.now(),
                    conversationId: this.currentConversationId,
                    role: 'system',
                    content: 'Code generation rejected.',
                    timestamp: new Date().toISOString()
                });

                this.scrollToBottom();
            } catch (err) {
                console.error('Reject failed:', err);
            }
        },

        // ----- Health / Status -----
        async checkHealth() {
            try {
                const result = await this.apiFetch('/health');
                const payload = this.unwrapApi(result) || {};
                this.bridgeHealthy = !!(payload.healthy || payload.bridgeHealthy || result.status === 'ok');
                if (payload.namespace) this.currentNamespace = payload.namespace;
                if (payload.production) this.productionStatus = payload.production;
            } catch (err) {
                this.bridgeHealthy = false;
            }
        },

        async refreshProductionStatus() {
            try {
                const result = await this.apiFetch('/health');
                const payload = this.unwrapApi(result) || {};
                if (payload.production) {
                    this.productionStatus = payload.production;
                }
            } catch (err) {
                console.error('Failed to refresh production status:', err);
            }
        },

        async refreshRunners() {
            try {
                const result = await this.apiFetch('/runners');
                const payload = this.unwrapApi(result);
                this.runners = this.normalizeRunners(payload);
                this.ensureSelectedRunner();
            } catch (err) {
                console.error('Failed to load runners:', err);
                this.runners = [];
            }
        },

        normalizeRunners(payload) {
            const raw = Array.isArray(payload) ? payload : [];
            const runners = raw.map((r) => {
                const available = !!(r && r.health && r.health.healthy);
                return {
                    id: r.id || '',
                    name: r.name || r.id || 'Unknown',
                    model: (r.health && r.health.model) || '',
                    available: available,
                    isPlaceholder: false
                };
            });
            const ids = new Set(runners.map(r => r.id));
            if (!ids.has('azure-openai-codex')) {
                runners.push({ id: 'azure-openai-codex', name: 'Azure OpenAI Codex', model: 'Coming soon', available: false, isPlaceholder: true });
            }
            if (!ids.has('google-gemini')) {
                runners.push({ id: 'google-gemini', name: 'Google Gemini', model: 'Coming soon', available: false, isPlaceholder: true });
            }
            return runners;
        },

        ensureSelectedRunner() {
            if (!this.selectedRunner) return;
            const exists = this.runners.some(r => r.id === this.selectedRunner && !r.isPlaceholder);
            if (!exists) {
                this.selectedRunner = '';
                try { localStorage.removeItem('aiagent.selectedRunner'); } catch (e) {}
            }
        },

        selectRunner(runnerId) {
            this.selectedRunner = runnerId || '';
            try { localStorage.setItem('aiagent.selectedRunner', this.selectedRunner); } catch (e) {}
        },

        // ----- Generation Helpers -----
        getGenerationStatus(generationId) {
            const gen = this.generations[generationId];
            return gen ? gen.status : 'preview';
        },

        getGenerationDescription(generationId) {
            const gen = this.generations[generationId];
            if (!gen) return '';
            const count = (gen.classes || []).length;
            return (gen.description || 'Generated code') + ' (' + count + ' class' + (count !== 1 ? 'es' : '') + ')';
        },

        // ----- Rendering Helpers -----
        renderMarkdown(text) {
            if (!text) return '';
            try {
                if (typeof marked !== 'undefined' && marked.parse) {
                    return marked.parse(text);
                }
            } catch (err) {
                console.error('Markdown rendering error:', err);
            }
            return this.escapeHtml(text).replace(/\n/g, '<br>');
        },

        formatDisplayContent(text) {
            if (!text || typeof text !== 'string') return text || '';
            const trimmed = text.trim();
            if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                try {
                    const parsed = JSON.parse(trimmed);
                    if (parsed && typeof parsed.response === 'string' && parsed.response.trim()) {
                        return parsed.response;
                    }
                } catch (e) {}
            }
            return text;
        },

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        highlightCOS(source) {
            if (!source) return '';
            let html = this.escapeHtml(source);

            // Line comments
            html = html.replace(/(\/\/.*$)/gm, '<span class="cos-comment">$1</span>');
            // Semicolon comments
            html = html.replace(/(;[^"]*$)/gm, (match) => {
                if (match.indexOf('cos-string') === -1) {
                    return '<span class="cos-comment">' + match + '</span>';
                }
                return match;
            });

            // Strings
            html = html.replace(/(&quot;[^&]*?&quot;)/g, '<span class="cos-string">$1</span>');

            // Macros
            html = html.replace(/(\$\$\$\w+)/g, '<span class="cos-macro">$1</span>');

            // System functions and variables
            html = html.replace(/(\$\w+)/g, '<span class="cos-number">$1</span>');

            // Class references
            html = html.replace(/(##class\([^)]*\))/gi, '<span class="cos-classref">$1</span>');

            // Keywords
            const keywords = [
                'Class', 'Extends', 'Property', 'Parameter', 'Method', 'ClassMethod',
                'As', 'set', 'do', 'if', 'else', 'elseif', 'while', 'for', 'quit',
                'return', 'try', 'catch', 'throw', 'continue', 'new', 'kill',
                'write', 'read', 'open', 'close', 'use', 'lock', 'unlock',
                'Index', 'ForeignKey', 'Trigger', 'Query', 'Storage',
                'Private', 'Abstract', 'Final', 'Required', 'Unique',
                'Relationship', 'SqlProc', 'SqlQuery', 'WebMethod'
            ];
            const kwPattern = new RegExp('\\b(' + keywords.join('|') + ')\\b', 'g');
            html = html.replace(kwPattern, '<span class="cos-keyword">$1</span>');

            return html;
        },

        // ----- Date/Time Formatting -----
        formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                const now = new Date();
                const diffMs = now - d;
                const diffMins = Math.floor(diffMs / 60000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return diffMins + 'm ago';
                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return diffHours + 'h ago';
                const diffDays = Math.floor(diffHours / 24);
                if (diffDays < 7) return diffDays + 'd ago';

                return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        },

        formatTime(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return dateStr;
            }
        },

        // ----- UI Helpers -----
        autoResize(event) {
            const ta = event.target;
            ta.style.height = 'auto';
            ta.style.height = Math.min(ta.scrollHeight, 200) + 'px';
        },

        scrollToBottom() {
            this.$nextTick(() => {
                var container = this.$refs.messagesContainer;
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            });
        },

        closePanels() {
            if (window.innerWidth <= 1024) {
                this.rightPanelOpen = false;
            }
            if (window.innerWidth <= 768) {
                this.sidebarOpen = false;
            }
        }
    };
}
]]></Data>
</XData>

</Class>

<Class name="AIAgent.Install.Installer">
<Description>Standalone installer for the IRIS AI Agent Platform (IRIS Copilot).
Deploys the AIAgent package to any IRIS HealthConnect instance.

Usage from IRIS terminal:
do ##class(AIAgent.Install.Installer).Run()
do ##class(AIAgent.Install.Installer).Configure(&quot;http://localhost:3100&quot;, &quot;sk-ant-...&quot;, &quot;sk-...&quot;)
do ##class(AIAgent.Install.Installer).Uninstall()

Part of the IRIS AI Agent Platform (IRIS Copilot).</Description>
<Abstract>1</Abstract>
<Parameter name="WEBAPP">
<Description>The CSP web application path.</Description>
<Default>/ai</Default>
</Parameter>

<Parameter name="PACKAGE">
<Description>The COS package name.</Description>
<Default>AIAgent</Default>
</Parameter>

<Parameter name="GLOBALPREFIX">
<Description>Global prefix for all AIAgent data.</Description>
<Default>^AIAgent</Default>
</Parameter>

<Method name="Run">
<Description>Run the full installation.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    write !, "================================================================"
    write !, "  IRIS AI Agent Platform (IRIS Copilot) — Installer"
    write !, "================================================================"
    write !

    // Step 1: Check prerequisites
    write !, "[1/5] Checking prerequisites..."
    set sc = ..CheckPrerequisites()
    if $$$ISERR(sc) {
        write !, "  ERROR: Prerequisites not met: ", $system.Status.GetOneErrorText(sc)
        return sc
    }
    write !, "  OK — IRIS HealthConnect/Ensemble available"
    write !, "  OK — Namespace: ", $namespace

    // Step 2: Create Web Application
    write !, ""
    write !, "[2/5] Creating web application ", ..#WEBAPP, "..."
    set sc = ..CreateWebApplication()
    if $$$ISERR(sc) {
        write !, "  ERROR: ", $system.Status.GetOneErrorText(sc)
        return sc
    }
    write !, "  OK — Web application ", ..#WEBAPP, " configured"

    // Step 3: Initialize data structures
    write !, ""
    write !, "[3/5] Initializing data structures..."
    set sc = ..InitializeData()
    if $$$ISERR(sc) {
        write !, "  ERROR: ", $system.Status.GetOneErrorText(sc)
        return sc
    }
    write !, "  OK — Globals and indices ready"

    // Step 4: Verify compilation
    write !, ""
    write !, "[4/5] Verifying class compilation..."
    set sc = ..VerifyCompilation()
    if $$$ISERR(sc) {
        write !, "  WARNING: Some classes may need recompilation"
    } else {
        write !, "  OK — All AIAgent classes compiled"
    }

    // Step 5: Print summary
    write !, ""
    write !, "[5/5] Installation complete!"
    write !, ""
    write !, "================================================================"
    write !, "  IRIS Copilot installed successfully"
    write !, "================================================================"
    write !, ""
    write !, "  Chat UI:    https://<iris-host>", ..#WEBAPP, "/AIAgent.UI.Chat.cls"
    write !, "  REST API:   https://<iris-host>", ..#WEBAPP, "/health"
    write !, "  Namespace:  ", $namespace
    write !, ""
    write !, "  Next steps:"
    write !, "  1. Configure AI keys:"
    write !, "     do ##class(AIAgent.Install.Installer).Configure(bridgeUrl, anthropicKey, openaiKey)"
    write !, "  2. Start the Node.js bridge:"
    write !, "     cd AIAgent/bridge && npm install && npm start"
    write !, "  3. Open the Chat UI in your browser"
    write !, ""
    return $$$OK
]]></Implementation>
</Method>

<Method name="CheckPrerequisites">
<Description>Check that IRIS HealthConnect / Ensemble is available.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    // Check Ensemble/HealthConnect is installed
    if '##class(%Dictionary.CompiledClass).%ExistsId("Ens.Director") {
        return $$$ERROR($$$GeneralError, "Ensemble/HealthConnect not available. The AIAgent platform requires IRIS HealthConnect or IRIS with Ensemble installed.")
    }
    // Check we have production capabilities
    if '##class(%Dictionary.CompiledClass).%ExistsId("Ens.Config.Production") {
        return $$$ERROR($$$GeneralError, "Production configuration classes not available")
    }
    // Check HL7 support
    if '##class(%Dictionary.CompiledClass).%ExistsId("EnsLib.HL7.Message") {
        write !, "  WARNING: EnsLib.HL7.Message not found — HL7 features will be limited"
    }
    return $$$OK
]]></Implementation>
</Method>

<Method name="CreateWebApplication">
<Description>Create the /ai web application mapping to AIAgent.API.Dispatcher.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        // Check if web app already exists
        set exists = ##class(Security.Applications).Exists(..#WEBAPP, .app)
        if exists {
            write !, "  Web application ", ..#WEBAPP, " already exists — updating..."
        }

        // Build properties array
        set props("Name") = ..#WEBAPP
        set props("NameSpace") = $namespace
        set props("Description") = "IRIS AI Agent Platform (IRIS Copilot)"
        set props("Enabled") = 1
        set props("AutheEnabled") = 32  // Password authentication
        set props("DispatchClass") = "AIAgent.API.Dispatcher"
        set props("MatchRoles") = ":%All"
        set props("CookiePath") = ..#WEBAPP
        set props("CSPZENEnabled") = 1
        set props("InbndWebServicesEnabled") = 1

        if exists {
            set sc = ##class(Security.Applications).Modify(..#WEBAPP, .props)
        } else {
            set sc = ##class(Security.Applications).Create(..#WEBAPP, .props)
        }

        if $$$ISERR(sc) {
            // Try a simpler approach if Security.Applications isn't available
            write !, "  Note: Could not auto-create web application."
            write !, "  Please create manually in Management Portal:"
            write !, "    System Administration > Security > Applications > Web Applications"
            write !, "    Path: ", ..#WEBAPP
            write !, "    Dispatch Class: AIAgent.API.Dispatcher"
            write !, "    Namespace: ", $namespace
            set sc = $$$OK  // Don't fail installation for this
        }
    } catch ex {
        // Security.Applications may not be accessible from this namespace
        write !, "  Note: Auto-creation requires %SYS namespace access."
        write !, "  Please create the web application manually (see instructions above)."
        set sc = $$$OK
    }
    return sc
]]></Implementation>
</Method>

<Method name="InitializeData">
<Description>Initialize data globals and verify storage.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    try {
        // Ensure log global exists
        if '$data(^AIAgent.Log) { set ^AIAgent.Log = 0 }

        // Verify persistent class storage
        set classes = $listbuild(
            "AIAgent.Model.Conversation",
            "AIAgent.Model.Message",
            "AIAgent.Model.Generation",
            "AIAgent.Model.GenerationClass",
            "AIAgent.Model.Version",
            "AIAgent.Model.AuditEntry"
        )
        for i = 1:1:$listlength(classes) {
            set cls = $listget(classes, i)
            if ##class(%Dictionary.CompiledClass).%ExistsId(cls) {
                write !, "  OK — ", cls
            } else {
                write !, "  MISSING — ", cls, " (needs compilation)"
            }
        }

        // Log the installation
        do ##class(AIAgent.Util.Logger).Info("Installer", "Installation completed", $namespace)
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="VerifyCompilation">
<Description>Verify all AIAgent classes are compiled.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    set sql = "SELECT Name FROM %Dictionary.ClassDefinition WHERE Name LIKE 'AIAgent.%' ORDER BY Name"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute()
    set total = 0
    set compiled = 0
    while rs.%Next() {
        set className = rs.%GetData(1)
        set total = total + 1
        if ##class(%Dictionary.CompiledClass).%ExistsId(className) {
            set compiled = compiled + 1
        } else {
            write !, "  NOT COMPILED: ", className
            // Attempt to compile
            try {
                do $system.OBJ.Compile(className, "ck")
                set compiled = compiled + 1
            } catch {}
        }
    }
    write !, "  ", compiled, "/", total, " classes compiled"
    if compiled < total {
        set sc = $$$ERROR($$$GeneralError, (total - compiled) _ " classes not compiled")
    }
    return sc
]]></Implementation>
</Method>

<Method name="Configure">
<Description>Configure AI API keys and bridge URL.
Keys are stored encrypted in IRIS configuration.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>bridgeUrl:%String=&quot;http://localhost:3100&quot;,anthropicKey:%String=&quot;&quot;,openaiKey:%String=&quot;&quot;,azureEndpoint:%String=&quot;&quot;,azureKey:%String=&quot;&quot;</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    write !, "Configuring IRIS Copilot..."
    try {
        // Store settings using Ens.Config.DefaultSettings
        // These are accessible from the Management Portal
        if bridgeUrl '= "" {
            set ^AIAgent.Config("BridgeURL") = bridgeUrl
            write !, "  Bridge URL: ", bridgeUrl
        }
        if anthropicKey '= "" {
            // Obfuscate for display, store full key
            set ^AIAgent.Config("AnthropicKey") = anthropicKey
            write !, "  Anthropic API Key: ", $extract(anthropicKey, 1, 10), "..."
        }
        if openaiKey '= "" {
            set ^AIAgent.Config("OpenAIKey") = openaiKey
            write !, "  OpenAI API Key: ", $extract(openaiKey, 1, 10), "..."
        }
        if azureEndpoint '= "" {
            set ^AIAgent.Config("AzureEndpoint") = azureEndpoint
            write !, "  Azure Endpoint: ", azureEndpoint
        }
        if azureKey '= "" {
            set ^AIAgent.Config("AzureKey") = azureKey
            write !, "  Azure Key: ", $extract(azureKey, 1, 10), "..."
        }
        write !, ""
        write !, "Configuration saved. Restart the Node.js bridge to pick up changes."
    } catch ex {
        set sc = ex.AsStatus()
        write !, "ERROR: ", ex.DisplayString()
    }
    return sc
]]></Implementation>
</Method>

<Method name="GetConfig">
<Description>Get a configuration value.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key:%String,default:%String=&quot;&quot;</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    return $get(^AIAgent.Config(key), default)
]]></Implementation>
</Method>

<Method name="Uninstall">
<Description>Uninstall the AIAgent platform.
Removes web application, classes, and data.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>keepData:%Boolean=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    write !, "================================================================"
    write !, "  Uninstalling IRIS AI Agent Platform"
    write !, "================================================================"
    write !

    // Step 1: Remove web application
    write !, "[1/3] Removing web application..."
    try {
        if ##class(Security.Applications).Exists(..#WEBAPP) {
            do ##class(Security.Applications).Delete(..#WEBAPP)
            write !, "  Removed ", ..#WEBAPP
        } else {
            write !, "  Web application not found (already removed)"
        }
    } catch {
        write !, "  Could not auto-remove — please delete manually from Management Portal"
    }

    // Step 2: Remove data (if requested)
    if 'keepData {
        write !, ""
        write !, "[2/3] Removing data..."
        kill ^AIAgent.ConversationD, ^AIAgent.ConversationI, ^AIAgent.ConversationS
        kill ^AIAgent.MessageD, ^AIAgent.MessageI, ^AIAgent.MessageS
        kill ^AIAgent.GenerationD, ^AIAgent.GenerationI, ^AIAgent.GenerationS
        kill ^AIAgent.GenerationClassD, ^AIAgent.GenerationClassI, ^AIAgent.GenerationClassS
        kill ^AIAgent.VersionD, ^AIAgent.VersionI, ^AIAgent.VersionS
        kill ^AIAgent.AuditEntryD, ^AIAgent.AuditEntryI, ^AIAgent.AuditEntryS
        kill ^AIAgent.Log
        kill ^AIAgent.Config
        write !, "  Data globals removed"
    } else {
        write !, ""
        write !, "[2/3] Keeping data (keepData=1)"
    }

    // Step 3: Remove classes
    write !, ""
    write !, "[3/3] Removing classes..."
    do $system.OBJ.DeletePackage("AIAgent")
    write !, "  Package AIAgent removed"

    write !, ""
    write !, "================================================================"
    write !, "  Uninstall complete"
    write !, "================================================================"
    write !

    return sc
]]></Implementation>
</Method>

<Method name="ExportPackage">
<Description>Export the entire AIAgent package to a directory for deployment to another IRIS instance.
Creates a self-contained export that can be imported with ImportPackage().</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>directory:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    write !, "Exporting AIAgent package to: ", directory
    try {
        // Create directory
        if '##class(%File).DirectoryExists(directory) {
            do ##class(%File).CreateDirectoryChain(directory)
        }

        // Export all classes individually
        do $system.OBJ.ExportAllClassesIndividual(directory, "/diffexport=1", "", "", "AIAgent")
        write !, "  Classes exported"

        // Export lookup tables (if any AI-generated ones exist)
        set sql = "SELECT DISTINCT TableName FROM Ens_Util.LookupTable WHERE TableName LIKE 'AIAgent%' OR TableName LIKE 'Pharm%'"
        set stmt = ##class(%SQL.Statement).%New()
        do stmt.%Prepare(sql)
        set rs = stmt.%Execute()
        while rs.%Next() {
            set tableName = rs.%GetData(1)
            do ##class(Ens.Util.LookupTable).%Export(directory _ "/" _ tableName _ ".lut.xml", tableName)
            write !, "  Exported lookup table: ", tableName
        }

        write !, ""
        write !, "Export complete. To import on another IRIS instance:"
        write !, "  set sc = $system.OBJ.LoadDir(""", directory, """, ""ck"")"
        write !, "  do ##class(AIAgent.Install.Installer).Run()"
    } catch ex {
        set sc = ex.AsStatus()
        write !, "ERROR: ", ex.DisplayString()
    }
    return sc
]]></Implementation>
</Method>

<Method name="ImportPackage">
<Description>Import the AIAgent package from a directory.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>directory:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set sc = $$$OK
    write !, "Importing AIAgent package from: ", directory
    try {
        set sc = $system.OBJ.LoadDir(directory, "ck/multicompile=0")
        if $$$ISOK(sc) {
            write !, "  Classes imported and compiled"
            // Run installation
            set sc = ..Run()
        } else {
            write !, "  ERROR: ", $system.Status.GetOneErrorText(sc)
        }
    } catch ex {
        set sc = ex.AsStatus()
    }
    return sc
]]></Implementation>
</Method>

<Method name="Status">
<Description>Print current configuration and system status.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    write !, "================================================================"
    write !, "  IRIS AI Agent Platform — Status"
    write !, "================================================================"
    write !

    // Namespace
    write !, "  Namespace:      ", $namespace

    // Web Application
    try {
        set exists = ##class(Security.Applications).Exists(..#WEBAPP)
        write !, "  Web App (/ai):  ", $select(exists:"Configured", 1:"NOT CONFIGURED")
    } catch {
        write !, "  Web App (/ai):  Unknown (check Management Portal)"
    }

    // Bridge
    set bridgeUrl = ..GetConfig("BridgeURL", "http://localhost:3100")
    write !, "  Bridge URL:     ", bridgeUrl
    set health = ##class(AIAgent.Engine.BridgeClient).HealthCheck()
    write !, "  Bridge Status:  ", $select(health.healthy:"Healthy", 1:"NOT REACHABLE — "_$select(health.error'="":health.error, 1:"Connection failed"))

    // Production
    set prodStatus = ##class(AIAgent.Engine.ProductionManager).GetStatus()
    write !, "  Production:     ", prodStatus.productionName, " (", prodStatus.statusText, ")"

    // API Keys
    write !, "  Anthropic Key:  ", $select(..GetConfig("AnthropicKey")'="":"Configured", 1:"NOT SET")
    write !, "  OpenAI Key:     ", $select(..GetConfig("OpenAIKey")'="":"Configured", 1:"NOT SET")
    write !, "  Azure Endpoint: ", $select(..GetConfig("AzureEndpoint")'="":"Configured", 1:"NOT SET")

    // Data counts
    &sql(SELECT COUNT(*) INTO :convCount FROM AIAgent_Model.Conversation)
    &sql(SELECT COUNT(*) INTO :msgCount FROM AIAgent_Model.Message)
    &sql(SELECT COUNT(*) INTO :genCount FROM AIAgent_Model.Generation)
    &sql(SELECT COUNT(*) INTO :verCount FROM AIAgent_Model.Version)
    &sql(SELECT COUNT(*) INTO :auditCount FROM AIAgent_Model.AuditEntry)
    write !, ""
    write !, "  Conversations:  ", +$get(convCount, 0)
    write !, "  Messages:       ", +$get(msgCount, 0)
    write !, "  Generations:    ", +$get(genCount, 0)
    write !, "  Versions:       ", +$get(verCount, 0)
    write !, "  Audit Entries:  ", +$get(auditCount, 0)

    // Class count
    set classCount = 0
    set sql = "SELECT COUNT(*) FROM %Dictionary.ClassDefinition WHERE Name LIKE 'AIAgent.%'"
    set stmt = ##class(%SQL.Statement).%New()
    do stmt.%Prepare(sql)
    set rs = stmt.%Execute()
    if rs.%Next() { set classCount = rs.%GetData(1) }
    write !, "  AIAgent Classes: ", classCount
    write !, ""

    return $$$OK
]]></Implementation>
</Method>

</Class>

</Export>