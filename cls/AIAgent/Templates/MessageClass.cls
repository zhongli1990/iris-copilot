/// Template generator for persistent Message classes (Request/Response).
/// Produces compilable ObjectScript for custom message objects used between production hosts.
/// 
/// Part of the IRIS AI Agent Platform (IRIS Copilot).
Class AIAgent.Templates.MessageClass Extends %RegisteredObject
{

/// Generate a persistent Request message class.
/// <p>Parameters:</p>
/// <ul>
/// <li>className - Fully qualified class name</li>
/// <li>description - Human-readable purpose</li>
/// <li>properties - $ListBuild of "name:type:maxlen:description" specs
///     (e.g., "PatientMRN:%String:64:Patient MRN from PID:3.1")</li>
/// </ul>
ClassMethod GenerateRequest(className As %String, description As %String, properties As %List = "") As %String
{
    quit ..GenerateMessage(className, description, "Ens.Request", properties)
}

/// Generate a persistent Response message class.
ClassMethod GenerateResponse(className As %String, description As %String, properties As %List = "") As %String
{
    quit ..GenerateMessage(className, description, "Ens.Response", properties)
}

/// Generate a persistent message class (base for Request and Response).
ClassMethod GenerateMessage(className As %String, description As %String, superClass As %String, properties As %List = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends " _ superClass _ nl
    set source = source _ "{" _ nl _ nl

    // Generate properties
    set propCount = $ll(properties)
    for i = 1:1:propCount {
        set propSpec = $lg(properties, i)
        set propName = $p(propSpec, ":", 1)
        set propType = $p(propSpec, ":", 2)
        set propMaxLen = $p(propSpec, ":", 3)
        set propDesc = $p(propSpec, ":", 4, 999)

        if propName = "" continue
        if propType = "" set propType = "%String"
        if propMaxLen = "" set propMaxLen = "256"

        if propDesc '= "" {
            set source = source _ "/// " _ propDesc _ nl
        }

        // Build type with parameters
        if propType = "%String" {
            set source = source _ "Property " _ propName _ " As %String(MAXLEN = " _ propMaxLen _ ");" _ nl _ nl
        } elseif propType = "%Stream.GlobalCharacter" {
            set source = source _ "Property " _ propName _ " As %Stream.GlobalCharacter;" _ nl _ nl
        } else {
            set source = source _ "Property " _ propName _ " As " _ propType _ ";" _ nl _ nl
        }
    }

    // If no properties, add example placeholder
    if propCount = 0 {
        set source = source _ "/// Patient MRN" _ nl
        set source = source _ "Property PatientMRN As %String(MAXLEN = 64);" _ nl _ nl
        set source = source _ "/// Patient Name" _ nl
        set source = source _ "Property PatientName As %String(MAXLEN = 256);" _ nl _ nl
    }

    // Storage
    set storageName = $tr(className, ".", "")
    set source = source _ "Storage Default" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<Type>%Storage.Persistent</Type>" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
}

/// Generate a pair of Request/Response classes for a specific use case.
/// Returns a $ListBuild of two items: (requestSource, responseSource).
ClassMethod GeneratePair(baseClassName As %String, description As %String, requestProps As %List = "", responseProps As %List = "") As %List
{
    set reqClass = baseClassName _ "Request"
    set respClass = baseClassName _ "Response"
    set reqSource = ..GenerateRequest(reqClass, description _ " - Request message.", requestProps)
    set respSource = ..GenerateResponse(respClass, description _ " - Response message.", responseProps)
    quit $lb(reqSource, respSource)
}

/// Generate a complex message class with nested objects (for rich data).
ClassMethod GenerateComplex(className As %String, description As %String, superClass As %String = "Ens.Request", sections As %List = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Complex message with structured data sections." _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends " _ superClass _ nl
    set source = source _ "{" _ nl _ nl

    // Timestamp
    set source = source _ "/// Timestamp when this message was created." _ nl
    set source = source _ "Property Timestamp As %TimeStamp [ InitialExpression = {$zdt($h, 3)} ];" _ nl _ nl

    // Source system
    set source = source _ "/// Source system identifier." _ nl
    set source = source _ "Property SourceSystem As %String(MAXLEN = 128);" _ nl _ nl

    // Add sections as stream properties
    set sectionCount = $ll(sections)
    for i = 1:1:sectionCount {
        set sectionName = $lg(sections, i)
        if sectionName '= "" {
            set source = source _ "/// " _ sectionName _ " data section (JSON stream)." _ nl
            set source = source _ "Property " _ sectionName _ " As %Stream.GlobalCharacter;" _ nl _ nl
        }
    }

    // Utility method: set section from dynamic object
    set source = source _ "/// Set a section's data from a %DynamicObject." _ nl
    set source = source _ "Method SetSectionData(sectionName As %String, data As %DynamicObject) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        set tProp = $property($this, sectionName)" _ nl
    set source = source _ "        if '$isobject(tProp) {" _ nl
    set source = source _ "            set tProp = ##class(%Stream.GlobalCharacter).%New()" _ nl
    set source = source _ "            set $property($this, sectionName) = tProp" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "        do tProp.Clear()" _ nl
    set source = source _ "        do tProp.Write(data.%ToJSON())" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    // Storage
    set source = source _ "Storage Default" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<Type>%Storage.Persistent</Type>" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
}

}
