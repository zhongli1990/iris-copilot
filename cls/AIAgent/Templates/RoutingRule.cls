/// Template generator for Business Routing Rule classes.
/// Produces compilable ObjectScript rule definitions used by EnsLib.HL7.MsgRouter.RoutingEngine.
/// 
/// Part of the IRIS AI Agent Platform (IRIS Copilot).
Class AIAgent.Templates.RoutingRule Extends %RegisteredObject
{

/// Generate a routing rule class with message-type-based routing.
/// <p>Parameters:</p>
/// <ul>
/// <li>className - Fully qualified class name</li>
/// <li>description - Human-readable purpose</li>
/// <li>rules - $ListBuild of rule specs, each formatted as "condition|target|transform|enabled"
///     where condition is an HL7 expression (e.g., "HL7.{MSH:9.1}=""ADT"""),
///     target is the business host name, transform is DTL class (or ""), enabled is "1"/"0"</li>
/// </ul>
ClassMethod Generate(className As %String, description As %String, rules As %List = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.Rule.Definition" _ nl
    set source = source _ "{" _ nl _ nl

    // XData RuleDefinition
    set source = source _ "XData RuleDefinition [ XMLNamespace = ""http://www.intersystems.com/rule"" ]" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<ruleDefinition>" _ nl
    set source = source _ "<ruleset>" _ nl _ nl

    // Generate rules
    set ruleCount = $ll(rules)
    if ruleCount > 0 {
        for i = 1:1:ruleCount {
            set ruleSpec = $lg(rules, i)
            set condition = $p(ruleSpec, "|", 1)
            set target = $p(ruleSpec, "|", 2)
            set transform = $p(ruleSpec, "|", 3)
            set enabled = $p(ruleSpec, "|", 4)
            if enabled = "" set enabled = "1"

            set source = source _ "  <rule name='Rule" _ i _ "' disabled='" _ $s(enabled="1":"false",1:"true") _ "'>" _ nl

            // Condition (when clause)
            if condition '= "" {
                set source = source _ "    <when condition='" _ $zcvt(condition, "O", "XML") _ "'>" _ nl
            } else {
                set source = source _ "    <when condition='1'>" _ nl
            }

            // Send action
            if transform '= "" {
                set source = source _ "      <send transform='" _ transform _ "' target='" _ target _ "' />" _ nl
            } else {
                set source = source _ "      <send target='" _ target _ "' />" _ nl
            }

            set source = source _ "    </when>" _ nl
            set source = source _ "  </rule>" _ nl _ nl
        }
    } else {
        // Generate example rules
        set source = source _ "  <!-- Example: Route ADT messages -->" _ nl
        set source = source _ "  <rule name='RouteADT'>" _ nl
        set source = source _ "    <when condition='HL7.{MSH:9.1}=""ADT""'>" _ nl
        set source = source _ "      <send target='TargetOperationName' />" _ nl
        set source = source _ "    </when>" _ nl
        set source = source _ "  </rule>" _ nl _ nl
        set source = source _ "  <!-- Example: Route ORM messages with transform -->" _ nl
        set source = source _ "  <rule name='RouteORM'>" _ nl
        set source = source _ "    <when condition='HL7.{MSH:9.1}=""ORM""'>" _ nl
        set source = source _ "      <send transform='My.DTL.Transform' target='TargetOperationName' />" _ nl
        set source = source _ "    </when>" _ nl
        set source = source _ "  </rule>" _ nl _ nl
    }

    set source = source _ "</ruleset>" _ nl
    set source = source _ "</ruleDefinition>" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
}

/// Generate a routing rule with common Bradford TIE patterns.
/// Pre-fills rules for ADT, ORM, ORU, RDE message type routing.
ClassMethod GenerateBradfordStandard(className As %String, description As %String, adtTarget As %String = "", ormTarget As %String = "", oruTarget As %String = "", rdeTarget As %String = "") As %String
{
    set rules = ""

    if adtTarget '= "" {
        set rules = rules _ $lb("HL7.{MSH:9.1}=""ADT""|" _ adtTarget _ "||1")
    }
    if ormTarget '= "" {
        set rules = rules _ $lb("HL7.{MSH:9.1}=""ORM""|" _ ormTarget _ "||1")
    }
    if oruTarget '= "" {
        set rules = rules _ $lb("HL7.{MSH:9.1}=""ORU""|" _ oruTarget _ "||1")
    }
    if rdeTarget '= "" {
        set rules = rules _ $lb("HL7.{MSH:9.1}=""RDE""|" _ rdeTarget _ "||1")
    }

    quit ..Generate(className, description, rules)
}

/// Generate a content-based routing rule that checks specific HL7 field values.
/// Useful for routing based on patient location, ordering facility, etc.
ClassMethod GenerateContentBased(className As %String, description As %String, fieldPath As %String, valueTargetPairs As %List) As %String
{
    set rules = ""
    set pairCount = $ll(valueTargetPairs)

    for i = 1:1:pairCount {
        set pair = $lg(valueTargetPairs, i)
        set value = $p(pair, "=", 1)
        set target = $p(pair, "=", 2)
        if (value '= "") && (target '= "") {
            set condition = "HL7.{" _ fieldPath _ "}=""" _ value _ """"
            set rules = rules _ $lb(condition _ "|" _ target _ "||1")
        }
    }

    quit ..Generate(className, description, rules)
}

}
