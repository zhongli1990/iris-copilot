/// Template generator for Data Transformation (DTL) classes.
/// Produces compilable ObjectScript DTL XML definitions for HL7 message transformations.
/// 
/// Part of the IRIS AI Agent Platform (IRIS Copilot).
Class AIAgent.Templates.DataTransformation Extends %RegisteredObject
{

/// Generate an HL7-to-HL7 DTL transformation class.
/// <p>Parameters:</p>
/// <ul>
/// <li>className - Fully qualified class name</li>
/// <li>description - Human-readable purpose</li>
/// <li>sourceDocType - Source HL7 DocType (e.g., "2.4:ADT_A01")</li>
/// <li>targetDocType - Target HL7 DocType (e.g., "2.4:ADT_A01")</li>
/// <li>fieldMappings - $ListBuild of "sourceField=targetField" pairs (e.g., "PID:3.1=PID:3.1")</li>
/// <li>setValues - $ListBuild of "field=value" pairs for hardcoded values (e.g., "MSH:3.1=IRIS")</li>
/// </ul>
ClassMethod GenerateHL7(className As %String, description As %String, sourceDocType As %String = "2.4:ADT_A01", targetDocType As %String = "2.4:ADT_A01", fieldMappings As %List = "", setValues As %List = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.DataTransformDTL [ DependsOn = (EnsLib.HL7.Message) ]" _ nl
    set source = source _ "{" _ nl _ nl

    // Parameters
    set source = source _ "Parameter IGNOREMISSINGSOURCE = 1;" _ nl
    set source = source _ "Parameter REPORTERRORS = 1;" _ nl
    set source = source _ "Parameter TREATEMPTYREPEATINGFIELDASNULL = 0;" _ nl _ nl

    // XData DTL block
    set source = source _ "XData DTL [ XMLNamespace = ""http://www.intersystems.com/dtl"" ]" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<transform sourceClass='EnsLib.HL7.Message' targetClass='EnsLib.HL7.Message'"
    set source = source _ " sourceDocType='" _ sourceDocType _ "' targetDocType='" _ targetDocType _ "'"
    set source = source _ " create='copy' language='objectscript'>" _ nl _ nl

    // Comment
    set source = source _ "  <!-- " _ description _ " -->" _ nl _ nl

    // Field mappings (source -> target)
    set mapCount = $ll(fieldMappings)
    if mapCount > 0 {
        set source = source _ "  <!-- Field Mappings -->" _ nl
        for i = 1:1:mapCount {
            set mapping = $lg(fieldMappings, i)
            set srcField = $p(mapping, "=", 1)
            set tgtField = $p(mapping, "=", 2)
            if (srcField '= "") && (tgtField '= "") {
                set source = source _ "  <assign value='source.{" _ srcField _ "}' property='target.{" _ tgtField _ "}' action='set' />" _ nl
            }
        }
        set source = source _ nl
    }

    // Hardcoded set values
    set setCount = $ll(setValues)
    if setCount > 0 {
        set source = source _ "  <!-- Static Values -->" _ nl
        for i = 1:1:setCount {
            set setValue = $lg(setValues, i)
            set field = $p(setValue, "=", 1)
            set value = $p(setValue, "=", 2, 999)
            if (field '= "") && (value '= "") {
                set source = source _ "  <assign value='""" _ value _ """' property='target.{" _ field _ "}' action='set' />" _ nl
            }
        }
        set source = source _ nl
    }

    // If no mappings, add copy-all comment
    if (mapCount = 0) && (setCount = 0) {
        set source = source _ "  <!-- Using create='copy' â€” all segments are copied from source to target -->" _ nl
        set source = source _ "  <!-- Add specific field overrides below -->" _ nl _ nl
        set source = source _ "  <!-- Example: set target MSH:3 (Sending Application) -->" _ nl
        set source = source _ "  <!-- <assign value='""IRIS""' property='target.{MSH:3.1}' action='set' /> -->" _ nl _ nl
    }

    set source = source _ "</transform>" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
}

/// Generate an HL7-to-Object DTL (e.g., HL7 -> FHIR or custom class).
ClassMethod GenerateHL7ToObject(className As %String, description As %String, sourceDocType As %String = "2.4:ADT_A01", targetClass As %String = "Ens.Request", fieldMappings As %List = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.DataTransformDTL [ DependsOn = (EnsLib.HL7.Message, " _ targetClass _ ") ]" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter IGNOREMISSINGSOURCE = 1;" _ nl
    set source = source _ "Parameter REPORTERRORS = 1;" _ nl _ nl

    set source = source _ "XData DTL [ XMLNamespace = ""http://www.intersystems.com/dtl"" ]" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<transform sourceClass='EnsLib.HL7.Message' targetClass='" _ targetClass _ "'"
    set source = source _ " sourceDocType='" _ sourceDocType _ "'"
    set source = source _ " create='new' language='objectscript'>" _ nl _ nl

    // Field mappings
    set mapCount = $ll(fieldMappings)
    if mapCount > 0 {
        for i = 1:1:mapCount {
            set mapping = $lg(fieldMappings, i)
            set srcField = $p(mapping, "=", 1)
            set tgtProp = $p(mapping, "=", 2)
            if (srcField '= "") && (tgtProp '= "") {
                set source = source _ "  <assign value='source.{" _ srcField _ "}' property='target." _ tgtProp _ "' action='set' />" _ nl
            }
        }
    } else {
        set source = source _ "  <!-- Map HL7 fields to object properties -->" _ nl
        set source = source _ "  <!-- <assign value='source.{PID:3.1}' property='target.MRN' action='set' /> -->" _ nl
    }

    set source = source _ nl _ "</transform>" _ nl
    set source = source _ "}" _ nl _ nl
    set source = source _ "}" _ nl

    quit source
}

/// Generate a code-based (non-DTL) transformation class.
/// Use when transformation logic is too complex for DTL XML (lookups, conditionals, loops).
ClassMethod GenerateCodeTransform(className As %String, description As %String, sourceType As %String = "EnsLib.HL7.Message", targetType As %String = "EnsLib.HL7.Message") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Code-based transformation (non-DTL) for complex logic." _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.DataTransform" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "ClassMethod Transform(source As " _ sourceType _ ", ByRef target As " _ targetType _ ") As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        // Create target as copy of source" _ nl
    set source = source _ "        set target = source.%ConstructClone()" _ nl _ nl
    set source = source _ "        // --- Add transformation logic here ---" _ nl _ nl
    set source = source _ "        // Example: Update sending application" _ nl
    set source = source _ "        // do target.SetValueAt(""IRIS"", ""MSH:3.1"")" _ nl _ nl
    set source = source _ "        // Example: Lookup table reference" _ nl
    set source = source _ "        // set mappedValue = ##class(Ens.Util.FunctionSet).Lookup(""MyTable"", source.GetValueAt(""PID:3.1""), """")" _ nl _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "        $$$LOGERROR(""Transform error: "" _ ex.DisplayString())" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl

    quit source
}

}
