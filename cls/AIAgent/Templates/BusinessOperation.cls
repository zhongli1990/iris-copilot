/// Template generator for Business Operation classes.
/// Produces compilable ObjectScript for outbound HL7 TCP, HTTP, file, and email operations.
/// 
/// Part of the IRIS AI Agent Platform (IRIS Copilot).
Class AIAgent.Templates.BusinessOperation Extends %RegisteredObject
{

/// Generate an HL7 TCP outbound Business Operation.
/// Sends HL7 messages to downstream systems over TCP.
ClassMethod GenerateTCP(className As %String, description As %String, ipAddress As %String, port As %Integer, hl7Schema As %String = "2.4") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessOperation" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HL7.Adapter.TCPOutboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""IPAddress:Basic,Port:Basic,MessageSchemaCategory:Basic,ReconnectRetry:Connection"";" _ nl _ nl
    set source = source _ "Parameter INVOCATION = ""Queue"";" _ nl _ nl

    set source = source _ "Property IPAddress As %String(MAXLEN = 256) [ InitialExpression = """ _ ipAddress _ """ ];" _ nl _ nl
    set source = source _ "Property Port As %Integer [ InitialExpression = " _ port _ " ];" _ nl _ nl
    set source = source _ "Property MessageSchemaCategory As %String [ InitialExpression = """ _ hl7Schema _ """ ];" _ nl _ nl
    set source = source _ "Property ReconnectRetry As %Integer [ InitialExpression = 5 ];" _ nl _ nl

    // OnInit
    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.IPAddress = ..IPAddress" _ nl
    set source = source _ "    set ..Adapter.Port = ..Port" _ nl
    set source = source _ "    set ..Adapter.MessageSchemaCategory = ..MessageSchemaCategory" _ nl
    set source = source _ "    set ..Adapter.ReconnectRetry = ..ReconnectRetry" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    // MessageMap
    set source = source _ "XData MessageMap" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<MapItems>" _ nl
    set source = source _ "  <MapItem MessageType=""EnsLib.HL7.Message"">" _ nl
    set source = source _ "    <Method>SendHL7Message</Method>" _ nl
    set source = source _ "  </MapItem>" _ nl
    set source = source _ "</MapItems>" _ nl
    set source = source _ "}" _ nl _ nl

    // Send method
    set source = source _ "/// Send HL7 message via TCP adapter." _ nl
    set source = source _ "Method SendHL7Message(pRequest As EnsLib.HL7.Message, Output pResponse As EnsLib.HL7.Message) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        $$$LOGINFO(""Sending "" _ pRequest.GetValueAt(""MSH:9"") _ "" to "" _ ..IPAddress _ "":"" _ ..Port)" _ nl
    set source = source _ "        set tSC = ..Adapter.SendMessageSync(pRequest, .pResponse)" _ nl
    set source = source _ "        if $$$ISERR(tSC) {" _ nl
    set source = source _ "            $$$LOGERROR(""TCP send failed: "" _ $system.Status.GetErrorText(tSC))" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "        $$$LOGERROR(""Exception: "" _ ex.DisplayString())" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
}

/// Generate an HTTP outbound Business Operation.
/// Sends data to REST APIs or web services.
ClassMethod GenerateHTTP(className As %String, description As %String, httpServer As %String, httpPort As %Integer = 443, urlPath As %String = "/api", sslConfig As %String = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessOperation" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HTTP.OutboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""HTTPServer:Basic,HTTPPort:Basic,URL:Basic,SSLConfig:Connection"";" _ nl _ nl
    set source = source _ "Parameter INVOCATION = ""Queue"";" _ nl _ nl

    set source = source _ "Property HTTPServer As %String(MAXLEN = 256) [ InitialExpression = """ _ httpServer _ """ ];" _ nl _ nl
    set source = source _ "Property HTTPPort As %Integer [ InitialExpression = " _ httpPort _ " ];" _ nl _ nl
    set source = source _ "Property URL As %String(MAXLEN = 1024) [ InitialExpression = """ _ urlPath _ """ ];" _ nl _ nl
    if sslConfig '= "" {
        set source = source _ "Property SSLConfig As %String [ InitialExpression = """ _ sslConfig _ """ ];" _ nl _ nl
    }

    // OnInit
    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.HTTPServer = ..HTTPServer" _ nl
    set source = source _ "    set ..Adapter.HTTPPort = ..HTTPPort" _ nl
    set source = source _ "    set ..Adapter.URL = ..URL" _ nl
    if sslConfig '= "" {
        set source = source _ "    set ..Adapter.SSLConfig = ..SSLConfig" _ nl
    }
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    // MessageMap
    set source = source _ "XData MessageMap" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<MapItems>" _ nl
    set source = source _ "  <MapItem MessageType=""Ens.StreamContainer"">" _ nl
    set source = source _ "    <Method>SendHTTPRequest</Method>" _ nl
    set source = source _ "  </MapItem>" _ nl
    set source = source _ "</MapItems>" _ nl
    set source = source _ "}" _ nl _ nl

    // Send method
    set source = source _ "/// Send HTTP POST request." _ nl
    set source = source _ "Method SendHTTPRequest(pRequest As Ens.StreamContainer, Output pResponse As %Net.HttpResponse) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        set tHttpRequest = ##class(%Net.HttpRequest).%New()" _ nl
    set source = source _ "        set tHttpRequest.ContentType = ""application/json""" _ nl
    set source = source _ "        do tHttpRequest.EntityBody.CopyFrom(pRequest.Stream)" _ nl
    set source = source _ "        set tSC = ..Adapter.SendFormDataArray(.tHttpResponse, ""POST"", tHttpRequest)" _ nl
    set source = source _ "        if $$$ISERR(tSC) {" _ nl
    set source = source _ "            $$$LOGERROR(""HTTP send failed: "" _ $system.Status.GetErrorText(tSC))" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "        set pResponse = tHttpResponse" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
}

/// Generate a File outbound Business Operation.
/// Writes messages or data to files in a directory.
ClassMethod GenerateFile(className As %String, description As %String, filePath As %String, fileExtension As %String = ".hl7") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessOperation" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HL7.Adapter.FileOutboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""FilePath:Basic,FileExtension:Basic"";" _ nl _ nl
    set source = source _ "Parameter INVOCATION = ""Queue"";" _ nl _ nl

    set source = source _ "Property FilePath As %String(MAXLEN = 1024) [ InitialExpression = """ _ filePath _ """ ];" _ nl _ nl
    set source = source _ "Property FileExtension As %String [ InitialExpression = """ _ fileExtension _ """ ];" _ nl _ nl

    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.FilePath = ..FilePath" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    // MessageMap
    set source = source _ "XData MessageMap" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<MapItems>" _ nl
    set source = source _ "  <MapItem MessageType=""EnsLib.HL7.Message"">" _ nl
    set source = source _ "    <Method>WriteHL7ToFile</Method>" _ nl
    set source = source _ "  </MapItem>" _ nl
    set source = source _ "</MapItems>" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "Method WriteHL7ToFile(pRequest As EnsLib.HL7.Message, Output pResponse As Ens.Response) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        set tFilename = $tr($zdt($h,3),"" :"",""-"") _ ""_"" _ pRequest.GetValueAt(""MSH:9.1"") _ ..FileExtension" _ nl
    set source = source _ "        $$$LOGINFO(""Writing to file: "" _ tFilename)" _ nl
    set source = source _ "        set tSC = ..Adapter.PutLine(..FilePath _ ""/"" _ tFilename, pRequest.OutputToString())" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
}

/// Generate an Email notification Business Operation.
/// Sends email alerts via SMTP.
ClassMethod GenerateEmail(className As %String, description As %String, smtpServer As %String, fromAddress As %String) As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessOperation" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.EMail.OutboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""SMTPServer:Basic,From:Basic,SSLConfig:Connection"";" _ nl _ nl
    set source = source _ "Parameter INVOCATION = ""Queue"";" _ nl _ nl

    set source = source _ "Property SMTPServer As %String(MAXLEN = 256) [ InitialExpression = """ _ smtpServer _ """ ];" _ nl _ nl
    set source = source _ "Property From As %String(MAXLEN = 256) [ InitialExpression = """ _ fromAddress _ """ ];" _ nl _ nl

    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.SMTPServer = ..SMTPServer" _ nl
    set source = source _ "    set ..Adapter.From = ..From" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "XData MessageMap" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<MapItems>" _ nl
    set source = source _ "  <MapItem MessageType=""Ens.AlertRequest"">" _ nl
    set source = source _ "    <Method>SendAlert</Method>" _ nl
    set source = source _ "  </MapItem>" _ nl
    set source = source _ "</MapItems>" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "/// Send alert email notification." _ nl
    set source = source _ "Method SendAlert(pRequest As Ens.AlertRequest, Output pResponse As Ens.Response) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        set tMailMsg = ##class(%Net.MailMessage).%New()" _ nl
    set source = source _ "        set tMailMsg.From = ..From" _ nl
    set source = source _ "        set tMailMsg.Subject = ""IRIS Alert: "" _ pRequest.AlertText" _ nl
    set source = source _ "        set tMailMsg.IsHTML = 0" _ nl
    set source = source _ "        do tMailMsg.TextData.Write(""Alert from: "" _ pRequest.SourceConfigName _ $c(13,10))" _ nl
    set source = source _ "        do tMailMsg.TextData.Write(""Time: "" _ $zdt($h, 3) _ $c(13,10))" _ nl
    set source = source _ "        do tMailMsg.TextData.Write(""Details: "" _ pRequest.AlertText)" _ nl
    set source = source _ "        set tSC = ..Adapter.SendMail(tMailMsg)" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl
    quit source
}

}
