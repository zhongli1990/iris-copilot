/// Template generator for HL7 TCP Business Service classes.
/// Produces compilable ObjectScript for receiving HL7 messages over TCP.
/// 
/// Part of the IRIS AI Agent Platform (IRIS Copilot).
Class AIAgent.Templates.BusinessService Extends %RegisteredObject
{

/// Generate a complete HL7 TCP Business Service class.
/// <p>Parameters:</p>
/// <ul>
/// <li>className - Fully qualified class name (e.g., AIAgent.Generated.Pharmacy.Service.RxReceiver)</li>
/// <li>description - Human-readable purpose of this service</li>
/// <li>port - TCP listener port number</li>
/// <li>targetProcess - Business host name to route messages to</li>
/// <li>hl7Schema - HL7 schema category (e.g., "2.4", "CERNER2.3")</li>
/// <li>ackMode - ACK mode: "Application", "Immediate", or "Never" (default "Application")</li>
/// </ul>
ClassMethod Generate(className As %String, description As %String, port As %Integer, targetProcess As %String, hl7Schema As %String = "2.4", ackMode As %String = "Application") As %String
{
    set source = ""
    set $p(className,".",1) = $p(className,".",1)  // validate
    set nl = $c(13,10)

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessService" _ nl
    set source = source _ "{" _ nl _ nl

    // Parameters
    set source = source _ "Parameter ADAPTER = ""EnsLib.HL7.Adapter.TCPInboundAdapter"";" _ nl _ nl

    // SETTINGS
    set source = source _ "/// Configurable settings exposed in the Management Portal." _ nl
    set source = source _ "Parameter SETTINGS = ""TargetConfigName:Basic,Port:Basic,MessageSchemaCategory:Basic,AckMode:Basic"";" _ nl _ nl

    // Properties
    set source = source _ "/// Target business process or router to send messages to." _ nl
    set source = source _ "Property TargetConfigName As %String(MAXLEN = 256) [ InitialExpression = """ _ targetProcess _ """ ];" _ nl _ nl
    set source = source _ "/// TCP port to listen on." _ nl
    set source = source _ "Property Port As %Integer [ InitialExpression = " _ port _ " ];" _ nl _ nl
    set source = source _ "/// HL7 schema category for parsing." _ nl
    set source = source _ "Property MessageSchemaCategory As %String(MAXLEN = 128) [ InitialExpression = """ _ hl7Schema _ """ ];" _ nl _ nl
    set source = source _ "/// ACK mode: Application, Immediate, or Never." _ nl
    set source = source _ "Property AckMode As %String [ InitialExpression = """ _ ackMode _ """ ];" _ nl _ nl

    // OnInit
    set source = source _ "/// Configure the TCP adapter on startup." _ nl
    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.Port = ..Port" _ nl
    set source = source _ "    set ..Adapter.MessageSchemaCategory = ..MessageSchemaCategory" _ nl
    set source = source _ "    set ..Adapter.AckMode = ..AckMode" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    // OnProcessInput
    set source = source _ "/// Process each inbound HL7 message." _ nl
    set source = source _ "Method OnProcessInput(pInput As EnsLib.HL7.Message, Output pOutput As EnsLib.HL7.Message) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        $$$LOGINFO(""Received HL7 message: "" _ pInput.GetValueAt(""MSH:9.1"") _ ""^"" _ pInput.GetValueAt(""MSH:9.2""))" _ nl
    set source = source _ "        " _ nl
    set source = source _ "        // Route to target process/router" _ nl
    set source = source _ "        set tSC = ..SendRequestSync(..TargetConfigName, pInput, .pOutput)" _ nl
    set source = source _ "        if $$$ISERR(tSC) {" _ nl
    set source = source _ "            $$$LOGERROR(""Failed to send to "" _ ..TargetConfigName _ "": "" _ $system.Status.GetErrorText(tSC))" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "        $$$LOGERROR(""Exception in OnProcessInput: "" _ ex.DisplayString())" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
}

/// Generate an HTTP-based Business Service for REST inbound.
ClassMethod GenerateHTTP(className As %String, description As %String, targetProcess As %String, contentType As %String = "application/json") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessService" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HTTP.InboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""TargetConfigName:Basic,Port:Basic"";" _ nl _ nl

    set source = source _ "Property TargetConfigName As %String(MAXLEN = 256) [ InitialExpression = """ _ targetProcess _ """ ];" _ nl _ nl

    set source = source _ "Method OnProcessInput(pInput As %Stream.Object, Output pOutput As %Stream.Object) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        // Create request from HTTP body" _ nl
    set source = source _ "        set tRequest = ##class(Ens.StreamContainer).%New(pInput)" _ nl
    set source = source _ "        set tSC = ..SendRequestSync(..TargetConfigName, tRequest, .tResponse)" _ nl
    set source = source _ "        if $$$ISERR(tSC) {" _ nl
    set source = source _ "            $$$LOGERROR(""Send failed: "" _ $system.Status.GetErrorText(tSC))" _ nl
    set source = source _ "        }" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl
    set source = source _ "}" _ nl

    quit source
}

/// Generate a File-based Business Service for reading files from a directory.
ClassMethod GenerateFile(className As %String, description As %String, targetProcess As %String, filePath As %String, fileSpec As %String = "*.hl7") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessService" _ nl
    set source = source _ "{" _ nl _ nl

    set source = source _ "Parameter ADAPTER = ""EnsLib.HL7.Adapter.FileInboundAdapter"";" _ nl _ nl
    set source = source _ "Parameter SETTINGS = ""TargetConfigName:Basic,FilePath:Basic,FileSpec:Basic"";" _ nl _ nl

    set source = source _ "Property TargetConfigName As %String(MAXLEN = 256) [ InitialExpression = """ _ targetProcess _ """ ];" _ nl _ nl
    set source = source _ "Property FilePath As %String(MAXLEN = 1024) [ InitialExpression = """ _ filePath _ """ ];" _ nl _ nl
    set source = source _ "Property FileSpec As %String(MAXLEN = 128) [ InitialExpression = """ _ fileSpec _ """ ];" _ nl _ nl

    set source = source _ "Method OnInit() As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set ..Adapter.FilePath = ..FilePath" _ nl
    set source = source _ "    set ..Adapter.FileSpec = ..FileSpec" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "Method OnProcessInput(pInput As EnsLib.HL7.Message, Output pOutput As EnsLib.HL7.Message) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        $$$LOGINFO(""Processing file HL7: "" _ pInput.GetValueAt(""MSH:9""))" _ nl
    set source = source _ "        set tSC = ..SendRequestSync(..TargetConfigName, pInput, .pOutput)" _ nl
    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl
    set source = source _ "}" _ nl

    quit source
}

}
