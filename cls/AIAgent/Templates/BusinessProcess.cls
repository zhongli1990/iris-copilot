/// Template generator for Business Process classes (BPL and code-based).
/// Produces compilable ObjectScript for message routing and orchestration.
/// 
/// Part of the IRIS AI Agent Platform (IRIS Copilot).
Class AIAgent.Templates.BusinessProcess Extends %RegisteredObject
{

/// Generate a BPL (Business Process Language) process class.
/// BPL processes are XML-defined workflows ideal for routing, transformation, and orchestration.
/// <p>Parameters:</p>
/// <ul>
/// <li>className - Fully qualified class name</li>
/// <li>description - Human-readable purpose</li>
/// <li>requestType - Input message class (e.g., "EnsLib.HL7.Message")</li>
/// <li>responseType - Output message class (e.g., "EnsLib.HL7.Message")</li>
/// <li>targets - $ListBuild of target business host names to route to</li>
/// <li>transformNames - $ListBuild of DTL transform class names (parallel to targets, "" for no transform)</li>
/// </ul>
ClassMethod GenerateBPL(className As %String, description As %String, requestType As %String = "EnsLib.HL7.Message", responseType As %String = "EnsLib.HL7.Message", targets As %List = "", transformNames As %List = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    // Class header
    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessProcessBPL" _ nl
    set source = source _ "{" _ nl _ nl

    // XData BPL block
    set source = source _ "XData BPL [ XMLNamespace = ""http://www.intersystems.com/bpl"" ]" _ nl
    set source = source _ "{" _ nl
    set source = source _ "<process language='objectscript' request='" _ requestType _ "' response='" _ responseType _ "'>" _ nl
    set source = source _ "<context>" _ nl
    set source = source _ "  <property name='ErrorCount' type='%Integer' initialexpression='0' />" _ nl
    set source = source _ "</context>" _ nl
    set source = source _ "<sequence>" _ nl _ nl

    // Trace entry
    set source = source _ "  <trace value='""Process started: "" _ request.GetValueAt(""MSH:9"")' />" _ nl _ nl

    // Generate a call+transform for each target
    set targetCount = $ll(targets)
    for i = 1:1:targetCount {
        set target = $lg(targets, i)
        set transform = $lg(transformNames, i)
        if target = "" continue

        if transform '= "" {
            // Transform then send
            set source = source _ "  <!-- Transform and send to " _ target _ " -->" _ nl
            set source = source _ "  <transform class='" _ transform _ "' source='request' target='request' />" _ nl
        }
        set source = source _ "  <call name='" _ target _ "' target='" _ target _ "' async='1'>" _ nl
        set source = source _ "    <request type='" _ requestType _ "' actions='set callrequest=request' />" _ nl
        set source = source _ "    <response type='" _ responseType _ "' actions='set response=callresponse' />" _ nl
        set source = source _ "  </call>" _ nl _ nl
    }

    // If no targets were provided, generate a placeholder
    if targetCount = 0 {
        set source = source _ "  <!-- TODO: Add routing targets -->" _ nl
        set source = source _ "  <trace value='""No targets configured â€” message will not be forwarded""' />" _ nl _ nl
    }

    set source = source _ "  <trace value='""Process complete""' />" _ nl
    set source = source _ "</sequence>" _ nl
    set source = source _ "</process>" _ nl
    set source = source _ "}" _ nl _ nl

    // Close class
    set source = source _ "}" _ nl

    quit source
}

/// Generate a code-based Business Process (non-BPL) with OnRequest/OnResponse.
/// Use this when the process logic is too complex for BPL (loops, dynamic routing, etc.).
ClassMethod GenerateCode(className As %String, description As %String, requestType As %String = "EnsLib.HL7.Message", responseType As %String = "EnsLib.HL7.Message", targets As %List = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "/// " _ description _ nl
    set source = source _ "/// Generated by IRIS Copilot AI Agent Platform." _ nl
    set source = source _ "Class " _ className _ " Extends Ens.BusinessProcess" _ nl
    set source = source _ "{" _ nl _ nl

    // SETTINGS for target config names
    set targetCount = $ll(targets)
    set settingsList = ""
    for i = 1:1:targetCount {
        set target = $lg(targets, i)
        if target = "" continue
        set prop = "Target" _ i
        set source = source _ "Property " _ prop _ " As %String(MAXLEN = 256) [ InitialExpression = """ _ target _ """ ];" _ nl
        set settingsList = settingsList _ $s(settingsList'="":",",1:"") _ prop _ ":Basic"
    }
    if settingsList '= "" {
        set source = source _ nl _ "Parameter SETTINGS = """ _ settingsList _ """;" _ nl
    }
    set source = source _ nl

    // OnRequest
    set source = source _ "/// Handle inbound request." _ nl
    set source = source _ "Method OnRequest(pRequest As " _ requestType _ ", Output pResponse As " _ responseType _ ") As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    set tSC = $$$OK" _ nl
    set source = source _ "    try {" _ nl
    set source = source _ "        $$$LOGINFO(""Processing: "" _ pRequest.GetValueAt(""MSH:9.1"") _ ""^"" _ pRequest.GetValueAt(""MSH:9.2""))" _ nl _ nl

    for i = 1:1:targetCount {
        set target = $lg(targets, i)
        if target = "" continue
        set prop = "Target" _ i
        set source = source _ "        // Send to " _ target _ nl
        set source = source _ "        set tSC = ..SendRequestAsync(.." _ prop _ ", pRequest)" _ nl
        set source = source _ "        if $$$ISERR(tSC) {" _ nl
        set source = source _ "            $$$LOGERROR(""Send to " _ target _ " failed: "" _ $system.Status.GetErrorText(tSC))" _ nl
        set source = source _ "        }" _ nl _ nl
    }

    set source = source _ "    } catch ex {" _ nl
    set source = source _ "        set tSC = ex.AsStatus()" _ nl
    set source = source _ "        $$$LOGERROR(""Exception: "" _ ex.DisplayString())" _ nl
    set source = source _ "    }" _ nl
    set source = source _ "    quit tSC" _ nl
    set source = source _ "}" _ nl _ nl

    // OnResponse
    set source = source _ "/// Handle responses from downstream operations." _ nl
    set source = source _ "Method OnResponse(pRequest As %Library.Persistent, ByRef pResponse As %Library.Persistent, pCallRequest As %Library.Persistent, pCallResponse As %Library.Persistent, pCompletionKey As %String) As %Status" _ nl
    set source = source _ "{" _ nl
    set source = source _ "    quit $$$OK" _ nl
    set source = source _ "}" _ nl _ nl

    set source = source _ "}" _ nl

    quit source
}

/// Generate an HL7 Message Router (uses EnsLib.HL7.MsgRouter.RoutingEngine).
/// This doesn't generate a class but rather the production configuration for a router.
ClassMethod GenerateRouterConfig(routerName As %String, description As %String, schemaCategory As %String = "2.4", ruleClass As %String = "") As %String
{
    set nl = $c(13,10)
    set source = ""

    set source = source _ "// Production host configuration for HL7 Router: " _ routerName _ nl
    set source = source _ "// " _ description _ nl
    set source = source _ "//" _ nl
    set source = source _ "// Add to production via Management Portal or Ens.Director:" _ nl
    set source = source _ "//" _ nl
    set source = source _ "// Class: EnsLib.HL7.MsgRouter.RoutingEngine" _ nl
    set source = source _ "// Name: " _ routerName _ nl
    set source = source _ "// Settings:" _ nl
    set source = source _ "//   BusinessRuleName = " _ ruleClass _ nl
    set source = source _ "//   MessageSchemaCategory = " _ schemaCategory _ nl
    set source = source _ "//   BadMessageHandler = (optional error handler)" _ nl
    set source = source _ "//   Validation = (optional validation level)" _ nl

    quit source
}

}
