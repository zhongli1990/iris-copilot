/// Template Factory: unified entry point for all COS template generators.
/// The AI orchestrator calls this class to generate structurally correct ObjectScript
/// scaffolding for any component type. AI fills in the business logic; templates ensure
/// the class structure is always valid and compilable.
/// 
/// Part of the IRIS AI Agent Platform (IRIS Copilot).
Class AIAgent.Templates.Factory Extends %RegisteredObject
{

/// Generate a COS class from a template, based on component type.
/// <p>Parameters:</p>
/// <ul>
/// <li>componentType - One of: BusinessService, BusinessProcess, BusinessOperation,
///     DataTransformation, RoutingRule, RequestMessage, ResponseMessage</li>
/// <li>spec - %DynamicObject with component-specific parameters.
///     Common fields: className, description.
///     Type-specific fields vary (see individual template classes).</li>
/// </ul>
/// Returns the generated ObjectScript source as a string.
ClassMethod Generate(componentType As %String, spec As %DynamicObject) As %String
{
    set className = spec.className
    set description = spec.%Get("description", "Generated by IRIS Copilot")

    if componentType = "BusinessService" {
        // Determine adapter type
        set adapterType = spec.%Get("adapterType", "TCP")
        if adapterType = "HTTP" {
            quit ##class(AIAgent.Templates.BusinessService).GenerateHTTP(
                className, description,
                spec.%Get("targetProcess", ""))
        }
        elseif adapterType = "File" {
            quit ##class(AIAgent.Templates.BusinessService).GenerateFile(
                className, description,
                spec.%Get("targetProcess", ""),
                spec.%Get("filePath", ""),
                spec.%Get("fileSpec", "*.hl7"))
        }
        else {
            // Default: TCP HL7
            quit ##class(AIAgent.Templates.BusinessService).Generate(
                className, description,
                +spec.%Get("port", 0),
                spec.%Get("targetProcess", ""),
                spec.%Get("hl7Schema", "2.4"),
                spec.%Get("ackMode", "Application"))
        }
    }

    if componentType = "BusinessProcess" {
        set processType = spec.%Get("processType", "BPL")
        // Convert targets JSON array to $ListBuild
        set targets = ..JSONArrayToList(spec.%Get("targets"))
        set transforms = ..JSONArrayToList(spec.%Get("transforms"))
        if processType = "Code" {
            quit ##class(AIAgent.Templates.BusinessProcess).GenerateCode(
                className, description,
                spec.%Get("requestType", "EnsLib.HL7.Message"),
                spec.%Get("responseType", "EnsLib.HL7.Message"),
                targets)
        }
        else {
            quit ##class(AIAgent.Templates.BusinessProcess).GenerateBPL(
                className, description,
                spec.%Get("requestType", "EnsLib.HL7.Message"),
                spec.%Get("responseType", "EnsLib.HL7.Message"),
                targets, transforms)
        }
    }

    if componentType = "BusinessOperation" {
        set adapterType = spec.%Get("adapterType", "TCP")
        if adapterType = "HTTP" {
            quit ##class(AIAgent.Templates.BusinessOperation).GenerateHTTP(
                className, description,
                spec.%Get("httpServer", ""),
                +spec.%Get("httpPort", 443),
                spec.%Get("urlPath", "/api"),
                spec.%Get("sslConfig", ""))
        }
        elseif adapterType = "File" {
            quit ##class(AIAgent.Templates.BusinessOperation).GenerateFile(
                className, description,
                spec.%Get("filePath", ""),
                spec.%Get("fileExtension", ".hl7"))
        }
        elseif adapterType = "Email" {
            quit ##class(AIAgent.Templates.BusinessOperation).GenerateEmail(
                className, description,
                spec.%Get("smtpServer", ""),
                spec.%Get("fromAddress", ""))
        }
        else {
            quit ##class(AIAgent.Templates.BusinessOperation).GenerateTCP(
                className, description,
                spec.%Get("ipAddress", ""),
                +spec.%Get("port", 0),
                spec.%Get("hl7Schema", "2.4"))
        }
    }

    if componentType = "DataTransformation" {
        set dtlType = spec.%Get("dtlType", "HL7")
        set fieldMappings = ..JSONArrayToList(spec.%Get("fieldMappings"))
        if dtlType = "HL7ToObject" {
            quit ##class(AIAgent.Templates.DataTransformation).GenerateHL7ToObject(
                className, description,
                spec.%Get("sourceDocType", "2.4:ADT_A01"),
                spec.%Get("targetClass", "Ens.Request"),
                fieldMappings)
        }
        elseif dtlType = "Code" {
            quit ##class(AIAgent.Templates.DataTransformation).GenerateCodeTransform(
                className, description,
                spec.%Get("sourceType", "EnsLib.HL7.Message"),
                spec.%Get("targetType", "EnsLib.HL7.Message"))
        }
        else {
            set setValues = ..JSONArrayToList(spec.%Get("setValues"))
            quit ##class(AIAgent.Templates.DataTransformation).GenerateHL7(
                className, description,
                spec.%Get("sourceDocType", "2.4:ADT_A01"),
                spec.%Get("targetDocType", "2.4:ADT_A01"),
                fieldMappings, setValues)
        }
    }

    if componentType = "RoutingRule" {
        set rules = ..JSONArrayToList(spec.%Get("rules"))
        if rules '= "" {
            quit ##class(AIAgent.Templates.RoutingRule).Generate(className, description, rules)
        }
        // Try Bradford standard pattern
        quit ##class(AIAgent.Templates.RoutingRule).GenerateBradfordStandard(
            className, description,
            spec.%Get("adtTarget", ""),
            spec.%Get("ormTarget", ""),
            spec.%Get("oruTarget", ""),
            spec.%Get("rdeTarget", ""))
    }

    if componentType = "RequestMessage" {
        set properties = ..JSONArrayToList(spec.%Get("properties"))
        quit ##class(AIAgent.Templates.MessageClass).GenerateRequest(className, description, properties)
    }

    if componentType = "ResponseMessage" {
        set properties = ..JSONArrayToList(spec.%Get("properties"))
        quit ##class(AIAgent.Templates.MessageClass).GenerateResponse(className, description, properties)
    }

    // Unknown type â€” return error comment
    quit "// ERROR: Unknown component type: " _ componentType _ $c(13,10) _ "// Supported types: BusinessService, BusinessProcess, BusinessOperation, DataTransformation, RoutingRule, RequestMessage, ResponseMessage"
}

/// List all supported component types and their parameters.
ClassMethod ListComponentTypes() As %DynamicArray
{
    set types = []
    do types.%Push(..TypeInfo("BusinessService", "Inbound HL7/HTTP/File listener", "port,targetProcess,hl7Schema,ackMode,adapterType(TCP|HTTP|File),filePath,fileSpec"))
    do types.%Push(..TypeInfo("BusinessProcess", "Message orchestration (BPL or code)", "processType(BPL|Code),requestType,responseType,targets[],transforms[]"))
    do types.%Push(..TypeInfo("BusinessOperation", "Outbound TCP/HTTP/File/Email sender", "adapterType(TCP|HTTP|File|Email),ipAddress,port,hl7Schema,httpServer,httpPort,urlPath,sslConfig,filePath,smtpServer,fromAddress"))
    do types.%Push(..TypeInfo("DataTransformation", "HL7 field mapping (DTL or code)", "dtlType(HL7|HL7ToObject|Code),sourceDocType,targetDocType,fieldMappings[],setValues[],targetClass"))
    do types.%Push(..TypeInfo("RoutingRule", "Message routing rules", "rules[](condition|target|transform|enabled),adtTarget,ormTarget,oruTarget,rdeTarget"))
    do types.%Push(..TypeInfo("RequestMessage", "Persistent request message class", "properties[](name:type:maxlen:description)"))
    do types.%Push(..TypeInfo("ResponseMessage", "Persistent response message class", "properties[](name:type:maxlen:description)"))
    quit types
}

/// Helper: build a type info object.
ClassMethod TypeInfo(name As %String, description As %String, parameters As %String) As %DynamicObject [ Private ]
{
    set info = {}
    set info.name = name
    set info.description = description
    set info.parameters = parameters
    quit info
}

/// Helper: convert a %DynamicArray to a $ListBuild.
ClassMethod JSONArrayToList(arr As %DynamicArray) As %List [ Private ]
{
    if '$isobject(arr) quit ""
    set list = ""
    set iter = arr.%GetIterator()
    while iter.%GetNext(.key, .value) {
        set list = list _ $lb(value)
    }
    quit list
}

}
